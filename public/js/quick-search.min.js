class QuickSearch{constructor(){this.searchModal=null,this.searchInput=null,this.resultsContainer=null,this.searchTimeout=null,this.currentIndex=-1,this.results=[],this.init()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}init(){this.createSearchModal(),this.bindKeyboardShortcuts(),this.bindEvents()}createSearchModal(){document.body.insertAdjacentHTML("beforeend",'\n            <div class="modal fade" id="quickSearchModal" tabindex="-1" aria-labelledby="quickSearchLabel" aria-hidden="true">\n                <div class="modal-dialog modal-lg modal-dialog-centered">\n                    <div class="modal-content border-0 shadow-lg">\n                        <div class="modal-header border-0 pb-0">\n                            <div class="w-100">\n                                <div class="input-group input-group-lg">\n                                    <span class="input-group-text bg-transparent border-0">\n                                        <i class="fas fa-search text-muted"></i>\n                                    </span>\n                                    <input type="text" \n                                           class="form-control border-0 shadow-none" \n                                           id="quickSearchInput" \n                                           placeholder="Поиск задач, пользователей, проектов..."\n                                           autocomplete="off">\n                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="modal-body pt-2">\n                            <div id="quickSearchResults" class="quick-search-results">\n                                <div class="text-center text-muted py-5">\n                                    <i class="fas fa-search fa-3x mb-3 opacity-25"></i>\n                                    <p>Начните вводить для поиска...</p>\n                                    <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">\n                                        <kbd>↑↓</kbd> навигация\n                                        <kbd>Enter</kbd> открыть\n                                        <kbd>Esc</kbd> закрыть\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="modal-footer border-0 pt-0">\n                            <small class="text-muted">\n                                <kbd>Ctrl</kbd> + <kbd>K</kbd> для быстрого поиска\n                            </small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '),this.searchModal=new bootstrap.Modal(document.getElementById("quickSearchModal")),this.searchInput=document.getElementById("quickSearchInput"),this.resultsContainer=document.getElementById("quickSearchResults")}bindKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),this.open()),"/"!==e.key||["INPUT","TEXTAREA"].includes(e.target.tagName)||(e.preventDefault(),this.open())})}bindEvents(){this.searchInput.addEventListener("input",e=>{clearTimeout(this.searchTimeout);const t=e.target.value.trim();t.length<2?this.showEmptyState():this.searchTimeout=setTimeout(()=>{this.performSearch(t)},300)}),this.searchInput.addEventListener("keydown",e=>{switch(e.key){case"ArrowDown":e.preventDefault(),this.navigateResults(1);break;case"ArrowUp":e.preventDefault(),this.navigateResults(-1);break;case"Enter":e.preventDefault(),this.selectResult();break;case"Escape":this.close()}}),document.getElementById("quickSearchModal").addEventListener("hidden.bs.modal",()=>{this.searchInput.value="",this.showEmptyState(),this.currentIndex=-1}),document.getElementById("quickSearchModal").addEventListener("shown.bs.modal",()=>{this.searchInput.focus()})}async performSearch(e){this.showLoading();try{const t=await fetch(`/search/api/quick?q=${encodeURIComponent(e)}`),n=await t.json();this.results=n.results||[],this.displayResults(this.results,e)}catch(e){console.error("Search error:",e),this.showError()}}displayResults(e,t){if(0===e.length)return void this.showNoResults(t);const n=this.groupResults(e);let s="";for(const[e,t]of Object.entries(n))s+=`\n                <div class="result-group mb-3">\n                    <div class="result-group-header">\n                        <i class="fas ${this.getTypeIcon(e)} me-2"></i>\n                        ${this.getTypeLabel(e)}\n                        <span class="badge bg-secondary ms-2">${t.length}</span>\n                    </div>\n                    <div class="result-group-items">\n                        ${t.map((e,t)=>this.renderResultItem(e,t)).join("")}\n                    </div>\n                </div>\n            `;this.resultsContainer.innerHTML=s,this.bindResultClicks()}renderResultItem(e,t){const n=this.highlightMatch(e.title,this.searchInput.value),s=e.description?this.highlightMatch(e.description,this.searchInput.value):"",r=this.escapeHtml(e.url),i=e.meta?this.escapeHtml(e.meta):"";return`\n            <div class="result-item" data-index="${t}" data-url="${r}">\n                <div class="result-item-icon">\n                    <i class="fas ${this.getTypeIcon(e.type)}"></i>\n                </div>\n                <div class="result-item-content">\n                    <div class="result-item-title">${n}</div>\n                    ${s?`<div class="result-item-description">${s}</div>`:""}\n                    <div class="result-item-meta">\n                        ${i}\n                    </div>\n                </div>\n                <div class="result-item-action">\n                    <i class="fas fa-arrow-right"></i>\n                </div>\n            </div>\n        `}groupResults(e){return e.reduce((e,t)=>{const n=t.type||"other";return e[n]||(e[n]=[]),e[n].push(t),e},{})}getTypeIcon(e){const t={task:"fa-tasks",user:"fa-user",project:"fa-folder",comment:"fa-comment",category:"fa-tag",other:"fa-file"};return t[e]||t.other}getTypeLabel(e){const t={task:"Задачи",user:"Пользователи",project:"Проекты",comment:"Комментарии",category:"Категории",other:"Другое"};return t[e]||t.other}highlightMatch(e,t){if(!t)return this.escapeHtml(e);const n=this.escapeHtml(e),s=this.escapeHtml(t),r=new RegExp(`(${this.escapeRegex(s)})`,"gi");return n.replace(r,"<mark>$1</mark>")}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}bindResultClicks(){this.resultsContainer.querySelectorAll(".result-item").forEach((e,t)=>{e.addEventListener("click",()=>{this.currentIndex=t,this.selectResult()}),e.addEventListener("mouseenter",()=>{this.currentIndex=t,this.updateActiveResult()})})}navigateResults(e){const t=this.resultsContainer.querySelectorAll(".result-item");0!==t.length&&(this.currentIndex+=e,this.currentIndex<0?this.currentIndex=t.length-1:this.currentIndex>=t.length&&(this.currentIndex=0),this.updateActiveResult())}updateActiveResult(){this.resultsContainer.querySelectorAll(".result-item").forEach((e,t)=>{t===this.currentIndex?(e.classList.add("active"),e.scrollIntoView({block:"nearest",behavior:"smooth"})):e.classList.remove("active")})}selectResult(){const e=this.resultsContainer.querySelectorAll(".result-item");if(this.currentIndex>=0&&this.currentIndex<e.length){const t=e[this.currentIndex].dataset.url;t&&(window.location.href=t)}}showLoading(){this.resultsContainer.innerHTML='\n            <div class="text-center py-5">\n                <div class="spinner-border text-primary" role="status">\n                    <span class="visually-hidden">Загрузка...</span>\n                </div>\n                <p class="mt-3 text-muted">Поиск...</p>\n            </div>\n        '}showEmptyState(){this.resultsContainer.innerHTML='\n            <div class="text-center text-muted py-5">\n                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>\n                <p>Начните вводить для поиска...</p>\n                <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">\n                    <kbd>↑↓</kbd> навигация\n                    <kbd>Enter</kbd> открыть\n                    <kbd>Esc</kbd> закрыть\n                </div>\n            </div>\n        '}showNoResults(e){this.resultsContainer.innerHTML=`\n            <div class="text-center py-5">\n                <i class="fas fa-search-minus fa-3x mb-3 text-muted"></i>\n                <h5>Ничего не найдено</h5>\n                <p class="text-muted">По запросу "${e}" результатов не найдено</p>\n            </div>\n        `}showError(){this.resultsContainer.innerHTML='\n            <div class="text-center py-5">\n                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>\n                <h5>Ошибка поиска</h5>\n                <p class="text-muted">Попробуйте еще раз</p>\n            </div>\n        '}open(){this.searchModal.show()}close(){this.searchModal.hide()}}const quickSearchStyles="\n<style>\n.quick-search-results {\n    max-height: 60vh;\n    overflow-y: auto;\n}\n\n.result-group {\n    margin-bottom: 1.5rem;\n}\n\n.result-group-header {\n    font-weight: 600;\n    font-size: 0.875rem;\n    text-transform: uppercase;\n    color: #6c757d;\n    padding: 0.5rem 1rem;\n    background: #f8f9fa;\n    border-radius: 6px;\n    margin-bottom: 0.5rem;\n}\n\n.result-group-items {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n}\n\n.result-item {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    padding: 1rem;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    border: 1px solid transparent;\n}\n\n.result-item:hover,\n.result-item.active {\n    background: #f8f9fa;\n    border-color: #667eea;\n    transform: translateX(4px);\n}\n\n.result-item-icon {\n    width: 40px;\n    height: 40px;\n    border-radius: 8px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-shrink: 0;\n}\n\n.result-item-content {\n    flex: 1;\n    min-width: 0;\n}\n\n.result-item-title {\n    font-weight: 600;\n    margin-bottom: 0.25rem;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n.result-item-description {\n    font-size: 0.875rem;\n    color: #6c757d;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n.result-item-meta {\n    font-size: 0.75rem;\n    color: #adb5bd;\n    margin-top: 0.25rem;\n}\n\n.result-item-action {\n    color: #adb5bd;\n    flex-shrink: 0;\n}\n\n.result-item:hover .result-item-action,\n.result-item.active .result-item-action {\n    color: #667eea;\n}\n\nmark {\n    background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 152, 0, 0.3) 100%);\n    padding: 2px 4px;\n    border-radius: 3px;\n    font-weight: 600;\n}\n\nkbd {\n    background: #f8f9fa;\n    border: 1px solid #dee2e6;\n    border-radius: 4px;\n    padding: 2px 6px;\n    font-size: 0.75rem;\n    font-family: monospace;\n}\n</style>\n";document.head.insertAdjacentHTML("beforeend",quickSearchStyles),document.addEventListener("DOMContentLoaded",()=>{window.quickSearch=new QuickSearch});