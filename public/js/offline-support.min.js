class OfflineSupport{constructor(){this.isOnline=navigator.onLine,this.queue=this.loadQueue(),this.syncInProgress=!1,this.init()}init(){this.setupEventListeners(),this.addOfflineIndicatorStyles(),this.startPeriodicSync()}setupEventListeners(){window.addEventListener("online",()=>{this.handleOnline()}),window.addEventListener("offline",()=>{this.handleOffline()}),document.addEventListener("submit",e=>{!this.isOnline&&e.target.matches("[data-offline-support]")&&(e.preventDefault(),this.queueFormSubmission(e.target))}),this.interceptFetch()}createOfflineIndicator(){if(document.getElementById("offline-indicator"))return;const e=document.createElement("div");e.id="offline-indicator",e.className="offline-indicator show",e.innerHTML='\n            <div class="offline-indicator-content">\n                <i class="fas fa-wifi-slash"></i>\n                <span>Нет связи</span>\n            </div>\n            <button class="btn btn-sm btn-light" id="retry-connection" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">\n                <i class="fas fa-sync-alt"></i>\n            </button>\n        ',document.body.appendChild(e),document.getElementById("retry-connection").addEventListener("click",()=>{this.checkConnection()})}addOfflineIndicatorStyles(){if(document.getElementById("offlineIndicatorStyles"))return;const e=document.createElement("style");e.id="offlineIndicatorStyles",e.textContent="\n            .offline-indicator {\n                position: fixed;\n                top: 70px;\n                right: 20px;\n                background: #f59e0b;\n                color: white;\n                padding: 0.5rem 0.875rem;\n                border-radius: 6px;\n                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n                z-index: 1050;\n                display: none;\n                font-size: 0.875rem;\n                max-width: 280px;\n                flex-direction: row;\n                align-items: center;\n                gap: 0.75rem;\n                animation: slideIn 0.3s ease-out;\n            }\n\n            .offline-indicator.show {\n                display: flex;\n            }\n\n            @keyframes slideIn {\n                from {\n                    opacity: 0;\n                    transform: translateX(100px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateX(0);\n                }\n            }\n\n            .offline-indicator-content {\n                display: flex;\n                align-items: center;\n                font-weight: 500;\n                font-size: 0.875rem;\n                flex: 1;\n            }\n\n            .offline-queue-info {\n                font-size: 0.75rem;\n                opacity: 0.9;\n                white-space: nowrap;\n            }\n\n            #queue-count {\n                font-weight: 600;\n            }\n\n            .offline-badge {\n                display: none;\n                box-shadow: var(--shadow);\n                z-index: 1000;\n                display: none;\n            }\n\n            .offline-badge.show {\n                display: block;\n                animation: pulse 2s infinite;\n            }\n\n            @keyframes pulse {\n                0%, 100% {\n                    opacity: 1;\n                }\n                50% {\n                    opacity: 0.7;\n                }\n            }\n        ",document.head.appendChild(e)}handleOnline(){this.isOnline=!0;const e=document.getElementById("offline-indicator");e&&e.classList.remove("show"),this.showToast("Соединение восстановлено","success"),this.queue.length>0&&this.syncQueue()}handleOffline(){this.isOnline=!1,this.createOfflineIndicator()}async checkConnection(){try{(await fetch("/login",{method:"HEAD",cache:"no-cache"})).ok?this.isOnline||this.handleOnline():this.isOnline&&this.handleOffline()}catch(e){this.isOnline&&this.handleOffline()}}queueFormSubmission(e){const n=new FormData(e),t={id:Date.now(),type:"form",url:e.action,method:e.method||"POST",data:Object.fromEntries(n.entries()),timestamp:(new Date).toISOString()};this.queue.push(t),this.saveQueue(),this.updateQueueCount(),this.showToast("Действие добавлено в очередь и будет выполнено при восстановлении соединения","info")}queueRequest(e,n){const t={id:Date.now(),type:"fetch",url:e,method:n.method||"GET",headers:n.headers||{},body:n.body,timestamp:(new Date).toISOString()};this.queue.push(t),this.saveQueue(),this.updateQueueCount()}async syncQueue(){if(this.syncInProgress||0===this.queue.length)return;this.syncInProgress=!0,this.showToast(`Синхронизация ${this.queue.length} действий...`,"info");const e={success:0,failed:0};for(const n of[...this.queue])try{"form"===n.type?await this.syncFormSubmission(n):"fetch"===n.type&&await this.syncFetchRequest(n),this.queue=this.queue.filter(e=>e.id!==n.id),e.success++}catch(n){console.error("Sync error:",n),e.failed++}this.saveQueue(),this.updateQueueCount(),this.syncInProgress=!1,e.success>0&&this.showToast(`Синхронизировано ${e.success} действий`,"success"),e.failed>0&&this.showToast(`Не удалось синхронизировать ${e.failed} действий`,"error")}async syncFormSubmission(e){const n=new FormData;for(const[t,i]of Object.entries(e.data))n.append(t,i);const t=await fetch(e.url,{method:e.method,body:n});if(!t.ok)throw new Error("Form submission failed");return t}async syncFetchRequest(e){const n=await fetch(e.url,{method:e.method,headers:e.headers,body:e.body});if(!n.ok)throw new Error("Fetch request failed");return n}interceptFetch(){const e=window.fetch;window.fetch=async(...n)=>{if(!this.isOnline){const[e,t={}]=n;if(["POST","PUT","PATCH","DELETE"].includes(t.method?.toUpperCase()))return this.queueRequest(e,t),new Response(JSON.stringify({queued:!0}),{status:202,headers:{"Content-Type":"application/json"}})}return e(...n)}}updateQueueCount(){const e=document.getElementById("queue-count");e&&(e.textContent=this.queue.length);const n=document.getElementById("offline-indicator");n&&!this.isOnline&&this.queue.length>0&&n.classList.add("show")}loadQueue(){try{const e=localStorage.getItem("offlineQueue");return e?JSON.parse(e):[]}catch(e){return[]}}saveQueue(){try{localStorage.setItem("offlineQueue",JSON.stringify(this.queue))}catch(e){console.error("Failed to save queue:",e)}}startPeriodicSync(){setInterval(()=>{this.isOnline&&this.queue.length>0&&this.syncQueue()},6e4)}showToast(e,n="info"){"function"==typeof window.showToast&&window.showToast(e,n)}clearQueue(){this.queue=[],this.saveQueue(),this.updateQueueCount()}getStats(){return{isOnline:this.isOnline,queueLength:this.queue.length,oldestItem:this.queue.length>0?this.queue[0].timestamp:null}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.offlineSupport=new OfflineSupport}):window.offlineSupport=new OfflineSupport,window.OfflineSupport=OfflineSupport;