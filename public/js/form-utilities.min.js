!function(){"use strict";const e=new class{constructor(){this.init()}init(){this.setupFormSubmitHandlers(),this.setupDynamicValidation(),this.setupFileUploadPreviews(),this.setupSelectEnhancements()}setupFormSubmitHandlers(){document.querySelectorAll("form[data-async]").forEach(e=>{e.addEventListener("submit",async t=>{t.preventDefault();const i=e.querySelector('button[type="submit"]'),r=i?.innerHTML;i&&(i.disabled=!0,i.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Отправка...');try{const t=new FormData(e),i=await fetch(e.action,{method:e.method||"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}}),r=await i.json();r.success?(window.notify?.success(r.message||"Успешно сохранено"),r.redirect?setTimeout(()=>{window.location.href=r.redirect},1e3):e.reset()):(window.notify?.error(r.message||"Произошла ошибка"),r.errors&&this.displayFormErrors(e,r.errors))}catch(e){console.error("Form submission error:",e),window.notify?.error("Ошибка отправки формы")}finally{i&&(i.disabled=!1,i.innerHTML=r)}})})}displayFormErrors(e,t){e.querySelectorAll(".is-invalid").forEach(e=>{e.classList.remove("is-invalid")}),e.querySelectorAll(".invalid-feedback").forEach(e=>{e.remove()}),Object.keys(t).forEach(i=>{const r=e.querySelector(`[name="${i}"]`);if(r){r.classList.add("is-invalid");const e=document.createElement("div");e.className="invalid-feedback",e.textContent=t[i],r.parentNode.appendChild(e)}})}setupDynamicValidation(){document.querySelectorAll("input[required], textarea[required], select[required]").forEach(e=>{e.addEventListener("blur",()=>{this.validateField(e)}),e.addEventListener("input",()=>{e.classList.contains("is-invalid")&&this.validateField(e)})})}validateField(e){const t=e.value.trim();let i=!0,r="";if(e.hasAttribute("required")&&!t&&(i=!1,r="Это поле обязательно для заполнения"),"email"===e.type&&t&&!this.isValidEmail(t)&&(i=!1,r="Введите корректный email адрес"),e.hasAttribute("minlength")){const s=parseInt(e.getAttribute("minlength"));t.length<s&&(i=!1,r=`Минимальная длина: ${s} символов`)}if(e.hasAttribute("maxlength")){const s=parseInt(e.getAttribute("maxlength"));t.length>s&&(i=!1,r=`Максимальная длина: ${s} символов`)}if(e.hasAttribute("pattern")&&t){new RegExp(e.getAttribute("pattern")).test(t)||(i=!1,r=e.getAttribute("title")||"Неверный формат")}return i?(e.classList.remove("is-invalid"),e.classList.add("is-valid"),this.removeFeedback(e)):(e.classList.remove("is-valid"),e.classList.add("is-invalid"),this.showFeedback(e,r)),i}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}showFeedback(e,t){this.removeFeedback(e);const i=document.createElement("div");i.className="invalid-feedback",i.textContent=t,e.parentNode.appendChild(i)}removeFeedback(e){const t=e.parentNode.querySelector(".invalid-feedback");t&&t.remove()}setupFileUploadPreviews(){document.querySelectorAll('input[type="file"][data-preview]').forEach(e=>{e.addEventListener("change",t=>{const i=t.target.files[0];if(!i)return;const r=e.getAttribute("data-preview"),s=document.getElementById(r);if(s)if(i.type.startsWith("image/")){const e=new FileReader;e.onload=e=>{s.innerHTML=`<img src="${e.target.result}" alt="Preview" style="max-width: 100%; border-radius: 8px;">`},e.readAsDataURL(i)}else s.innerHTML=`\n                            <div class="alert alert-info">\n                                <i class="fas fa-file me-2"></i>\n                                ${i.name} (${this.formatFileSize(i.size)})\n                            </div>\n                        `})})}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}setupSelectEnhancements(){document.querySelectorAll("select[data-search]").forEach(e=>{const t=document.createElement("div");t.className="select-search-wrapper",e.parentNode.insertBefore(t,e),t.appendChild(e);const i=document.createElement("input");i.type="text",i.className="form-control form-control-sm mb-2",i.placeholder="Поиск...",t.insertBefore(i,e),i.addEventListener("input",t=>{const i=t.target.value.toLowerCase();Array.from(e.options).forEach(e=>{const t=e.textContent.toLowerCase();e.style.display=t.includes(i)?"":"none"})})})}serializeForm(e){const t=new FormData(e),i={};for(let[e,r]of t.entries())i[e]?(Array.isArray(i[e])||(i[e]=[i[e]]),i[e].push(r)):i[e]=r;return i}resetForm(e){e.reset(),e.querySelectorAll(".is-valid, .is-invalid").forEach(e=>{e.classList.remove("is-valid","is-invalid")}),e.querySelectorAll(".invalid-feedback, .valid-feedback").forEach(e=>{e.remove()})}};window.FormUtils={validate:t=>e.validateField(t),serialize:t=>e.serializeForm(t),reset:t=>e.resetForm(t),displayErrors:(t,i)=>e.displayFormErrors(t,i)}}();