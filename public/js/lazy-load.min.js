class LazyLoader{constructor(){this.images=[],this.observer=null,this.supportsWebP=this.detectWebP(),this.placeholder="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlNWU3ZWIiLz48L3N2Zz4=",this.init()}detectWebP(){const e=document.createElement("canvas");e.width=e.height=1;try{return 0===e.toDataURL("image/webp").indexOf("data:image/webp")}catch(e){return!1}}init(){"IntersectionObserver"in window?(this.setupObserver(),this.observeImages()):this.loadAllImages()}setupObserver(){this.observer=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;e.intersectionRatio>.1?this.loadImage(t):setTimeout(()=>this.loadImage(t),200),this.observer.unobserve(t)}})},{root:null,rootMargin:"100px",threshold:[0,.01,.1,.5,1]})}observeImages(){this.images=document.querySelectorAll('img[data-src], img[loading="lazy"], picture source[data-srcset]'),this.images.forEach((e,t)=>{e.src||e.currentSrc||(e.src=this.placeholder),e.dataset.src&&(this.supportsWebP&&e.dataset.srcWebp&&(e.dataset.src=e.dataset.srcWebp),this.observer.observe(e)),e.dataset.srcset&&this.setupSrcset(e)}),document.querySelectorAll("picture[data-lazy]").forEach(e=>{this.observePictureElement(e)})}setupSrcset(e){const t=e.dataset.srcset,s=e.dataset.sizes;t&&(this.supportsWebP&&e.dataset.srcsetWebp?e.srcset=e.dataset.srcsetWebp:e.srcset=t,s&&(e.sizes=s))}observePictureElement(e){const t=e.querySelector("img");t&&t.dataset.src&&this.observer.observe(t)}loadImage(e){const t=e.dataset.src;if(!t)return;const s=new Image,a=e.dataset.quality||"80",r=t.includes("?")?"&":"?",o=`${t}${r}q=${a}`;s.onload=()=>{e.width&&e.height&&(e.style.aspectRatio=`${e.width}/${e.height}`),e.src=o,e.classList.add("loaded"),e.classList.remove("loading"),e.removeAttribute("data-src"),e.dispatchEvent(new CustomEvent("imageLoaded",{bubbles:!0}))},s.onerror=()=>{e.classList.add("error"),e.removeAttribute("data-src"),e.dataset.fallback&&(e.src=e.dataset.fallback),console.warn("Failed to load image:",t)},s.src=o}loadAllImages(){this.images.forEach(e=>this.loadImage(e))}observe(e){if(!this.observer)return;(e.querySelectorAll?e.querySelectorAll('img[data-src], img[loading="lazy"]'):e.dataset&&e.dataset.src?[e]:[]).forEach(e=>{e.dataset.src&&!e.src&&this.observer.observe(e)})}destroy(){this.observer&&this.observer.disconnect(),this.images=[]}getStats(){const e=document.querySelectorAll("img");let t=0,s=0,a=0;return e.forEach(e=>{e.classList.contains("loaded")&&t++,e.classList.contains("error")&&a++,(e.dataset.src||"lazy"===e.loading)&&s++}),{total:e.length,loaded:t,lazy:s,error:a}}}document.addEventListener("DOMContentLoaded",function(){window.lazyLoader=new LazyLoader}),window.LazyLoader=LazyLoader,window.getImageStats=()=>window.lazyLoader?window.lazyLoader.getStats():null;