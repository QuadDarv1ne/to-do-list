class AdvancedNotifications{constructor(){this.notifications=[],this.unreadCount=0,this.settings=this.loadSettings(),this.init()}escapeHtml(t){const n=document.createElement("div");return n.textContent=t,n.innerHTML}init(){this.createNotificationCenter(),this.startPolling(),this.bindEvents(),this.requestPermission()}loadSettings(){const t={sound:!0,desktop:!0,email:!1,grouping:!0,pollInterval:3e4},n=localStorage.getItem("notificationSettings");return n?{...t,...JSON.parse(n)}:t}saveSettings(){localStorage.setItem("notificationSettings",JSON.stringify(this.settings))}createNotificationCenter(){if(document.getElementById("notificationCenter"))return;const t=document.createElement("div");t.id="notificationCenter",t.className="notification-center",t.innerHTML='\n            <div class="notification-center-header">\n                <h5 class="mb-0">Уведомления</h5>\n                <div class="notification-center-actions">\n                    <button class="btn btn-sm btn-link" data-action="settings" title="Настройки">\n                        <i class="fas fa-cog"></i>\n                    </button>\n                    <button class="btn btn-sm btn-link" data-action="mark-all-read" title="Отметить все как прочитанные">\n                        <i class="fas fa-check-double"></i>\n                    </button>\n                    <button class="btn btn-sm btn-link" data-action="close" title="Закрыть">\n                        <i class="fas fa-times"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="notification-center-tabs">\n                <button class="tab-btn active" data-tab="all">Все <span class="badge" data-count="all">0</span></button>\n                <button class="tab-btn" data-tab="unread">Непрочитанные <span class="badge" data-count="unread">0</span></button>\n                <button class="tab-btn" data-tab="mentions">Упоминания <span class="badge" data-count="mentions">0</span></button>\n            </div>\n            <div class="notification-center-content">\n                <div class="notification-list" data-list="all"></div>\n                <div class="notification-list" data-list="unread" style="display: none;"></div>\n                <div class="notification-list" data-list="mentions" style="display: none;"></div>\n            </div>\n            <div class="notification-center-footer">\n                <a href="/notifications" class="btn btn-sm btn-link">Все уведомления</a>\n            </div>\n        ',document.body.appendChild(t),this.addStyles()}addStyles(){if(document.getElementById("notificationCenterStyles"))return;const t=document.createElement("style");t.id="notificationCenterStyles",t.textContent="\n            .notification-center {\n                position: fixed;\n                top: 60px;\n                right: 20px;\n                width: 400px;\n                max-height: 600px;\n                background: var(--bg-card);\n                border: 1px solid var(--border);\n                border-radius: var(--radius-lg);\n                box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                display: none;\n                flex-direction: column;\n                z-index: 1050;\n                animation: slideIn 0.3s ease-out;\n            }\n\n            .notification-center.show {\n                display: flex;\n            }\n\n            @keyframes slideIn {\n                from {\n                    opacity: 0;\n                    transform: translateY(-20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            .notification-center-header {\n                padding: 1rem;\n                border-bottom: 1px solid var(--border);\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n\n            .notification-center-actions {\n                display: flex;\n                gap: 0.5rem;\n            }\n\n            .notification-center-tabs {\n                display: flex;\n                border-bottom: 1px solid var(--border);\n                padding: 0 1rem;\n            }\n\n            .notification-center-tabs .tab-btn {\n                flex: 1;\n                padding: 0.75rem 1rem;\n                border: none;\n                background: none;\n                color: var(--text-secondary);\n                cursor: pointer;\n                border-bottom: 2px solid transparent;\n                transition: all 0.2s ease;\n            }\n\n            .notification-center-tabs .tab-btn:hover {\n                color: var(--text-primary);\n            }\n\n            .notification-center-tabs .tab-btn.active {\n                color: var(--primary);\n                border-bottom-color: var(--primary);\n            }\n\n            .notification-center-tabs .badge {\n                background: var(--primary);\n                color: white;\n                padding: 0.125rem 0.5rem;\n                border-radius: 10px;\n                font-size: 0.75rem;\n                margin-left: 0.25rem;\n            }\n\n            .notification-center-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 0.5rem;\n            }\n\n            .notification-list {\n                display: flex;\n                flex-direction: column;\n                gap: 0.5rem;\n            }\n\n            .notification-item {\n                padding: 0.75rem;\n                border-radius: var(--radius);\n                background: var(--bg-body);\n                border-left: 3px solid var(--border);\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            .notification-item:hover {\n                background: var(--bg-card);\n                box-shadow: var(--shadow);\n            }\n\n            .notification-item.unread {\n                background: rgba(102, 126, 234, 0.05);\n                border-left-color: var(--primary);\n            }\n\n            .notification-item.priority-high {\n                border-left-color: var(--danger);\n            }\n\n            .notification-item-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: start;\n                margin-bottom: 0.5rem;\n            }\n\n            .notification-item-title {\n                font-weight: 600;\n                color: var(--text-primary);\n                font-size: 0.875rem;\n            }\n\n            .notification-item-time {\n                font-size: 0.75rem;\n                color: var(--text-muted);\n            }\n\n            .notification-item-content {\n                font-size: 0.8125rem;\n                color: var(--text-secondary);\n                line-height: 1.4;\n            }\n\n            .notification-item-actions {\n                display: flex;\n                gap: 0.5rem;\n                margin-top: 0.5rem;\n            }\n\n            .notification-item-actions button {\n                padding: 0.25rem 0.5rem;\n                font-size: 0.75rem;\n            }\n\n            .notification-center-footer {\n                padding: 0.75rem 1rem;\n                border-top: 1px solid var(--border);\n                text-align: center;\n            }\n\n            .notification-empty {\n                padding: 2rem;\n                text-align: center;\n                color: var(--text-muted);\n            }\n\n            @media (max-width: 768px) {\n                .notification-center {\n                    right: 10px;\n                    left: 10px;\n                    width: auto;\n                }\n            }\n        ",document.head.appendChild(t)}bindEvents(){document.addEventListener("click",t=>{const n=t.target.closest("[data-notifications-toggle]");if(n)return t.preventDefault(),void this.toggleCenter();document.getElementById("notificationCenter").contains(t.target)||n||this.closeCenter()}),document.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(!n)return;const i=n.dataset.action;"close"===i?this.closeCenter():"mark-all-read"===i?this.markAllAsRead():"settings"===i&&this.showSettings()}),document.addEventListener("click",t=>{const n=t.target.closest(".tab-btn");if(!n)return;const i=n.dataset.tab;this.switchTab(i)}),document.addEventListener("click",t=>{const n=t.target.closest(".notification-item");if(!n)return;const i=n.dataset.id;this.handleNotificationClick(i)})}toggleCenter(){const t=document.getElementById("notificationCenter");t.classList.toggle("show"),t.classList.contains("show")&&this.loadNotifications()}closeCenter(){document.getElementById("notificationCenter").classList.remove("show")}switchTab(t){document.querySelectorAll(".tab-btn").forEach(n=>{n.classList.toggle("active",n.dataset.tab===t)}),document.querySelectorAll(".notification-list").forEach(n=>{n.style.display=n.dataset.list===t?"":"none"})}async loadNotifications(){try{const t=await fetch("/api/notifications"),n=await t.json();this.notifications=n.notifications,this.unreadCount=n.unreadCount,this.renderNotifications(),this.updateBadges()}catch(t){console.error("Load notifications error:",t)}}renderNotifications(){const t=document.querySelector('[data-list="all"]'),n=document.querySelector('[data-list="unread"]'),i=document.querySelector('[data-list="mentions"]'),e=this.notifications,o=e.filter(t=>!t.read),a=e.filter(t=>"mention"===t.type);t.innerHTML=this.renderNotificationList(e),n.innerHTML=this.renderNotificationList(o),i.innerHTML=this.renderNotificationList(a)}renderNotificationList(t){return 0===t.length?'<div class="notification-empty">Нет уведомлений</div>':t.map(t=>this.renderNotificationItem(t)).join("")}renderNotificationItem(t){return`\n            <div class="notification-item ${t.read?"":"unread"} ${"high"===t.priority?"priority-high":""}" data-id="${t.id}">\n                <div class="notification-item-header">\n                    <div class="notification-item-title">\n                        <i class="fas fa-${this.getNotificationIcon(t.type)} me-2"></i>\n                        ${this.escapeHtml(t.title)}\n                    </div>\n                    <div class="notification-item-time">${this.formatTime(t.createdAt)}</div>\n                </div>\n                <div class="notification-item-content">${this.escapeHtml(t.message)}</div>\n                ${t.actions?this.renderActions(t.actions):""}\n            </div>\n        `}getNotificationIcon(t){return{task:"tasks",comment:"comment",mention:"at",assignment:"user-plus",deadline:"clock",completion:"check-circle",system:"info-circle"}[t]||"bell"}renderActions(t){return`\n            <div class="notification-item-actions">\n                ${t.map(t=>`\n                    <button class="btn btn-sm btn-outline-primary" data-action-id="${t.id}">\n                        ${t.label}\n                    </button>\n                `).join("")}\n            </div>\n        `}updateBadges(){const t=this.notifications.filter(t=>!t.read).length,n=this.notifications.filter(t=>"mention"===t.type&&!t.read).length;document.querySelector('[data-count="all"]').textContent=this.notifications.length,document.querySelector('[data-count="unread"]').textContent=t,document.querySelector('[data-count="mentions"]').textContent=n;const i=document.querySelector(".notification-badge-enhanced");i&&(i.textContent=t,i.style.display=t>0?"":"none")}async handleNotificationClick(t){const n=this.notifications.find(n=>n.id===t);n&&(n.read||await this.markAsRead(t),n.link&&(window.location.href=n.link))}async markAsRead(t){try{await fetch(`/api/notifications/${t}/read`,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}});const n=this.notifications.find(n=>n.id===t);n&&(n.read=!0),this.renderNotifications(),this.updateBadges()}catch(t){console.error("Mark as read error:",t)}}async markAllAsRead(){try{await fetch("/api/notifications/mark-all-read",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}}),this.notifications.forEach(t=>t.read=!0),this.renderNotifications(),this.updateBadges(),this.showToast("Все уведомления отмечены как прочитанные","success")}catch(t){console.error("Mark all as read error:",t)}}startPolling(){this.loadNotifications(),setInterval(()=>{this.loadNotifications()},this.settings.pollInterval)}async requestPermission(){"Notification"in window&&"default"===Notification.permission&&await Notification.requestPermission()}showDesktopNotification(t){if(!this.settings.desktop)return;if(!("Notification"in window))return;if("granted"!==Notification.permission)return;const n=new Notification(t.title,{body:t.message,icon:"/icon.png",badge:"/badge.png",tag:t.id});n.onclick=()=>{window.focus(),this.handleNotificationClick(t.id),n.close()}}playSound(){if(!this.settings.sound)return;const t=new Audio("/sounds/notification.mp3");t.volume=.5,t.play().catch(()=>{})}showSettings(){const t=document.createElement("div");t.className="modal fade",t.innerHTML=`\n            <div class="modal-dialog">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title">Настройки уведомлений</h5>\n                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-check form-switch mb-3">\n                            <input class="form-check-input" type="checkbox" id="soundSetting" ${this.settings.sound?"checked":""}>\n                            <label class="form-check-label" for="soundSetting">Звуковые уведомления</label>\n                        </div>\n                        <div class="form-check form-switch mb-3">\n                            <input class="form-check-input" type="checkbox" id="desktopSetting" ${this.settings.desktop?"checked":""}>\n                            <label class="form-check-label" for="desktopSetting">Desktop уведомления</label>\n                        </div>\n                        <div class="form-check form-switch mb-3">\n                            <input class="form-check-input" type="checkbox" id="groupingSetting" ${this.settings.grouping?"checked":""}>\n                            <label class="form-check-label" for="groupingSetting">Группировка уведомлений</label>\n                        </div>\n                        <div class="mb-3">\n                            <label class="form-label">Интервал обновления (секунды)</label>\n                            <input type="number" class="form-control" id="pollIntervalSetting" value="${this.settings.pollInterval/1e3}" min="10" max="300">\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>\n                        <button type="button" class="btn btn-primary" id="saveSettingsBtn">Сохранить</button>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(t);const n=new bootstrap.Modal(t);n.show(),t.querySelector("#saveSettingsBtn").addEventListener("click",()=>{this.settings.sound=t.querySelector("#soundSetting").checked,this.settings.desktop=t.querySelector("#desktopSetting").checked,this.settings.grouping=t.querySelector("#groupingSetting").checked,this.settings.pollInterval=1e3*parseInt(t.querySelector("#pollIntervalSetting").value),this.saveSettings(),n.hide(),this.showToast("Настройки сохранены","success")}),t.addEventListener("hidden.bs.modal",()=>{t.remove()})}formatTime(t){const n=new Date(t),i=new Date-n;return i<6e4?"только что":i<36e5?`${Math.floor(i/6e4)} мин назад`:i<864e5?`${Math.floor(i/36e5)} ч назад`:i<6048e5?`${Math.floor(i/864e5)} дн назад`:n.toLocaleDateString()}showToast(t,n="info"){"function"==typeof window.showToast&&window.showToast(t,n)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.advancedNotifications=new AdvancedNotifications}):window.advancedNotifications=new AdvancedNotifications,window.AdvancedNotifications=AdvancedNotifications;