class DragDropManager{constructor(){this.draggedElement=null,this.dropZones=new Map,this.draggedData=null,this.init()}init(){this.setupTaskDragDrop(),this.setupFileDragDrop(),this.setupKanbanDragDrop(),this.setupReordering(),this.addStyles()}setupTaskDragDrop(){document.querySelectorAll('[data-draggable="task"]').forEach(e=>{this.makeTaskDraggable(e)}),document.querySelectorAll('[data-drop-zone="task"]').forEach(e=>{this.makeTaskDropZone(e)})}makeTaskDraggable(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",t=>{this.draggedElement=e,this.draggedData={type:"task",id:e.dataset.taskId,status:e.dataset.status,priority:e.dataset.priority},e.classList.add("dragging"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",JSON.stringify(this.draggedData)),this.createDragGhost(e)}),e.addEventListener("dragend",t=>{e.classList.remove("dragging"),this.draggedElement=null,this.draggedData=null,this.removeDragGhost()})}createDragGhost(e){const t=e.cloneNode(!0);t.id="drag-ghost",t.style.position="absolute",t.style.top="-9999px",t.style.opacity="0.8",t.style.transform="rotate(5deg)",document.body.appendChild(t)}removeDragGhost(){const e=document.getElementById("drag-ghost");e&&e.remove()}makeTaskDropZone(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move","task"===this.draggedData?.type&&(e.classList.add("drag-over"),this.showDropIndicator(e,t))}),e.addEventListener("dragleave",t=>{t.target===e&&(e.classList.remove("drag-over"),this.hideDropIndicator())}),e.addEventListener("drop",async t=>{t.preventDefault(),e.classList.remove("drag-over"),this.hideDropIndicator(),"task"===this.draggedData?.type&&await this.handleTaskDrop(e,this.draggedData)})}showDropIndicator(e,t){let r=e.querySelector(".drop-indicator");r||(r=document.createElement("div"),r.className="drop-indicator",e.appendChild(r));const a=e.getBoundingClientRect(),n=t.clientY-a.top;r.style.top=`${n}px`}hideDropIndicator(){document.querySelectorAll(".drop-indicator").forEach(e=>e.remove())}async handleTaskDrop(e,t){const r=e.dataset.status,a=t.id;try{if(!(await fetch(`/api/v1/tasks/${a}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:r})})).ok)throw new Error("Failed to update status");this.draggedElement&&(e.appendChild(this.draggedElement),this.draggedElement.dataset.status=r),this.showNotification("–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω","success"),this.triggerStatusChange(a,r)}catch(e){console.error("Drop error:",e),this.showNotification("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞","error")}}setupFileDragDrop(){document.querySelectorAll("[data-file-drop]").forEach(e=>{this.makeFileDropZone(e)})}makeFileDropZone(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy",e.classList.add("file-drag-over")}),e.addEventListener("dragleave",t=>{t.target===e&&e.classList.remove("file-drag-over")}),e.addEventListener("drop",async t=>{t.preventDefault(),e.classList.remove("file-drag-over");const r=Array.from(t.dataTransfer.files);r.length>0&&await this.handleFileDrop(e,r)}),e.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.onchange=async t=>{const r=Array.from(t.target.files);await this.handleFileDrop(e,r)},t.click()})}async handleFileDrop(e,t){const r=e.dataset.allowedTypes?.split(",")||[],a=t.filter(e=>{if(e.size>10485760)return this.showNotification(`–§–∞–π–ª ${e.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)`,"error"),!1;if(r.length>0){const t=e.name.split(".").pop().toLowerCase();if(!r.includes(t))return this.showNotification(`–¢–∏–ø —Ñ–∞–π–ª–∞ ${t} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`,"error"),!1}return!0});if(0===a.length)return;const n=this.createProgressContainer(e);for(const t of a)await this.uploadFile(t,e,n);setTimeout(()=>n.remove(),2e3)}createProgressContainer(e){const t=document.createElement("div");return t.className="upload-progress-container",e.appendChild(t),t}async uploadFile(e,t,r){const a=new FormData;a.append("file",e),a.append("entityType",t.dataset.entityType||"task"),a.append("entityId",t.dataset.entityId||"");const n=document.createElement("div");n.className="upload-progress-item",n.innerHTML=`\n            <div class="upload-file-name">${e.name}</div>\n            <div class="upload-progress-bar">\n                <div class="upload-progress-fill" style="width: 0%"></div>\n            </div>\n            <div class="upload-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>\n        `,r.appendChild(n);const o=n.querySelector(".upload-progress-fill"),s=n.querySelector(".upload-status");try{const t=new XMLHttpRequest;t.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;o.style.width=`${t}%`}}),t.addEventListener("load",()=>{if(200!==t.status)throw new Error("Upload failed");s.textContent="–ì–æ—Ç–æ–≤–æ",n.classList.add("success"),this.showNotification(`–§–∞–π–ª ${e.name} –∑–∞–≥—Ä—É–∂–µ–Ω`,"success")}),t.addEventListener("error",()=>{s.textContent="–û—à–∏–±–∫–∞",n.classList.add("error"),this.showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${e.name}`,"error")}),t.open("POST","/api/files/upload"),t.send(a)}catch(e){console.error("Upload error:",e),s.textContent="–û—à–∏–±–∫–∞",n.classList.add("error")}}setupKanbanDragDrop(){document.querySelectorAll(".kanban-column").forEach(e=>{this.makeKanbanDropZone(e)}),document.querySelectorAll(".kanban-card").forEach(e=>{this.makeKanbanCardDraggable(e)})}makeKanbanCardDraggable(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",t=>{this.draggedElement=e,e.classList.add("dragging"),t.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),this.draggedElement=null})}makeKanbanDropZone(e){const t=e.querySelector(".kanban-cards");t&&(t.addEventListener("dragover",e=>{e.preventDefault();const r=this.getDragAfterElement(t,e.clientY),a=document.querySelector(".dragging");null==r?t.appendChild(a):t.insertBefore(a,r)}),t.addEventListener("drop",async t=>{if(t.preventDefault(),this.draggedElement){e.dataset.status;const t=this.draggedElement.dataset.taskId;await this.handleTaskDrop(e,{id:t,type:"task"})}}))}getDragAfterElement(e,t){return[...e.querySelectorAll(".kanban-card:not(.dragging)")].reduce((e,r)=>{const a=r.getBoundingClientRect(),n=t-a.top-a.height/2;return n<0&&n>e.offset?{offset:n,element:r}:e},{offset:Number.NEGATIVE_INFINITY}).element}setupReordering(){document.querySelectorAll("[data-reorderable]").forEach(e=>{this.makeReorderable(e)})}makeReorderable(e){e.querySelectorAll("[data-reorder-item]").forEach(t=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{this.draggedElement=t,t.classList.add("dragging")}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),this.saveOrder(e)})}),e.addEventListener("dragover",t=>{t.preventDefault();const r=this.getDragAfterElement(e,t.clientY),a=document.querySelector(".dragging");null==r?e.appendChild(a):e.insertBefore(a,r)})}async saveOrder(e){const t=[...e.querySelectorAll("[data-reorder-item]")].map((e,t)=>({id:e.dataset.itemId,position:t}));try{await fetch("/api/v1/tasks/reorder",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:e.dataset.reorderable,order:t})}),this.showNotification("–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω","success")}catch(e){console.error("Save order error:",e),this.showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞","error")}}triggerStatusChange(e,t){const r=new CustomEvent("taskStatusChanged",{detail:{taskId:e,newStatus:t}});document.dispatchEvent(r)}addStyles(){if(document.getElementById("dragDropStyles"))return;const e=document.createElement("style");e.id="dragDropStyles",e.textContent="\n            [draggable=\"true\"] {\n                cursor: move;\n            }\n\n            .dragging {\n                opacity: 0.5;\n                transform: rotate(5deg);\n            }\n\n            .drag-over {\n                background: rgba(102, 126, 234, 0.1);\n                border: 2px dashed var(--primary);\n            }\n\n            .file-drag-over {\n                background: rgba(102, 126, 234, 0.1);\n                border: 2px dashed var(--primary);\n                transform: scale(1.02);\n            }\n\n            .drop-indicator {\n                position: absolute;\n                left: 0;\n                right: 0;\n                height: 2px;\n                background: var(--primary);\n                pointer-events: none;\n                z-index: 1000;\n            }\n\n            .drop-indicator::before {\n                content: '';\n                position: absolute;\n                left: 0;\n                top: -4px;\n                width: 8px;\n                height: 8px;\n                border-radius: 50%;\n                background: var(--primary);\n            }\n\n            .upload-progress-container {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--bg-card);\n                border-radius: 8px;\n                padding: 1rem;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                min-width: 300px;\n                z-index: 1000;\n            }\n\n            .upload-progress-item {\n                margin-bottom: 1rem;\n            }\n\n            .upload-progress-item:last-child {\n                margin-bottom: 0;\n            }\n\n            .upload-file-name {\n                font-size: 0.875rem;\n                font-weight: 500;\n                margin-bottom: 0.5rem;\n                color: var(--text-primary);\n            }\n\n            .upload-progress-bar {\n                height: 4px;\n                background: var(--bg-body);\n                border-radius: 2px;\n                overflow: hidden;\n                margin-bottom: 0.25rem;\n            }\n\n            .upload-progress-fill {\n                height: 100%;\n                background: var(--primary);\n                transition: width 0.3s ease;\n            }\n\n            .upload-progress-item.success .upload-progress-fill {\n                background: var(--success);\n            }\n\n            .upload-progress-item.error .upload-progress-fill {\n                background: var(--danger);\n            }\n\n            .upload-status {\n                font-size: 0.75rem;\n                color: var(--text-muted);\n            }\n\n            .upload-progress-item.success .upload-status {\n                color: var(--success);\n            }\n\n            .upload-progress-item.error .upload-status {\n                color: var(--danger);\n            }\n\n            [data-file-drop] {\n                border: 2px dashed var(--border);\n                border-radius: 8px;\n                padding: 2rem;\n                text-align: center;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                position: relative;\n            }\n\n            [data-file-drop]:hover {\n                border-color: var(--primary);\n                background: rgba(102, 126, 234, 0.05);\n            }\n\n            [data-file-drop]::before {\n                content: 'üìÅ';\n                font-size: 3rem;\n                display: block;\n                margin-bottom: 1rem;\n            }\n\n            [data-file-drop]::after {\n                content: '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞';\n                display: block;\n                color: var(--text-muted);\n                font-size: 0.875rem;\n            }\n        ",document.head.appendChild(e)}showNotification(e,t="info"){"function"==typeof window.showToast&&window.showToast(e,t)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.dragDropManager=new DragDropManager}):window.dragDropManager=new DragDropManager,window.DragDropManager=DragDropManager;