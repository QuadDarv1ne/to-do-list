!function(){"use strict";class t{constructor(t={}){this.options={promptDelay:3e3,storageKey:"pwa_install_dismissed",...t},this.deferredPrompt=null,this.isInstalled=this.checkIfInstalled(),this.init()}init(){this.registerServiceWorker(),this.setupInstallPrompt(),this.setupOnlineOfflineHandlers(),this.checkPWAMode(),this.isInstalled||this.hasDismissed()||setTimeout(()=>this.showInstallPrompt(),this.options.promptDelay)}async registerServiceWorker(){if("serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"});console.log("[PWA] Service Worker registered:",t.scope),t.addEventListener("updatefound",()=>{const n=t.installing;n.addEventListener("statechange",()=>{"installed"===n.state&&navigator.serviceWorker.controller&&this.showUpdatePrompt()})}),navigator.serviceWorker.addEventListener("message",t=>{this.handleSWMessage(t.data)})}catch(t){console.error("[PWA] Service Worker registration failed:",t)}}setupInstallPrompt(){window.addEventListener("beforeinstallprompt",t=>{console.log("[PWA] beforeinstallprompt event fired"),t.preventDefault(),this.deferredPrompt=t,this.showInstallButton()}),window.addEventListener("appinstalled",()=>{console.log("[PWA] App installed successfully"),this.deferredPrompt=null,this.isInstalled=!0,this.hideInstallPrompt(),localStorage.setItem(this.options.storageKey,"true")})}setupOnlineOfflineHandlers(){window.addEventListener("online",()=>{console.log("[PWA] Connection restored"),this.showConnectionToast("online"),this.syncOfflineData()}),window.addEventListener("offline",()=>{console.log("[PWA] Connection lost"),this.showConnectionToast("offline")})}checkPWAMode(){const t=window.matchMedia("(display-mode: standalone)").matches,n=!0===window.navigator.standalone;t||n?(console.log("[PWA] Running as standalone PWA"),document.body.classList.add("pwa-mode")):console.log("[PWA] Running in browser")}checkIfInstalled(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||"true"===localStorage.getItem(this.options.storageKey)}hasDismissed(){return"true"===localStorage.getItem(this.options.storageKey)}showInstallButton(){if(document.querySelector(".pwa-install-btn"))return;const t=document.createElement("button");t.className="btn btn-primary pwa-install-btn",t.innerHTML='\n                <i class="fas fa-download me-2"></i>\n                Установить приложение\n            ',t.addEventListener("click",()=>this.promptInstall());const n=document.querySelector(".navbar-nav.ms-auto");if(n){const s=document.createElement("li");s.className="nav-item",s.appendChild(t),n.insertBefore(s,n.firstChild)}}showInstallPrompt(){if(this.deferredPrompt||this.canInstall()){const t=document.createElement("div");t.className="modal fade pwa-install-modal",t.id="pwaInstallModal",t.tabIndex="-1",t.innerHTML='\n                    <div class="modal-dialog modal-dialog-centered">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">\n                                    <i class="fas fa-mobile-alt me-2"></i>\n                                    Установить приложение\n                                </h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <div class="text-center mb-4">\n                                    <i class="fas fa-download fa-3x text-primary mb-3"></i>\n                                    <h4>CRM Задачи всегда под рукой</h4>\n                                    <p class="text-muted">\n                                        Установите наше приложение для быстрого доступа и работы в офлайн-режиме\n                                    </p>\n                                </div>\n                                \n                                <div class="list-group mb-4">\n                                    <div class="list-group-item d-flex align-items-center gap-3">\n                                        <i class="fas fa-bolt text-warning fa-lg"></i>\n                                        <div>\n                                            <strong>Быстрый доступ</strong>\n                                            <p class="mb-0 text-muted small">Запускайте приложение в один клик</p>\n                                        </div>\n                                    </div>\n                                    <div class="list-group-item d-flex align-items-center gap-3">\n                                        <i class="fas fa-wifi text-success fa-lg"></i>\n                                        <div>\n                                            <strong>Офлайн-режим</strong>\n                                            <p class="mb-0 text-muted small">Работайте без интернета</p>\n                                        </div>\n                                    </div>\n                                    <div class="list-group-item d-flex align-items-center gap-3">\n                                        <i class="fas fa-bell text-info fa-lg"></i>\n                                        <div>\n                                            <strong>Уведомления</strong>\n                                            <p class="mb-0 text-muted small">Получайте push-уведомления</p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-outline-secondary" onclick="PWAInstall.dismiss()">\n                                    Позже\n                                </button>\n                                <button type="button" class="btn btn-primary" onclick="PWAInstall.install()">\n                                    <i class="fas fa-download me-2"></i>\n                                    Установить\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t);new bootstrap.Modal(t).show()}}canInstall(){const t=/iPad|iPhone|iPod/.test(navigator.userAgent),n=!0===window.navigator.standalone;return t&&!n}async promptInstall(){const t=document.getElementById("pwaInstallModal");if(t){bootstrap.Modal.getInstance(t).hide()}if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome:t}=await this.deferredPrompt.userChoice;console.log("[PWA] User choice:",t),"accepted"===t&&console.log("[PWA] User accepted install prompt"),this.deferredPrompt=null}else this.canInstall()&&this.showIOSInstallInstructions()}showIOSInstallInstructions(){const t=document.createElement("div");t.className="modal fade pwa-install-modal",t.id="pwaIOSModal",t.innerHTML='\n                <div class="modal-dialog modal-dialog-centered">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title">\n                                <i class="fab fa-apple me-2"></i>\n                                Установка на iOS\n                            </h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                        </div>\n                        <div class="modal-body text-center">\n                            <p class="mb-4">Чтобы установить приложение на iOS:</p>\n                            \n                            <div class="text-start">\n                                <div class="d-flex align-items-center gap-3 mb-3">\n                                    <span class="badge bg-primary rounded-circle" style="width: 32px; height: 32px;">1</span>\n                                    <span>Нажмите кнопку "Поделиться"</span>\n                                    <i class="fas fa-share-square fa-lg text-primary"></i>\n                                </div>\n                                \n                                <div class="d-flex align-items-center gap-3 mb-3">\n                                    <span class="badge bg-primary rounded-circle" style="width: 32px; height: 32px;">2</span>\n                                    <span>Выберите "На экран «Домой»"</span>\n                                    <i class="fas fa-plus-square fa-lg text-primary"></i>\n                                </div>\n                                \n                                <div class="d-flex align-items-center gap-3">\n                                    <span class="badge bg-primary rounded-circle" style="width: 32px; height: 32px;">3</span>\n                                    <span>Нажмите "Добавить"</span>\n                                    <i class="fas fa-check-square fa-lg text-primary"></i>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            ',document.body.appendChild(t);new bootstrap.Modal(t).show()}dismiss(){localStorage.setItem(this.options.storageKey,"true"),this.hideInstallPrompt()}hideInstallPrompt(){const t=document.querySelector(".pwa-install-btn");t&&t.remove();const n=document.getElementById("pwaInstallModal");n&&n.remove()}showUpdatePrompt(){const t=document.createElement("div");t.className="toast position-fixed bottom-0 end-0 m-3",t.role="alert",t.innerHTML='\n                <div class="toast-header">\n                    <i class="fas fa-sync fa-spin me-2 text-primary"></i>\n                    <strong class="me-auto">Доступно обновление</strong>\n                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>\n                </div>\n                <div class="toast-body">\n                    Новая версия приложения готова. \n                    <button class="btn btn-sm btn-primary ms-2" onclick="location.reload()">\n                        Обновить\n                    </button>\n                </div>\n            ',document.body.appendChild(t);new bootstrap.Toast(t,{autohide:!1}).show()}showConnectionToast(t){const n=document.createElement("div");n.className="toast position-fixed top-0 start-50 translate-middle-x m-3",n.role="alert";const s="online"===t;n.innerHTML=`\n                <div class="toast-header bg-${s?"success":"warning"} text-white">\n                    <i class="fas fa-${s?"wifi":"wifi-slash"} me-2"></i>\n                    <strong class="me-auto">${s?"Подключение восстановлено":"Нет подключения"}</strong>\n                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>\n                </div>\n                ${s?"":'\n                    <div class="toast-body">\n                        Вы можете просматривать кэшированные страницы\n                        <a href="/offline-page.html" class="btn btn-sm btn-outline-warning ms-2">\n                            Офлайн-режим\n                        </a>\n                    </div>\n                '}\n            `,document.body.appendChild(n);new bootstrap.Toast(n,{delay:3e3}).show()}async syncOfflineData(){if("serviceWorker"in navigator&&"sync"in window.registration)try{await navigator.serviceWorker.ready,await window.registration.sync.register("sync-offline-actions"),console.log("[PWA] Offline data synced")}catch(t){console.log("[PWA] Sync not available:",t)}}handleSWMessage(t){switch(console.log("[PWA] Message from SW:",t),t.type){case"TASKS_SYNCED":showToast(`Синхронизировано задач: ${t.count}`,"success");break;case"CACHE_CLEARED":console.log("[PWA] Cache cleared")}}install(){this.promptInstall()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.PWAInstall=new t}):window.PWAInstall=new t,window.PWAInstall=window.PWAInstall||{},window.PWAInstall.install=()=>window.PWAInstall.promptInstall(),window.PWAInstall.dismiss=()=>window.PWAInstall.dismiss()}();