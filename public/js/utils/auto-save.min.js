class AutoSave{constructor(){this.forms=new Map,this.saveDelay=2e3,this.init()}init(){this.discoverForms(),this.setupEventListeners()}discoverForms(){document.querySelectorAll("[data-auto-save]").forEach(e=>{const t=e.id||`form-${Date.now()}`;e.id||(e.id=t);const a={element:e,id:t,saveUrl:e.dataset.autoSaveUrl||e.action,saveDelay:parseInt(e.dataset.autoSaveDelay)||this.saveDelay,timer:null,lastSaved:null,isDirty:!1,savedData:this.loadDraft(t)};this.forms.set(t,a),this.setupForm(a)})}setupForm(e){const t=e.element;e.savedData&&(this.restoreFormData(t,e.savedData),this.showRestoreNotification(t,e)),this.addSaveIndicator(t),t.addEventListener("input",t=>{this.handleInput(e,t)}),t.addEventListener("change",t=>{this.handleInput(e,t)}),t.addEventListener("submit",t=>{this.handleSubmit(e,t)})}addSaveIndicator(e){const t=document.createElement("div");t.className="auto-save-indicator",t.innerHTML='\n            <span class="auto-save-status">\n                <i class="fas fa-circle"></i>\n                <span class="auto-save-text">Все изменения сохранены</span>\n            </span>\n            <span class="auto-save-time"></span>\n        ';const a=e.querySelector('.form-actions, .modal-footer, [type="submit"]');a?a.parentNode.insertBefore(t,a):e.appendChild(t),this.addAutoSaveStyles()}addAutoSaveStyles(){if(document.getElementById("autoSaveStyles"))return;const e=document.createElement("style");e.id="autoSaveStyles",e.textContent="\n            .auto-save-indicator {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 0.75rem;\n                margin: 1rem 0;\n                background: var(--bg-body);\n                border-radius: var(--radius);\n                font-size: 0.875rem;\n            }\n\n            .auto-save-status {\n                display: flex;\n                align-items: center;\n                gap: 0.5rem;\n            }\n\n            .auto-save-status i {\n                font-size: 0.5rem;\n                color: var(--success);\n                animation: pulse 2s infinite;\n            }\n\n            .auto-save-indicator.saving .auto-save-status i {\n                color: var(--warning);\n                animation: spin 1s linear infinite;\n            }\n\n            .auto-save-indicator.error .auto-save-status i {\n                color: var(--danger);\n                animation: none;\n            }\n\n            .auto-save-text {\n                color: var(--text-secondary);\n            }\n\n            .auto-save-time {\n                color: var(--text-muted);\n                font-size: 0.75rem;\n            }\n\n            @keyframes spin {\n                from {\n                    transform: rotate(0deg);\n                }\n                to {\n                    transform: rotate(360deg);\n                }\n            }\n\n            .draft-restore-banner {\n                position: fixed;\n                top: 70px;\n                left: 50%;\n                transform: translateX(-50%);\n                background: var(--info);\n                color: white;\n                padding: 1rem 1.5rem;\n                border-radius: var(--radius-lg);\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);\n                z-index: 9997;\n                display: flex;\n                align-items: center;\n                gap: 1rem;\n                animation: slideDown 0.3s ease-out;\n            }\n\n            .draft-restore-banner-content {\n                flex: 1;\n            }\n\n            .draft-restore-banner-actions {\n                display: flex;\n                gap: 0.5rem;\n            }\n        ",document.head.appendChild(e)}handleInput(e,t){e.isDirty=!0,this.updateIndicator(e.element,"unsaved"),clearTimeout(e.timer),e.timer=setTimeout(()=>{this.saveForm(e)},e.saveDelay)}async saveForm(e){if(!e.isDirty)return;const t=e.element,a=new FormData(t),n=Object.fromEntries(a.entries());this.updateIndicator(t,"saving");try{if(this.saveDraft(e.id,n),e.saveUrl&&"#"!==e.saveUrl){if(!(await fetch(e.saveUrl,{method:"POST",headers:{"Content-Type":"application/json","X-Auto-Save":"true","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(n)})).ok)throw new Error("Save failed")}e.isDirty=!1,e.lastSaved=new Date,this.updateIndicator(t,"saved",e.lastSaved)}catch(e){console.error("Auto-save error:",e),this.updateIndicator(t,"error")}}updateIndicator(e,t,a=null){const n=e.querySelector(".auto-save-indicator");if(!n)return;const s=n.querySelector(".auto-save-status i"),r=n.querySelector(".auto-save-text"),o=n.querySelector(".auto-save-time");switch(n.className="auto-save-indicator "+t,t){case"saving":s.className="fas fa-spinner",r.textContent="Сохранение...";break;case"saved":s.className="fas fa-check-circle",r.textContent="Все изменения сохранены",a&&(o.textContent=this.formatTime(a));break;case"unsaved":s.className="fas fa-circle",r.textContent="Несохраненные изменения";break;case"error":s.className="fas fa-exclamation-circle",r.textContent="Ошибка сохранения"}}formatTime(e){const t=new Date-e;if(t<6e4)return"только что";if(t<36e5){return`${Math.floor(t/6e4)} мин назад`}return e.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}handleSubmit(e,t){this.clearDraft(e.id),e.isDirty=!1}saveDraft(e,t){try{const a={data:t,timestamp:(new Date).toISOString()};localStorage.setItem(`draft_${e}`,JSON.stringify(a))}catch(e){console.error("Failed to save draft:",e)}}loadDraft(e){try{const t=localStorage.getItem(`draft_${e}`);if(t){const a=JSON.parse(t);if(Date.now()-new Date(a.timestamp).getTime()<6048e5)return a.data;this.clearDraft(e)}}catch(e){console.error("Failed to load draft:",e)}return null}clearDraft(e){try{localStorage.removeItem(`draft_${e}`)}catch(e){console.error("Failed to clear draft:",e)}}restoreFormData(e,t){for(const[a,n]of Object.entries(t)){const t=e.querySelector(`[name="${a}"]`);if(t)if("checkbox"===t.type)t.checked="on"===n||!0===n;else if("radio"===t.type){const t=e.querySelector(`[name="${a}"][value="${n}"]`);t&&(t.checked=!0)}else t.value=n}}showRestoreNotification(e,t){const a=document.createElement("div");a.className="draft-restore-banner",a.innerHTML='\n            <div class="draft-restore-banner-content">\n                <i class="fas fa-info-circle me-2"></i>\n                <strong>Найден несохраненный черновик</strong>\n                <div class="small mt-1">Восстановить данные из предыдущей сессии?</div>\n            </div>\n            <div class="draft-restore-banner-actions">\n                <button type="button" class="btn btn-sm btn-light" data-action="restore">\n                    Восстановить\n                </button>\n                <button type="button" class="btn btn-sm btn-outline-light" data-action="discard">\n                    Отклонить\n                </button>\n            </div>\n        ',document.body.appendChild(a),a.querySelector('[data-action="restore"]').addEventListener("click",()=>{a.remove(),this.showToast("Черновик восстановлен","success")}),a.querySelector('[data-action="discard"]').addEventListener("click",()=>{this.clearDraft(t.id),e.reset(),a.remove(),this.showToast("Черновик удален","info")}),setTimeout(()=>{a.parentNode&&a.remove()},1e4)}setupEventListeners(){document.addEventListener("turbo:load",()=>{this.discoverForms()}),window.addEventListener("beforeunload",e=>{if(Array.from(this.forms.values()).some(e=>e.isDirty))return e.preventDefault(),e.returnValue="У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?",e.returnValue})}saveAll(){this.forms.forEach(e=>{e.isDirty&&this.saveForm(e)})}clearAllDrafts(){this.forms.forEach((e,t)=>{this.clearDraft(t)})}showToast(e,t="info"){"function"==typeof window.showToast&&window.showToast(e,t)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.autoSave=new AutoSave}):window.autoSave=new AutoSave,window.AutoSave=AutoSave;