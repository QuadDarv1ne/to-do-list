!function(){"use strict";const e={validationDelay:300,autoSaveDelay:2e3,autoSaveInterval:3e4,minSearchLength:3,debounceDelay:300,toastDuration:5e3,draftPrefix:"form_draft_",validationClasses:{success:"is-valid",error:"is-invalid",warning:"is-warning"}},t={required:e=>"string"==typeof e?e.trim().length>0:null!=e,email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),minLength:(e,t)=>e&&e.length>=t,maxLength:(e,t)=>e&&e.length<=t,min:(e,t)=>e&&parseFloat(e)>=t,max:(e,t)=>e&&parseFloat(e)<=t,pattern:(e,t)=>new RegExp(t).test(e),numeric:e=>!isNaN(parseFloat(e))&&isFinite(e),url:e=>{try{return new URL(e),!0}catch{return!1}},phone:e=>/^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/.test(e.replace(/\s/g,"")),password:e=>/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/.test(e),match:(e,t)=>{const s=document.querySelector(t);return s&&e===s.value},notEqual:(e,t)=>e!==t,custom:(e,t)=>t(e)},s={required:"Это поле обязательно для заполнения",email:"Введите корректный email адрес",minLength:"Минимальная длина - {min} символов",maxLength:"Максимальная длина - {max} символов",min:"Минимальное значение - {min}",max:"Максимальное значение - {max}",pattern:"Введите значение в правильном формате",numeric:"Введите числовое значение",url:"Введите корректный URL",phone:"Введите корректный номер телефона",password:"Пароль должен содержать минимум 8 символов, 1 букву и 1 цифру",match:"Значения не совпадают",notEqual:"Это значение уже используется"};class a{constructor(t,s={}){this.form=t,this.options={...e,...s},this.errors=new Map,this.fields=new Map,this.isValid=!1,this.init()}init(){this.collectFields(),this.attachListeners(),this.loadDraft()}collectFields(){this.form.querySelectorAll("input, select, textarea").forEach(e=>{const t=this.parseRules(e);t.length>0&&this.fields.set(e.name||e.id,{element:e,rules:t,isValid:!0,value:e.value})})}parseRules(e){const t=[];if(e.hasAttribute("required")&&t.push({name:"required",message:s.required}),"email"===e.type&&t.push({name:"email",message:s.email}),"number"===e.type&&(e.min&&t.push({name:"min",value:parseFloat(e.min),message:s.min}),e.max&&t.push({name:"max",value:parseFloat(e.max),message:s.max})),e.hasAttribute("data-validate")){JSON.parse(e.getAttribute("data-validate")).forEach(e=>{"string"==typeof e?t.push({name:e,message:s[e]||"Ошибка валидации"}):"object"==typeof e&&t.push({name:e.rule,value:e.value,message:e.message||s[e.rule]||"Ошибка валидации"})})}return e.minLength>0&&t.push({name:"minLength",value:e.minLength,message:s.minLength}),e.maxLength>0&&t.push({name:"maxLength",value:e.maxLength,message:s.maxLength}),e.pattern&&t.push({name:"pattern",value:e.pattern,message:s.pattern}),t}attachListeners(){this.fields.forEach((e,t)=>{const s=e.element;let a;s.addEventListener("input",()=>{clearTimeout(a),a=setTimeout(()=>{this.validateField(t)},this.options.validationDelay)}),s.addEventListener("blur",()=>{this.validateField(t)}),s.addEventListener("focus",()=>{this.clearFieldError(t)})}),this.form.addEventListener("submit",e=>{this.validateAll()||(e.preventDefault(),this.showSummary())})}validateField(e){const s=this.fields.get(e);if(!s)return!0;const a=s.element.value;let i=!0,r="";for(const e of s.rules){const s=t[e.name];if(!s)continue;if(!s(...void 0!==e.value?[a,e.value]:[a])){i=!1,r=this.formatMessage(e.message,e);break}}return s.isValid=i,s.value=a,i?this.clearFieldError(e):this.showFieldError(e,r),i}validateAll(){let e=!0;return this.fields.forEach((t,s)=>{this.validateField(s)||(e=!1)}),this.isValid=e,e}showFieldError(e,t){const s=this.fields.get(e);if(!s)return;const a=s.element;a.closest(".mb-3, .form-group, .form-control");this.clearFieldError(e),a.classList.add(this.options.validationClasses.error),a.classList.remove(this.options.validationClasses.success);const i=document.createElement("div");i.className="invalid-feedback d-block",i.innerHTML=`<i class="fas fa-exclamation-circle me-1"></i>${t}`,i.setAttribute("data-error-for",a.name||a.id),a.parentElement.classList.contains("input-group")?a.parentElement.after(i):a.after(i),i.style.opacity="0",setTimeout(()=>{i.style.transition="opacity 0.3s ease",i.style.opacity="1"},10),this.errors.set(e,{message:t,element:i})}clearFieldError(e){const t=this.fields.get(e);if(!t)return;const s=t.element;s.closest(".mb-3, .form-group, .form-control");s.classList.remove(this.options.validationClasses.error),s.classList.add(this.options.validationClasses.success);const a=this.errors.get(e)?.element;a&&(a.style.opacity="0",setTimeout(()=>a.remove(),300),this.errors.delete(e))}clearAllErrors(){this.fields.forEach((e,t)=>{this.clearFieldError(t)}),this.errors.clear()}formatMessage(e,t){return e.replace(/{(\w+)}/g,(e,s)=>void 0!==t[s]?t[s]:e)}showSummary(){if(0===this.errors.size)return;const e=this.errors.size,t=Array.from(this.errors.values())[0];window.showToast&&window.showToast(`Исправьте ${e} ${this.pluralize(e,["ошибку","ошибки","ошибок"])} в форме`,"error"),t?.element&&t.element.scrollIntoView({behavior:"smooth",block:"center"})}pluralize(e,t){const s=e%100,a=s%10;return s>10&&s<20?t[2]:a>1&&a<5?t[1]:1===a?t[0]:t[2]}saveDraft(){const e={};this.fields.forEach((t,s)=>{e[s]=t.element.value});const t=this.options.draftPrefix+(this.form.id||this.form.action);localStorage.setItem(t,JSON.stringify({data:e,timestamp:Date.now()})),window.showToast&&window.showToast("Черновик сохранён","success")}loadDraft(){const e=this.options.draftPrefix+(this.form.id||this.form.action),t=localStorage.getItem(e);if(t)try{const{data:e,timestamp:s}=JSON.parse(t),a=Date.now()-s;if(a>864e5)return void this.clearDraft();Object.keys(e).forEach(t=>{const s=this.fields.get(t);s&&(s.element.value=e[t])}),window.showToast&&Object.keys(e).length>0&&window.showToast("Черновик загружен","info")}catch(e){this.clearDraft()}}clearDraft(){const e=this.options.draftPrefix+(this.form.id||this.form.action);localStorage.removeItem(e)}startAutoSave(){let e;this.form.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{this.saveDraft()},this.options.autoSaveDelay)}),setInterval(()=>{this.saveDraft()},this.options.autoSaveInterval)}getValues(){const e={};return this.fields.forEach((t,s)=>{e[s]=t.element.value}),e}setValues(e){Object.keys(e).forEach(t=>{const s=this.fields.get(t);s&&(s.element.value=e[t],this.validateField(t))})}reset(){this.form.reset(),this.clearAllErrors(),this.clearDraft()}destroy(){this.clearAllErrors(),this.fields.clear(),this.errors.clear()}}window.FormValidator=a,document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-validate-form]").forEach(e=>{const t=e.dataset.validateOptions?JSON.parse(e.dataset.validateOptions):{},s=new a(e,t);e.formValidator=s,"false"!==e.dataset.autoSave&&s.startAutoSave()})}),console.log("[FormValidator] Initialized")}();