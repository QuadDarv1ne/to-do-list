class TableEnhancements{constructor(){this.tables=[],this.init()}init(){this.enhanceTables(),this.initColumnResizing(),this.initRowSelection(),this.initInlineEditing()}enhanceTables(){document.querySelectorAll("[data-enhanced-table]").forEach(e=>{const t={sortable:"false"!==e.dataset.sortable,filterable:"false"!==e.dataset.filterable,resizable:"false"!==e.dataset.resizable,selectable:"false"!==e.dataset.selectable};this.enhanceTable(e,t)})}enhanceTable(e,t){const a={element:e,config:t,data:this.extractTableData(e),sortColumn:null,sortDirection:"asc",filters:{}};this.tables.push(a),t.sortable&&this.makeSortable(a),t.filterable&&this.makeFilterable(a),t.resizable&&this.makeResizable(a),t.selectable&&this.makeSelectable(a),this.addTableSearch(a)}extractTableData(e){return Array.from(e.querySelectorAll("tbody tr")).map(e=>{const t=Array.from(e.querySelectorAll("td"));return{element:e,values:t.map(e=>e.textContent.trim()),data:t.map(e=>e.dataset.value||e.textContent.trim())}})}makeSortable(e){e.element.querySelectorAll("thead th").forEach((t,a)=>{if("false"===t.dataset.sortable)return;t.style.cursor="pointer",t.classList.add("sortable");const n=document.createElement("i");n.className="fas fa-sort ms-2 sort-icon",t.appendChild(n),t.addEventListener("click",()=>{this.sortTable(e,a)})})}sortTable(e,t){const{element:a,data:n,sortColumn:s,sortDirection:l}=e;let o="asc";s===t&&(o="asc"===l?"desc":"asc");const r=[...n].sort((e,a)=>{const n=e.data[t],s=a.data[t],l=parseFloat(n),r=parseFloat(s);if(!isNaN(l)&&!isNaN(r))return"asc"===o?l-r:r-l;const c=n.localeCompare(s);return"asc"===o?c:-c}),c=a.querySelector("tbody");c.innerHTML="",r.forEach(e=>c.appendChild(e.element));a.querySelectorAll("thead th").forEach((e,a)=>{const n=e.querySelector(".sort-icon");n&&(n.className=a===t?`fas fa-sort-${"asc"===o?"up":"down"} ms-2 sort-icon`:"fas fa-sort ms-2 sort-icon")}),e.sortColumn=t,e.sortDirection=o}makeFilterable(e){const t=e.element,a=t.querySelectorAll("thead th"),n=document.createElement("tr");n.className="filter-row",a.forEach((t,a)=>{const s=document.createElement("th");if("false"!==t.dataset.filterable){const t=document.createElement("input");t.type="text",t.className="form-control form-control-sm",t.placeholder="Фильтр...",t.dataset.columnIndex=a,t.addEventListener("input",t=>{this.filterTable(e,a,t.target.value)}),s.appendChild(t)}n.appendChild(s)}),t.querySelector("thead").appendChild(n)}filterTable(e,t,a){e.filters[t]=a.toLowerCase();const{element:n,data:s,filters:l}=e;n.querySelector("tbody");s.forEach(e=>{let t=!0;for(const[a,n]of Object.entries(l))if(n&&!e.values[a].toLowerCase().includes(n)){t=!1;break}e.element.style.display=t?"":"none"}),this.updateTableInfo(e)}updateTableInfo(e){const t=e.data.filter(e=>"none"!==e.element.style.display).length,a=e.element.parentElement.querySelector("[data-table-info]");a&&(a.textContent=`Показано ${t} из ${e.data.length} записей`)}addTableSearch(e){const t=e.element.parentElement.querySelector("[data-table-search]");if(!t)return;const a=document.createElement("input");a.type="search",a.className="form-control",a.placeholder="Поиск по таблице...",a.addEventListener("input",t=>{this.searchTable(e,t.target.value)}),t.appendChild(a)}searchTable(e,t){const a=t.toLowerCase(),{data:n}=e;n.forEach(e=>{const t=e.values.some(e=>e.toLowerCase().includes(a));e.element.style.display=t?"":"none"}),this.updateTableInfo(e)}initColumnResizing(){document.addEventListener("mousedown",e=>{if(!e.target.matches(".column-resizer"))return;const t=e.target.parentElement,a=e.pageX,n=t.offsetWidth,s=e=>{const s=n+(e.pageX-a);t.style.width=s+"px"},l=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",l)})}makeResizable(e){e.element.querySelectorAll("thead th").forEach(e=>{const t=document.createElement("div");t.className="column-resizer",t.style.cssText="\n                position: absolute;\n                right: 0;\n                top: 0;\n                width: 5px;\n                height: 100%;\n                cursor: col-resize;\n                user-select: none;\n            ",e.style.position="relative",e.appendChild(t)})}initRowSelection(){document.addEventListener("click",e=>{const t=e.target.closest("tr[data-selectable]");if(!t)return;const a=t.querySelector('input[type="checkbox"]');a&&e.target!==a&&(a.checked=!a.checked,a.dispatchEvent(new Event("change",{bubbles:!0}))),t.classList.toggle("selected",a?.checked)})}makeSelectable(e){const t=e.element,a=t.querySelector("thead tr:first-child"),n=document.createElement("th");n.style.width="40px";const s=document.createElement("input");s.type="checkbox",s.className="form-check-input",s.dataset.selectAll="true",n.appendChild(s),a.insertBefore(n,a.firstChild);t.querySelectorAll("tbody tr").forEach(e=>{const t=document.createElement("td"),a=document.createElement("input");a.type="checkbox",a.className="form-check-input",a.dataset.itemCheckbox="true",a.value=e.dataset.id||"",t.appendChild(a),e.insertBefore(t,e.firstChild),e.dataset.selectable="true"})}initInlineEditing(){document.addEventListener("dblclick",e=>{const t=e.target.closest("td[data-editable]");t&&!t.querySelector("input")&&this.makeEditable(t)})}makeEditable(e){const t=e.textContent,a=document.createElement("input");a.type="text",a.className="form-control form-control-sm",a.value=t,e.textContent="",e.appendChild(a),a.focus(),a.select();const n=()=>{const n=a.value;e.textContent=n,n!==t&&this.saveEdit(e,n)};a.addEventListener("blur",n),a.addEventListener("keydown",a=>{"Enter"===a.key?n():"Escape"===a.key&&(e.textContent=t)})}async saveEdit(e,t){const a=e.closest("tr"),n=e.dataset.field,s=a.dataset.id;if(n&&s)try{if(!(await fetch(`/api/v1/tasks/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({[n]:t})})).ok)throw new Error("Save failed");e.classList.add("table-success"),setTimeout(()=>e.classList.remove("table-success"),2e3)}catch(t){console.error("Edit save error:",t),e.classList.add("table-danger"),setTimeout(()=>e.classList.remove("table-danger"),2e3)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.tableEnhancements=new TableEnhancements}):window.tableEnhancements=new TableEnhancements,window.TableEnhancements=TableEnhancements;