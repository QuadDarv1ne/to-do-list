class KeyboardShortcuts{constructor(){this.shortcuts=new Map,this.commandPalette=null,this.isCommandPaletteOpen=!1,this.recentCommands=this.loadRecentCommands(),this.init()}init(){this.registerDefaultShortcuts(),this.createCommandPalette(),this.bindEvents(),this.loadCustomShortcuts()}registerDefaultShortcuts(){this.register("g d","Перейти на панель управления",()=>{window.location.href="/dashboard"},"navigation"),this.register("g t","Перейти к задачам",()=>{window.location.href="/task"},"navigation"),this.register("g k","Перейти к канбан доске",()=>{window.location.href="/kanban"},"navigation"),this.register("g c","Перейти к календарю",()=>{window.location.href="/calendar"},"navigation"),this.register("g p","Перейти к профилю",()=>{window.location.href="/profile"},"navigation"),this.register("n","Создать новую задачу",()=>{const e=document.getElementById("quick-task-fab");e&&e.click()},"actions"),this.register("/","Поиск",()=>{const e=document.querySelector("[data-quick-search]");e&&e.focus()},"actions"),this.register("?","Показать горячие клавиши",()=>{this.showHelp()},"help"),this.register("ctrl+k","Открыть командную палитру",e=>{e.preventDefault(),this.toggleCommandPalette()},"system"),this.register("cmd+k","Открыть командную палитру",e=>{e.preventDefault(),this.toggleCommandPalette()},"system"),this.register("ctrl+s","Сохранить",e=>{e.preventDefault();const t=document.querySelector('[data-save-btn], button[type="submit"]');t&&t.click()},"editing"),this.register("cmd+s","Сохранить",e=>{e.preventDefault();const t=document.querySelector('[data-save-btn], button[type="submit"]');t&&t.click()},"editing"),this.register("esc","Закрыть модальное окно",()=>{const e=document.querySelector(".modal.show");if(e){const t=bootstrap.Modal.getInstance(e);t&&t.hide()}},"system"),this.register("ctrl+a","Выбрать все",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName){e.preventDefault();document.querySelectorAll("[data-item-checkbox]").forEach(e=>e.checked=!0),window.dispatchEvent(new Event("selectionchange"))}},"selection"),this.register("ctrl+shift+t","Переключить тему",e=>{e.preventDefault();const t=document.querySelector(".theme-toggle-btn");t&&t.click()},"system")}register(e,t,n,a="general"){const o=this.normalizeKey(e);this.shortcuts.set(o,{key:o,originalKey:e,description:t,callback:n,category:a,enabled:!0})}normalizeKey(e){return e.toLowerCase().replace("command","cmd").replace("control","ctrl").trim()}bindEvents(){let e=[],t=null;document.addEventListener("keydown",n=>{if(!("INPUT"!==n.target.tagName&&"TEXTAREA"!==n.target.tagName||n.ctrlKey||n.metaKey||n.altKey||"Escape"===n.key))return;const a=[];n.ctrlKey&&a.push("ctrl"),n.metaKey&&a.push("cmd"),n.altKey&&a.push("alt"),n.shiftKey&&n.key.length>1&&a.push("shift");const o=n.key.toLowerCase();"control"!==o&&"meta"!==o&&"alt"!==o&&"shift"!==o&&a.push(o);const s=a.join("+"),i=this.shortcuts.get(s);if(i&&i.enabled)return i.callback(n),void this.addToRecentCommands(i);if(!n.ctrlKey&&!n.metaKey&&!n.altKey&&1===o.length){e.push(o),clearTimeout(t),t=setTimeout(()=>{e=[]},1e3);const a=e.join(" "),s=this.shortcuts.get(a);s&&s.enabled&&(n.preventDefault(),s.callback(n),this.addToRecentCommands(s),e=[],clearTimeout(t))}})}createCommandPalette(){const e=document.createElement("div");e.id="command-palette",e.className="command-palette",e.innerHTML='\n            <div class="command-palette-backdrop"></div>\n            <div class="command-palette-container">\n                <div class="command-palette-header">\n                    <input type="text" \n                           class="command-palette-input" \n                           placeholder="Введите команду или поиск..."\n                           autocomplete="off">\n                </div>\n                <div class="command-palette-content">\n                    <div class="command-palette-section">\n                        <div class="command-palette-section-title">Недавние команды</div>\n                        <div class="command-palette-recent"></div>\n                    </div>\n                    <div class="command-palette-section">\n                        <div class="command-palette-section-title">Все команды</div>\n                        <div class="command-palette-commands"></div>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e),this.commandPalette=e,this.addCommandPaletteStyles(),this.setupCommandPaletteEvents()}addCommandPaletteStyles(){if(document.getElementById("commandPaletteStyles"))return;const e=document.createElement("style");e.id="commandPaletteStyles",e.textContent="\n            .command-palette {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 9999;\n                display: none;\n            }\n\n            .command-palette.show {\n                display: block;\n                animation: fadeIn 0.2s ease-out;\n            }\n\n            .command-palette-backdrop {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.5);\n                backdrop-filter: blur(4px);\n            }\n\n            .command-palette-container {\n                position: absolute;\n                top: 20%;\n                left: 50%;\n                transform: translateX(-50%);\n                width: 90%;\n                max-width: 600px;\n                background: var(--bg-card);\n                border-radius: var(--radius-lg);\n                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n                overflow: hidden;\n            }\n\n            .command-palette-header {\n                padding: 1rem;\n                border-bottom: 1px solid var(--border);\n            }\n\n            .command-palette-input {\n                width: 100%;\n                padding: 0.75rem;\n                border: none;\n                background: var(--bg-body);\n                color: var(--text-primary);\n                font-size: 1rem;\n                border-radius: var(--radius);\n                outline: none;\n            }\n\n            .command-palette-input:focus {\n                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n            }\n\n            .command-palette-content {\n                max-height: 400px;\n                overflow-y: auto;\n                padding: 0.5rem;\n            }\n\n            .command-palette-section {\n                margin-bottom: 1rem;\n            }\n\n            .command-palette-section-title {\n                font-size: 0.75rem;\n                font-weight: 600;\n                color: var(--text-muted);\n                text-transform: uppercase;\n                padding: 0.5rem 0.75rem;\n                letter-spacing: 0.5px;\n            }\n\n            .command-palette-item {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 0.75rem;\n                border-radius: var(--radius);\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            .command-palette-item:hover,\n            .command-palette-item.selected {\n                background: var(--primary);\n                color: white;\n            }\n\n            .command-palette-item-left {\n                display: flex;\n                align-items: center;\n                gap: 0.75rem;\n            }\n\n            .command-palette-item-icon {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                background: rgba(102, 126, 234, 0.1);\n                border-radius: var(--radius);\n                font-size: 0.875rem;\n            }\n\n            .command-palette-item:hover .command-palette-item-icon {\n                background: rgba(255, 255, 255, 0.2);\n            }\n\n            .command-palette-item-info {\n                display: flex;\n                flex-direction: column;\n            }\n\n            .command-palette-item-title {\n                font-weight: 500;\n                font-size: 0.875rem;\n            }\n\n            .command-palette-item-category {\n                font-size: 0.75rem;\n                opacity: 0.7;\n            }\n\n            .command-palette-item-shortcut {\n                display: flex;\n                gap: 0.25rem;\n            }\n\n            .command-palette-key {\n                padding: 0.125rem 0.5rem;\n                background: rgba(0, 0, 0, 0.1);\n                border-radius: 4px;\n                font-size: 0.75rem;\n                font-family: monospace;\n            }\n\n            .command-palette-item:hover .command-palette-key {\n                background: rgba(255, 255, 255, 0.2);\n            }\n\n            .command-palette-empty {\n                padding: 2rem;\n                text-align: center;\n                color: var(--text-muted);\n            }\n\n            @keyframes fadeIn {\n                from {\n                    opacity: 0;\n                }\n                to {\n                    opacity: 1;\n                }\n            }\n        ",document.head.appendChild(e)}setupCommandPaletteEvents(){const e=this.commandPalette.querySelector(".command-palette-input");this.commandPalette.querySelector(".command-palette-backdrop").addEventListener("click",()=>{this.closeCommandPalette()}),e.addEventListener("input",e=>{this.filterCommands(e.target.value)}),e.addEventListener("keydown",e=>{"Escape"===e.key?this.closeCommandPalette():"ArrowDown"===e.key?(e.preventDefault(),this.selectNextCommand()):"ArrowUp"===e.key?(e.preventDefault(),this.selectPreviousCommand()):"Enter"===e.key&&(e.preventDefault(),this.executeSelectedCommand())})}toggleCommandPalette(){this.isCommandPaletteOpen?this.closeCommandPalette():this.openCommandPalette()}openCommandPalette(){this.commandPalette.classList.add("show"),this.isCommandPaletteOpen=!0;const e=this.commandPalette.querySelector(".command-palette-input");e.value="",e.focus(),this.renderCommands()}closeCommandPalette(){this.commandPalette.classList.remove("show"),this.isCommandPaletteOpen=!1}renderCommands(e=""){const t=this.commandPalette.querySelector(".command-palette-recent"),n=this.commandPalette.querySelector(".command-palette-commands");this.recentCommands.length>0&&!e?t.innerHTML=this.recentCommands.slice(0,5).map(e=>this.renderCommandItem(e)).join(""):t.innerHTML="";const a=Array.from(this.shortcuts.values()).filter(t=>{if(!e)return!0;const n=e.toLowerCase();return t.description.toLowerCase().includes(n)||t.category.toLowerCase().includes(n)});a.length>0?n.innerHTML=a.map(e=>this.renderCommandItem(e)).join(""):n.innerHTML='<div class="command-palette-empty">Команды не найдены</div>',this.commandPalette.querySelectorAll(".command-palette-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.key,n=this.shortcuts.get(t);n&&(n.callback(new Event("click")),this.addToRecentCommands(n),this.closeCommandPalette())})})}renderCommandItem(e){const t=this.getCategoryIcon(e.category),n=e.originalKey.split("+").map(e=>`<span class="command-palette-key">${e}</span>`).join("");return`\n            <div class="command-palette-item" data-key="${e.key}">\n                <div class="command-palette-item-left">\n                    <div class="command-palette-item-icon">\n                        <i class="fas fa-${t}"></i>\n                    </div>\n                    <div class="command-palette-item-info">\n                        <div class="command-palette-item-title">${e.description}</div>\n                        <div class="command-palette-item-category">${e.category}</div>\n                    </div>\n                </div>\n                <div class="command-palette-item-shortcut">${n}</div>\n            </div>\n        `}getCategoryIcon(e){return{navigation:"compass",actions:"bolt",editing:"edit",selection:"check-square",system:"cog",help:"question-circle"}[e]||"star"}filterCommands(e){this.renderCommands(e)}selectNextCommand(){const e=this.commandPalette.querySelectorAll(".command-palette-item"),t=this.commandPalette.querySelector(".command-palette-item.selected");if(!t&&e.length>0)e[0].classList.add("selected"),e[0].scrollIntoView({block:"nearest"});else if(t){const n=Array.from(e).indexOf(t);n<e.length-1&&(t.classList.remove("selected"),e[n+1].classList.add("selected"),e[n+1].scrollIntoView({block:"nearest"}))}}selectPreviousCommand(){const e=this.commandPalette.querySelectorAll(".command-palette-item"),t=this.commandPalette.querySelector(".command-palette-item.selected");if(t){const n=Array.from(e).indexOf(t);n>0&&(t.classList.remove("selected"),e[n-1].classList.add("selected"),e[n-1].scrollIntoView({block:"nearest"}))}}executeSelectedCommand(){const e=this.commandPalette.querySelector(".command-palette-item.selected");if(e)e.click();else{const e=this.commandPalette.querySelector(".command-palette-item");e&&e.click()}}addToRecentCommands(e){this.recentCommands=this.recentCommands.filter(t=>t.key!==e.key),this.recentCommands.unshift(e),this.recentCommands=this.recentCommands.slice(0,10),this.saveRecentCommands()}loadRecentCommands(){try{const e=localStorage.getItem("recentCommands");return e?JSON.parse(e):[]}catch(e){return[]}}saveRecentCommands(){try{localStorage.setItem("recentCommands",JSON.stringify(this.recentCommands))}catch(e){console.error("Failed to save recent commands:",e)}}loadCustomShortcuts(){try{const e=localStorage.getItem("customShortcuts");if(e){JSON.parse(e).forEach(e=>{this.register(e.key,e.description,new Function(e.callback),e.category)})}}catch(e){console.error("Failed to load custom shortcuts:",e)}}showHelp(){const e={};this.shortcuts.forEach(t=>{e[t.category]||(e[t.category]=[]),e[t.category].push(t)});const t=Object.entries(e).map(([e,t])=>`\n            <div class="mb-4">\n                <h6 class="text-uppercase text-muted mb-3">${e}</h6>\n                <div class="row">\n                    ${t.map(e=>`\n                        <div class="col-md-6 mb-2">\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span>${e.description}</span>\n                                <kbd class="kbd-shortcut">${e.originalKey}</kbd>\n                            </div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `).join(""),n=document.createElement("div");n.className="modal fade",n.innerHTML=`\n            <div class="modal-dialog modal-lg">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title">\n                            <i class="fas fa-keyboard me-2"></i>\n                            Горячие клавиши\n                        </h5>\n                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                    </div>\n                    <div class="modal-body">\n                        ${t}\n                        <div class="alert alert-info mt-3">\n                            <i class="fas fa-info-circle me-2"></i>\n                            Нажмите <kbd>Ctrl+K</kbd> или <kbd>Cmd+K</kbd> чтобы открыть командную палитру\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(n);new bootstrap.Modal(n).show(),n.addEventListener("hidden.bs.modal",()=>{n.remove()})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.keyboardShortcuts=new KeyboardShortcuts}):window.keyboardShortcuts=new KeyboardShortcuts,window.KeyboardShortcuts=KeyboardShortcuts;