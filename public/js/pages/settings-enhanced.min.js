function initSettingsPage(){initSettingsTabs(),initFormValidation(),initPasswordToggle(),initAvatarUpload(),initNotificationSettings(),initThemeSettings(),initShortcutSettings()}function initSettingsTabs(){const t=document.querySelectorAll(".settings-tab"),e=document.querySelectorAll(".settings-panel");t.forEach(i=>{i.addEventListener("click",function(){const i=this.dataset.target;t.forEach(t=>t.classList.remove("active")),this.classList.add("active"),e.forEach(t=>{t.classList.toggle("active",t.id===i)}),localStorage.setItem("activeSettingsTab",i)})});const i=localStorage.getItem("activeSettingsTab");if(i){const t=document.querySelector(`[data-target="${i}"]`);t&&t.click()}}function initFormValidation(){document.querySelectorAll(".needs-validation").forEach(t=>{t.addEventListener("submit",function(e){t.checkValidity()||(e.preventDefault(),e.stopPropagation()),t.classList.add("was-validated")})})}function initPasswordToggle(){document.querySelectorAll(".password-toggle").forEach(t=>{t.addEventListener("click",function(){const t=this.previousElementSibling,e=this.querySelector("i");"password"===t.type?(t.type="text",e.classList.remove("fa-eye"),e.classList.add("fa-eye-slash")):(t.type="password",e.classList.remove("fa-eye-slash"),e.classList.add("fa-eye"))})})}function initAvatarUpload(){const t=document.getElementById("avatar-upload"),e=document.getElementById("avatar-preview");if(!t||!e)return;t.addEventListener("change",function(t){const i=t.target.files[0];if(i){if(!i.type.startsWith("image/"))return void showToast("Пожалуйста, выберите изображение","error");if(i.size>5242880)return void showToast("Размер файла не должен превышать 5 МБ","error");const t=new FileReader;t.onload=function(t){e.src=t.target.result,e.style.display="block"},t.readAsDataURL(i)}});const i=document.getElementById("avatar-drop-zone");i&&(i.addEventListener("dragover",function(t){t.preventDefault(),this.classList.add("drag-over")}),i.addEventListener("dragleave",function(){this.classList.remove("drag-over")}),i.addEventListener("drop",function(e){e.preventDefault(),this.classList.remove("drag-over");e.dataTransfer.files[0]&&(t.files=e.dataTransfer.files,t.dispatchEvent(new Event("change")))}))}function initNotificationSettings(){document.querySelectorAll(".notification-toggle").forEach(t=>{t.addEventListener("change",function(){saveNotificationSetting(this.dataset.setting,this.checked)})})}async function saveNotificationSetting(t,e){try{const i=await fetch("/api/settings/notifications",{method:"PATCH",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({[t]:e})});(await i.json()).success?showToast("Настройки сохранены","success"):showToast("Ошибка сохранения настроек","error")}catch(t){console.error("Error saving notification setting:",t),showToast("Ошибка сохранения настроек","error")}}function initThemeSettings(){if(document.querySelectorAll('input[name="theme"]').forEach(t=>{t.addEventListener("change",function(){this.checked&&window.themeSwitcher&&window.themeSwitcher.applyTheme(this.value,!0)})}),window.themeSwitcher){const t=window.themeSwitcher.getTheme(),e=document.querySelector(`input[name="theme"][value="${t}"]`);e&&(e.checked=!0)}}function initShortcutSettings(){document.querySelectorAll(".shortcut-input").forEach(t=>{t.addEventListener("keydown",function(t){t.preventDefault();const e=[];t.ctrlKey&&e.push("Ctrl"),t.altKey&&e.push("Alt"),t.shiftKey&&e.push("Shift"),t.metaKey&&e.push("Cmd"),t.key&&!["Control","Alt","Shift","Meta"].includes(t.key)&&e.push(t.key.toUpperCase()),this.value=e.join(" + ")})});const t=document.getElementById("save-shortcuts");t&&t.addEventListener("click",function(){saveShortcuts()})}async function saveShortcuts(){const t={};document.querySelectorAll(".shortcut-input").forEach(e=>{const i=e.dataset.action;t[i]=e.value});try{const e=await fetch("/api/settings/shortcuts",{method:"PATCH",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({shortcuts:t})});(await e.json()).success?showToast("Горячие клавиши сохранены","success"):showToast("Ошибка сохранения горячих клавиш","error")}catch(t){console.error("Error saving shortcuts:",t),showToast("Ошибка сохранения горячих клавиш","error")}}document.addEventListener("DOMContentLoaded",function(){initSettingsPage()}),window.SettingsEnhanced={saveNotificationSetting:saveNotificationSetting,saveShortcuts:saveShortcuts};