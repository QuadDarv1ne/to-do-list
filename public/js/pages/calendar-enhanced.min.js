function initCalendar(){initCalendarNavigation(),initDaySelection(),initEventActions(),initQuickEventAdd(),initThemeAwareCalendar()}function initCalendarNavigation(){const e=document.getElementById("calendar-prev"),t=document.getElementById("calendar-next"),n=document.getElementById("calendar-today");e&&e.addEventListener("click",function(){navigateMonth(-1)}),t&&t.addEventListener("click",function(){navigateMonth(1)}),n&&n.addEventListener("click",function(){navigateToToday()})}function navigateMonth(e){const t=getCurrentCalendarDate(),n=new Date(t);n.setMonth(n.getMonth()+e),loadCalendar(n)}function navigateToToday(){loadCalendar(new Date)}function getCurrentCalendarDate(){const e=document.querySelector(".calendar-title");if(!e)return new Date;e.textContent.trim();return new Date}function loadCalendar(e){const t=e.getFullYear(),n=e.getMonth()+1;fetch(`/calendar/data?year=${t}&month=${n}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{updateCalendarView(e)}).catch(e=>{console.error("Error loading calendar:",e),showToast("Ошибка загрузки календаря","error")})}function updateCalendarView(e){const t=document.querySelector(".calendar-title"),n=document.querySelector(".calendar-grid");t&&(t.textContent=e.title),n&&e.days&&renderCalendarDays(n,e.days)}function renderCalendarDays(e,t){e.querySelectorAll(".calendar-day").forEach(e=>e.remove()),t.forEach(t=>{const n=createDayElement(t);e.appendChild(n)})}function createDayElement(e){const t=document.createElement("div");t.className="calendar-day",e.isToday&&t.classList.add("today"),e.isOtherMonth&&t.classList.add("other-month"),t.dataset.date=e.date;let n=`<div class="calendar-day-number">${e.number}</div>`;return e.events&&e.events.length>0&&(n+='<div class="calendar-day-events">',e.events.forEach(e=>{n+=`<div class="calendar-event" data-event-id="${e.id}" title="${e.title}">${e.title}</div>`}),n+="</div>"),t.innerHTML=n,t}function initDaySelection(){document.addEventListener("click",function(e){const t=e.target.closest(".calendar-day");if(!t)return;const n=t.dataset.date;n&&showDayDetails(n)})}function showDayDetails(e){fetch(`/calendar/day/${e}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{showDayModal(e)}).catch(e=>{console.error("Error loading day details:",e),showToast("Ошибка загрузки деталей дня","error")})}function showDayModal(e){let t=document.getElementById("day-details-modal");t||(t=document.createElement("div"),t.id="day-details-modal",t.className="modal fade",document.body.appendChild(t)),t.innerHTML=`\n        <div class="modal-dialog">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h5 class="modal-title">${e.title}</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                </div>\n                <div class="modal-body">\n                    ${e.events&&e.events.length>0?`\n                        <div class="list-group">\n                            ${e.events.map(e=>`\n                                <div class="list-group-item">\n                                    <div class="d-flex justify-content-between align-items-start">\n                                        <div>\n                                            <h6 class="mb-1">${e.title}</h6>\n                                            <small class="text-muted">${e.time||""}</small>\n                                        </div>\n                                        <div class="btn-group btn-group-sm">\n                                            <a href="/task/${e.id}" class="btn btn-outline-primary">\n                                                <i class="fas fa-eye"></i>\n                                            </a>\n                                            <a href="/task/${e.id}/edit" class="btn btn-outline-secondary">\n                                                <i class="fas fa-edit"></i>\n                                            </a>\n                                        </div>\n                                    </div>\n                                </div>\n                            `).join("")}\n                        </div>\n                    `:'<p class="text-muted">Нет событий на этот день</p>'}\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>\n                    <a href="/task/new?date=${e.date}" class="btn btn-primary">\n                        <i class="fas fa-plus me-2"></i>Добавить задачу\n                    </a>\n                </div>\n            </div>\n        </div>\n    `;new bootstrap.Modal(t).show()}function initEventActions(){document.addEventListener("click",function(e){const t=e.target.closest(".calendar-event");if(!t)return;e.stopPropagation();const n=t.dataset.eventId;n&&(window.location.href=`/task/${n}`)})}function initQuickEventAdd(){const e=document.getElementById("quick-event-add");e&&e.addEventListener("click",function(){showQuickEventForm()})}function showQuickEventForm(){window.location.href="/task/new"}function initThemeAwareCalendar(){window.addEventListener("themechange",function(e){updateCalendarColors(e.detail.theme)})}function updateCalendarColors(e){document.querySelectorAll(".calendar-day")}document.addEventListener("DOMContentLoaded",function(){initCalendar()}),window.CalendarEnhanced={navigateMonth:navigateMonth,navigateToToday:navigateToToday,showDayDetails:showDayDetails};