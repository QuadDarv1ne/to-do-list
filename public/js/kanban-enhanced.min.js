function initKanbanBoard(){initDragAndDrop(),initCardActions(),initColumnActions(),initQuickAdd(),initThemeAwareKanban()}function initDragAndDrop(){const t=document.querySelectorAll(".kanban-card"),e=document.querySelectorAll(".kanban-column");t.forEach(t=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",function(t){this.classList.add("dragging"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",this.innerHTML),t.dataTransfer.setData("taskId",this.dataset.taskId)}),t.addEventListener("dragend",function(){this.classList.remove("dragging")})}),e.forEach(t=>{const e=t.querySelector(".kanban-cards");e&&(e.addEventListener("dragover",function(t){t.preventDefault();const n=document.querySelector(".dragging"),a=getDragAfterElement(e,t.clientY);null==a?e.appendChild(n):e.insertBefore(n,a)}),e.addEventListener("drop",function(e){e.preventDefault();const n=e.dataTransfer.getData("taskId"),a=t.dataset.status;n&&a&&updateTaskStatus(n,a)}))})}function getDragAfterElement(t,e){return[...t.querySelectorAll(".kanban-card:not(.dragging)")].reduce((t,n)=>{const a=n.getBoundingClientRect(),o=e-a.top-a.height/2;return o<0&&o>t.offset?{offset:o,element:n}:t},{offset:Number.NEGATIVE_INFINITY}).element}function updateTaskStatus(t,e){fetch(`/api/v1/tasks/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({status:e})}).then(t=>t.json()).then(t=>{t.success?(showToast("Статус задачи обновлен","success"),updateColumnCounts()):(showToast("Ошибка обновления статуса","error"),location.reload())}).catch(t=>{console.error("Error:",t),showToast("Ошибка обновления статуса","error"),location.reload()})}function initCardActions(){document.querySelectorAll('[data-action="edit"]').forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=this.closest(".kanban-card").dataset.taskId;window.location.href=`/task/${e}/edit`})});document.querySelectorAll('[data-action="delete"]').forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=this.closest(".kanban-card").dataset.taskId;confirm("Удалить задачу?")&&deleteTask(e)})});document.querySelectorAll(".kanban-card").forEach(t=>{t.addEventListener("click",function(t){if(t.target.closest("button")||t.target.closest("a"))return;const e=this.dataset.taskId;window.location.href=`/task/${e}`})})}function deleteTask(t){fetch(`/api/v1/tasks/${t}`,{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(t=>t.json()).then(e=>{if(e.success){showToast("Задача удалена","success");const e=document.querySelector(`[data-task-id="${t}"]`);e&&(e.style.animation="fadeOut 0.3s ease",setTimeout(()=>{e.remove(),updateColumnCounts()},300))}else showToast("Ошибка удаления задачи","error")}).catch(t=>{console.error("Error:",t),showToast("Ошибка удаления задачи","error")})}function initColumnActions(){document.querySelectorAll('[data-action="collapse"]').forEach(t=>{t.addEventListener("click",function(){const t=this.closest(".kanban-column");t.classList.toggle("collapsed");const e=this.querySelector("i");t.classList.contains("collapsed")?(e.classList.remove("fa-minus"),e.classList.add("fa-plus")):(e.classList.remove("fa-plus"),e.classList.add("fa-minus"))})})}function initQuickAdd(){document.querySelectorAll('[data-action="quick-add"]').forEach(t=>{t.addEventListener("click",function(){const t=this.closest(".kanban-column");showQuickAddForm(t,t.dataset.status)})})}function showQuickAddForm(t,e){const n=t.querySelector(".kanban-cards"),a=t.querySelector(".quick-add-form");if(a)return void a.remove();const o=document.createElement("div");o.className="quick-add-form",o.innerHTML='\n        <input type="text" class="form-control mb-2" placeholder="Название задачи..." id="quick-task-title">\n        <div class="d-flex gap-2">\n            <button class="btn btn-sm btn-primary" id="quick-add-save">Добавить</button>\n            <button class="btn btn-sm btn-secondary" id="quick-add-cancel">Отмена</button>\n        </div>\n    ',n.insertBefore(o,n.firstChild);const s=o.querySelector("#quick-task-title"),c=o.querySelector("#quick-add-save"),r=o.querySelector("#quick-add-cancel");s.focus(),c.addEventListener("click",function(){const t=s.value.trim();t&&createQuickTask(t,e,o)}),r.addEventListener("click",function(){o.remove()}),s.addEventListener("keypress",function(t){"Enter"===t.key?c.click():"Escape"===t.key&&r.click()})}function createQuickTask(t,e,n){fetch("/api/v1/tasks/quick-create",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({title:t,status:e})}).then(t=>t.json()).then(t=>{t.success?(showToast("Задача создана","success"),n.remove(),location.reload()):showToast("Ошибка создания задачи","error")}).catch(t=>{console.error("Error:",t),showToast("Ошибка создания задачи","error")})}function updateColumnCounts(){document.querySelectorAll(".kanban-column").forEach(t=>{const e=t.querySelectorAll(".kanban-card"),n=t.querySelector(".column-count");n&&(n.textContent=e.length)})}function initThemeAwareKanban(){window.addEventListener("themechange",function(t){updateKanbanColors(t.detail.theme)})}function updateKanbanColors(t){document.querySelectorAll(".kanban-card")}document.addEventListener("DOMContentLoaded",function(){initKanbanBoard()}),window.KanbanEnhanced={updateTaskStatus:updateTaskStatus,deleteTask:deleteTask,updateColumnCounts:updateColumnCounts};