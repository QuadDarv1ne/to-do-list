!function(){"use strict";class e{constructor(e={}){this.options={storageKey:"dashboard_widgets_layout",animationDuration:300,...e},this.grid=null,this.widgets=[],this.draggedWidget=null,this.placeholder=null,this.isEditMode=!1,this.init()}init(){if(this.grid=document.querySelector(".dashboard-grid"),!this.grid)return;this.loadLayout(),this.widgets=Array.from(this.grid.querySelectorAll(".dashboard-widget")),this.widgets.forEach(e=>this.initWidget(e));const e=document.querySelector(".add-widget-btn");e&&e.addEventListener("click",()=>this.showWidgetPicker()),document.addEventListener("keydown",e=>{"e"===e.key&&e.altKey&&(e.preventDefault(),this.toggleEditMode())})}initWidget(e){"false"!==e.dataset.draggable&&(e.classList.add("draggable"),e.setAttribute("draggable","true"));const t=e.querySelector(".dashboard-widget-header");if(t&&!t.querySelector(".dashboard-widget-drag-handle")){const e=document.createElement("span");e.className="dashboard-widget-drag-handle me-2",e.innerHTML='<i class="fas fa-grip-vertical"></i>',t.insertBefore(e,t.firstChild)}this.addWidgetActions(e),this.addResizeHandle(e),this.bindDragEvents(e),this.bindActionEvents(e),this.loadWidgetContent(e)}addWidgetActions(e){const t=e.querySelector(".dashboard-widget-header");if(!t)return;let i=t.querySelector(".dashboard-widget-actions");i||(i=document.createElement("div"),i.className="dashboard-widget-actions",t.appendChild(i));const s=document.createElement("button");s.className="dashboard-widget-action-btn toggle",s.innerHTML='<i class="fas fa-minus toggle-icon"></i>',s.title="Свернуть",i.appendChild(s);const d=document.createElement("button");d.className="dashboard-widget-action-btn settings",d.innerHTML='<i class="fas fa-cog"></i>',d.title="Настройки",i.appendChild(d);const a=document.createElement("button");a.className="dashboard-widget-action-btn remove",a.innerHTML='<i class="fas fa-times"></i>',a.title="Удалить",i.appendChild(a)}addResizeHandle(e){const t=document.createElement("div");t.className="dashboard-widget-resize-handle",e.appendChild(t),this.bindResizeEvents(e,t)}bindDragEvents(e){e.addEventListener("dragstart",t=>this.handleDragStart(t,e)),e.addEventListener("dragend",t=>this.handleDragEnd(t,e)),e.addEventListener("dragover",t=>this.handleDragOver(t,e)),e.addEventListener("dragleave",t=>this.handleDragLeave(t,e)),e.addEventListener("drop",t=>this.handleDrop(t,e))}bindActionEvents(e){const t=e.querySelector(".dashboard-widget-action-btn.toggle"),i=e.querySelector(".dashboard-widget-action-btn.settings"),s=e.querySelector(".dashboard-widget-action-btn.remove");t&&t.addEventListener("click",()=>this.toggleWidget(e)),i&&i.addEventListener("click",()=>this.showWidgetSettings(e)),s&&s.addEventListener("click",()=>this.removeWidget(e))}bindResizeEvents(e,t){let i,s,d=!1;t.addEventListener("mousedown",t=>{this.isEditMode&&(d=!0,i=t.clientX,s=e.offsetWidth,e.style.transition="none",document.addEventListener("mousemove",a),document.addEventListener("mouseup",n))});const a=t=>{if(!d)return;const a=t.clientX-i,n=s+a;n>300&&(e.style.width=n+"px")},n=()=>{d=!1,e.style.transition="",e.style.width="",document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",n),this.saveLayout()}}handleDragStart(e,t){this.isEditMode?(this.draggedWidget=t,t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.dataset.widgetId),this.placeholder=document.createElement("div"),this.placeholder.className="dashboard-widget-placeholder",this.placeholder.style.height=t.offsetHeight+"px"):e.preventDefault()}handleDragEnd(e,t){t.classList.remove("dragging"),this.draggedWidget=null,this.placeholder&&(this.placeholder.remove(),this.placeholder=null),this.saveLayout()}handleDragOver(e,t){if(!this.isEditMode||!this.draggedWidget)return;e.preventDefault(),e.dataTransfer.dropEffect="move";const i=t.getBoundingClientRect(),s=i.top+i.height/2;e.clientY<s?this.grid.insertBefore(this.placeholder,t):this.grid.insertBefore(this.placeholder,t.nextSibling)}handleDragLeave(e,t){}handleDrop(e,t){if(!this.isEditMode||!this.draggedWidget)return;e.preventDefault();const i=t.getBoundingClientRect(),s=i.top+i.height/2;e.clientY<s?this.grid.insertBefore(this.draggedWidget,t):this.grid.insertBefore(this.draggedWidget,t.nextSibling),this.saveLayout()}toggleWidget(e){const t=e.classList.contains("collapsed"),i=e.querySelector(".toggle-icon");t?(e.classList.remove("collapsed"),e.classList.add("maximizing"),i.style.transform="",setTimeout(()=>{e.classList.remove("maximizing")},this.options.animationDuration)):(e.classList.add("collapsed"),e.classList.add("minimizing"),i.style.transform="rotate(-90deg)",setTimeout(()=>{e.classList.remove("minimizing")},this.options.animationDuration)),this.saveWidgetState(e.dataset.widgetId,{collapsed:!t})}removeWidget(e){confirm("Удалить этот виджет с дашборда?")&&(e.classList.add("minimizing"),setTimeout(()=>{e.remove(),this.saveLayout()},this.options.animationDuration))}showWidgetSettings(e){const t=e.dataset.widgetId,i=e.dataset.widgetType;console.log("Settings for widget:",t,i)}showWidgetPicker(){console.log("Available widgets:",[{id:"tasks-summary",name:"Сводка задач",icon:"fa-tasks",type:"stats"},{id:"activity-chart",name:"График активности",icon:"fa-chart-line",type:"chart"},{id:"recent-tasks",name:"Последние задачи",icon:"fa-list",type:"list"},{id:"calendar",name:"Календарь",icon:"fa-calendar",type:"calendar"},{id:"goals",name:"Цели",icon:"fa-bullseye",type:"stats"},{id:"habits",name:"Привычки",icon:"fa-fire",type:"stats"}])}toggleEditMode(){this.isEditMode=!this.isEditMode,this.widgets.forEach(e=>{this.isEditMode?(e.classList.add("draggable"),e.setAttribute("draggable","true")):(e.classList.remove("draggable"),e.removeAttribute("draggable"))}),showToast(this.isEditMode?"Режим редактирования включён":"Режим редактирования выключен","info")}saveLayout(){const e={widgets:this.widgets.map((e,t)=>({id:e.dataset.widgetId,position:t,size:e.dataset.size||"medium",collapsed:e.classList.contains("collapsed")}))};localStorage.setItem(this.options.storageKey,JSON.stringify(e))}loadLayout(){const e=localStorage.getItem(this.options.storageKey);if(e)try{JSON.parse(e).widgets.forEach(({id:e,position:t})=>{const i=this.grid.querySelector(`[data-widget-id="${e}"]`);if(i){const e=Array.from(this.grid.children),s=t;e[s]?this.grid.insertBefore(i,e[s]):this.grid.appendChild(i)}})}catch(e){console.error("Failed to load layout:",e)}}saveWidgetState(e,t){const i=localStorage.getItem(this.options.storageKey);let s=i?JSON.parse(i):{widgets:[]};const d=s.widgets.findIndex(t=>t.id===e);-1!==d?s.widgets[d]={...s.widgets[d],...t}:s.widgets.push({id:e,...t}),localStorage.setItem(this.options.storageKey,JSON.stringify(s))}async loadWidgetContent(e){const t=e.dataset.contentUrl;if(!t)return;const i=e.querySelector(".dashboard-widget-body");if(i)try{const e=await fetch(t);e.ok&&(i.innerHTML=await e.text())}catch(e){console.error("Failed to load widget content:",e),i.innerHTML='<div class="text-muted">Не удалось загрузить данные</div>'}}addWidget(e){const t=document.createElement("div");t.className="dashboard-widget",t.dataset.widgetId=e.id,t.dataset.widgetType=e.type,t.dataset.size=e.size||"medium",t.innerHTML=`\n                <div class="dashboard-widget-header">\n                    <h5 class="dashboard-widget-title">\n                        <i class="fas ${e.icon||"fa-box"}"></i>\n                        ${e.name}\n                    </h5>\n                </div>\n                <div class="dashboard-widget-body">\n                    <div class="dashboard-widget-loading">\n                        <div class="spinner-border" role="status">\n                            <span class="visually-hidden">Загрузка...</span>\n                        </div>\n                    </div>\n                </div>\n            `,this.grid.appendChild(t),this.initWidget(t),this.saveLayout()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.DashboardWidgets=new e}):window.DashboardWidgets=new e,window.DashboardWidgetsClass=e}();