#!/bin/bash

# Pre-commit hook for code quality
# Automatically runs checks before each commit

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# PHP CS Fixer (dry run)
echo -e "\n${YELLOW}Checking PHP code style...${NC}"
if ! composer cs --quiet; then
    echo -e "${RED}‚úó PHP CS Fixer failed${NC}"
    echo "Run 'composer cs:fix' to automatically fix issues"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì PHP CS Fixer passed${NC}"
fi

# PHPStan
echo -e "\n${YELLOW}Running static analysis...${NC}"
if ! composer phpstan --quiet; then
    echo -e "${RED}‚úó PHPStan found errors${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì PHPStan passed${NC}"
fi

# PHPUnit (quick test)
echo -e "\n${YELLOW}Running tests...${NC}"
if ! composer test --quiet; then
    echo -e "${RED}‚úó Tests failed${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì Tests passed${NC}"
fi

# Check for debug statements
echo -e "\n${YELLOW}Checking for debug statements...${NC}"
DEBUG_FOUND=$(grep -r "dump\|dd\|var_dump\|print_r\|console.log" src/ --include="*.php" --include="*.js" 2>/dev/null | grep -v ".git" || true)
if [ -n "$DEBUG_FOUND" ]; then
    echo -e "${RED}‚úó Debug statements found:${NC}"
    echo "$DEBUG_FOUND"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No debug statements found${NC}"
fi

# Final result
echo ""
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå $ERRORS check(s) failed. Please fix before committing.${NC}"
    exit 1
fi
