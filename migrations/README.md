# Миграции базы данных

## Текущее состояние

В проекте 35 миграций, которые были созданы в процессе разработки.
Все миграции выполнены и база данных находится в актуальном состоянии.

## Важно

⚠️ **НЕ УДАЛЯЙТЕ** файлы миграций из этой папки, если они уже выполнены в продакшене!

Удаление выполненных миграций может привести к проблемам при развертывании на других серверах.

## Для новых установок

Если вы хотите начать с чистой базы данных и одной консолидированной миграцией:

### Windows:
```bash
bin\reset-migrations.bat
```

### Linux/Mac:
```bash
chmod +x bin/reset-migrations.sh
./bin/reset-migrations.sh
```

Этот скрипт:
1. Создаст резервную копию текущей базы данных
2. Удалит все таблицы
3. Удалит старые миграции
4. Создаст одну новую миграцию с текущей схемой
5. Выполнит её
6. Создаст тестовых пользователей

## Структура базы данных

Основные таблицы:
- `users` - пользователи системы
- `tasks` - задачи
- `task_categories` - категории задач
- `tags` - теги
- `comments` - комментарии
- `notifications` - уведомления
- `task_notifications` - уведомления по задачам
- `task_dependencies` - зависимости между задачами
- `task_recurrence` - повторяющиеся задачи
- `task_time_tracking` - учет времени
- `activity_logs` - логи активности
- `event_store` - хранилище событий
- `reset_password_request` - запросы на сброс пароля

## Индексы

Все критичные поля проиндексированы для оптимальной производительности:
- `idx_task_user_status` - поиск задач по пользователю и статусу
- `idx_task_assigned_user_status` - поиск назначенных задач
- `idx_task_due_date_status` - поиск по дедлайну
- `idx_task_category` - поиск по категории
- `idx_task_priority` - поиск по приоритету
- И другие...

## Команды для работы с миграциями

```bash
# Просмотр статуса миграций
php bin/console doctrine:migrations:status

# Список всех миграций
php bin/console doctrine:migrations:list

# Создание новой миграции
php bin/console doctrine:migrations:diff

# Выполнение миграций
php bin/console doctrine:migrations:migrate

# Откат последней миграции
php bin/console doctrine:migrations:migrate prev

# Синхронизация метаданных
php bin/console doctrine:migrations:sync-metadata-storage
```

## История изменений

- **2026-01-28**: Начальная миграция (task, messenger_messages)
- **2026-02-05 - 2026-02-09**: Добавление основных таблиц и связей
- **2026-02-12**: Оптимизация индексов для MySQL/PostgreSQL
- **2026-02-13**: Добавление связи user-tags
- **2026-02-14**: Индексы производительности
- **2026-02-17**: Event Store и финальные оптимизации

## Поддержка баз данных

Проект поддерживает:
- ✅ SQLite (по умолчанию для разработки)
- ✅ MySQL 8.0+
- ✅ PostgreSQL 13+
- ✅ MariaDB 10.5+

Все миграции совместимы с указанными СУБД.
