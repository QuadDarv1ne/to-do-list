# Requirements Document

## Introduction

Данный документ описывает требования к расширению функциональности Dashboard Analytics в CRM системе управления задачами. Цель фичи - предоставить пользователям продвинутую аналитику и интерактивные виджеты для глубокого анализа продуктивности, визуализации данных и получения инсайтов о выполнении задач, целей и привычек.

Система построена на Symfony 7.x с PostgreSQL, использует DDD архитектуру и имеет существующие модули Tasks, Goals, Habits и базовую Analytics. Новая функциональность должна органично интегрироваться с существующей архитектурой, минимизируя изменения в базе данных и обеспечивая высокую производительность.

## Glossary

- **Dashboard**: Главная панель пользователя, отображающая виджеты и аналитику
- **Widget**: Интерактивный компонент dashboard, отображающий специфическую информацию или аналитику
- **Heatmap**: Тепловая карта активности, визуализирующая интенсивность работы по дням
- **Analytics_Service**: Сервис для вычисления и агрегации аналитических данных
- **Time_Tracker**: Компонент для отслеживания времени работы над задачами
- **Achievement_System**: Система достижений и наград за выполнение целей
- **Export_Service**: Сервис для экспорта данных в различные форматы
- **Layout_Manager**: Компонент для управления расположением виджетов на dashboard
- **Cache_Service**: Сервис кэширования для оптимизации производительности
- **Real_Time_Service**: Сервис для обновления данных в реальном времени

## Requirements

### Requirement 1: Activity Heatmap Calendar

**User Story:** Как пользователь, я хочу видеть календарь активности в виде тепловой карты, чтобы визуально оценить свою продуктивность по дням и выявить паттерны работы.

#### Acceptance Criteria

1. WHEN пользователь открывает dashboard, THE Dashboard SHALL отображать виджет Activity Heatmap с данными за последние 365 дней
2. WHEN пользователь наводит курсор на день в heatmap, THE System SHALL отображать tooltip с детальной информацией о количестве выполненных задач, времени работы и достижениях за этот день
3. WHEN пользователь кликает на день в heatmap, THE System SHALL отображать модальное окно с подробным списком активностей за выбранный день
4. THE Heatmap SHALL использовать цветовую градацию от светлого к темному для отображения уровня активности (0 задач = светлый, 10+ задач = темный)
5. THE Heatmap SHALL группировать дни по неделям и месяцам для удобной навигации
6. WHEN данные heatmap загружаются, THE System SHALL использовать кэширование для оптимизации производительности

### Requirement 2: Focus Time Tracker Widget

**User Story:** Как пользователь, я хочу отслеживать время работы над задачами, чтобы понимать, сколько времени я трачу на различные активности и оптимизировать свою продуктивность.

#### Acceptance Criteria

1. WHEN пользователь начинает работу над задачей, THE Time_Tracker SHALL запускать таймер и записывать время начала
2. WHEN пользователь останавливает таймер, THE Time_Tracker SHALL сохранять запись времени в TaskTimeTracking entity
3. THE Focus_Time_Widget SHALL отображать общее время работы за текущий день, неделю и месяц
4. THE Focus_Time_Widget SHALL отображать топ-5 задач по затраченному времени
5. WHEN пользователь просматривает статистику времени, THE System SHALL группировать данные по категориям задач и приоритетам
6. THE System SHALL вычислять среднее время выполнения задач по приоритетам и категориям
7. WHEN таймер активен более 2 часов без перерыва, THE System SHALL отправлять уведомление о необходимости отдыха

### Requirement 3: Achievements and Badges System

**User Story:** Как пользователь, я хочу получать достижения и награды за выполнение целей, чтобы чувствовать прогресс и мотивацию к дальнейшей работе.

#### Acceptance Criteria

1. WHEN пользователь выполняет определенное условие (например, 10 задач за день), THE Achievement_System SHALL присваивать соответствующий бейдж
2. THE Achievements_Widget SHALL отображать список всех доступных достижений с прогрессом их выполнения
3. THE System SHALL определять следующие типы достижений: по количеству выполненных задач, по streak привычек, по выполнению целей в срок, по общему времени работы
4. WHEN пользователь получает новое достижение, THE System SHALL отправлять уведомление и отображать анимацию награды
5. THE Achievements_Widget SHALL отображать статистику: общее количество полученных бейджей, прогресс до следующего достижения, редкие достижения
6. THE System SHALL хранить историю получения достижений с датами и временем

### Requirement 4: Advanced Habits Analytics

**User Story:** Как пользователь, я хочу видеть расширенную аналитику по моим привычкам с графиками трендов, чтобы отслеживать прогресс и выявлять закономерности.

#### Acceptance Criteria

1. THE Habits_Analytics_Widget SHALL отображать график completion rate для каждой привычки за выбранный период (неделя, месяц, год)
2. THE System SHALL вычислять и отображать текущий streak и longest streak для каждой привычки
3. THE Habits_Analytics_Widget SHALL отображать корреляцию между различными привычками (например, связь между сном и продуктивностью)
4. WHEN пользователь выбирает привычку, THE System SHALL отображать детальную статистику: процент выполнения по дням недели, лучшее и худшее время выполнения, тренды
5. THE System SHALL предсказывать вероятность выполнения привычки на основе исторических данных
6. THE Habits_Analytics_Widget SHALL отображать сравнение текущего периода с предыдущим (week-over-week, month-over-month)

### Requirement 5: Smart Priority Widget

**User Story:** Как пользователь, я хочу видеть умную сортировку задач по срочности и важности, чтобы фокусироваться на наиболее приоритетных задачах.

#### Acceptance Criteria

1. THE Priority_Widget SHALL вычислять приоритетный score для каждой задачи на основе: due date, priority level, dependencies, estimated time
2. THE Priority_Widget SHALL отображать топ-10 задач с наивысшим priority score
3. WHEN задача приближается к deadline (менее 24 часов), THE System SHALL автоматически повышать ее priority score
4. THE Priority_Widget SHALL группировать задачи по матрице Эйзенхауэра (срочно-важно, срочно-неважно, несрочно-важно, несрочно-неважно)
5. WHEN у задачи есть блокирующие зависимости, THE System SHALL отображать предупреждение и снижать priority score
6. THE Priority_Widget SHALL обновляться в реальном времени при изменении статуса задач

### Requirement 6: Data Export Functionality

**User Story:** Как пользователь, я хочу экспортировать аналитические данные в PDF и Excel, чтобы создавать отчеты и делиться информацией с коллегами.

#### Acceptance Criteria

1. WHEN пользователь нажимает кнопку "Export", THE System SHALL отображать диалог выбора формата (PDF, Excel) и периода данных
2. WHEN пользователь выбирает PDF export, THE Export_Service SHALL генерировать PDF документ с графиками, таблицами и статистикой
3. WHEN пользователь выбирает Excel export, THE Export_Service SHALL генерировать XLSX файл с детальными данными в табличном формате
4. THE Export_Service SHALL включать в экспорт: статистику задач, аналитику времени, данные по привычкам, прогресс целей, heatmap данные
5. THE System SHALL генерировать экспорт асинхронно для больших объемов данных и уведомлять пользователя о готовности
6. THE Export_Service SHALL применять фильтры пользователя (даты, категории, приоритеты) к экспортируемым данным

### Requirement 7: Customizable Dashboard Layout

**User Story:** Как пользователь, я хочу настраивать расположение виджетов на dashboard, чтобы адаптировать интерфейс под свои потребности.

#### Acceptance Criteria

1. WHEN пользователь переходит в режим редактирования dashboard, THE System SHALL активировать drag-and-drop функциональность для виджетов
2. WHEN пользователь перетаскивает виджет, THE Layout_Manager SHALL отображать preview нового расположения
3. WHEN пользователь сохраняет layout, THE System SHALL сохранять конфигурацию в базе данных, связанную с пользователем
4. THE System SHALL поддерживать изменение размера виджетов (маленький, средний, большой)
5. WHEN пользователь добавляет новый виджет, THE System SHALL отображать галерею доступных виджетов с описаниями
6. THE System SHALL сохранять несколько preset layouts (по умолчанию, минималистичный, детальный) для быстрого переключения
7. WHEN пользователь сбрасывает layout, THE System SHALL восстанавливать конфигурацию по умолчанию

### Requirement 8: Real-Time Updates

**User Story:** Как пользователь, я хочу видеть обновления данных в реальном времени, чтобы всегда иметь актуальную информацию без перезагрузки страницы.

#### Acceptance Criteria

1. WHEN данные задачи изменяются (статус, приоритет, время), THE Real_Time_Service SHALL отправлять обновление на dashboard пользователя
2. THE System SHALL использовать Mercure или WebSocket для push-уведомлений об изменениях
3. WHEN новое достижение получено, THE System SHALL отображать уведомление в реальном времени с анимацией
4. THE Real_Time_Service SHALL обновлять виджеты без полной перезагрузки страницы
5. WHEN соединение с real-time сервисом прерывается, THE System SHALL автоматически переподключаться и синхронизировать данные
6. THE System SHALL группировать множественные обновления в batch для оптимизации производительности

### Requirement 9: Performance and Caching

**User Story:** Как пользователь, я хочу, чтобы dashboard загружался быстро и работал плавно, даже при большом объеме данных.

#### Acceptance Criteria

1. WHEN пользователь открывает dashboard, THE System SHALL загружать критические виджеты в первую очередь (приоритет загрузки)
2. THE Cache_Service SHALL кэшировать агрегированные данные аналитики на 5 минут
3. THE System SHALL использовать lazy loading для виджетов, находящихся вне viewport
4. WHEN выполняются тяжелые вычисления (например, корреляция привычек), THE System SHALL выполнять их асинхронно в фоновом режиме
5. THE System SHALL оптимизировать SQL запросы, избегая N+1 проблем через использование JOIN и eager loading
6. THE System SHALL использовать database indexes для полей, используемых в аналитических запросах (user_id, created_at, status, priority)
7. WHEN кэш инвалидируется (изменение данных), THE System SHALL обновлять только затронутые виджеты

### Requirement 10: Responsive Design

**User Story:** Как пользователь, я хочу использовать dashboard на мобильных устройствах, чтобы отслеживать свою продуктивность в любом месте.

#### Acceptance Criteria

1. WHEN пользователь открывает dashboard на мобильном устройстве (ширина < 768px), THE System SHALL отображать виджеты в одну колонку
2. THE System SHALL адаптировать размеры графиков и heatmap для мобильных экранов
3. WHEN пользователь использует touch-устройство, THE System SHALL поддерживать touch-жесты для взаимодействия с виджетами (swipe, pinch-to-zoom)
4. THE System SHALL скрывать менее важные элементы на мобильных устройствах для экономии пространства
5. THE Mobile_Layout SHALL сохранять функциональность drag-and-drop через long-press жест
6. THE System SHALL оптимизировать загрузку данных на мобильных устройствах, уменьшая объем передаваемых данных
