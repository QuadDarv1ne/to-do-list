{% extends 'base_sidebar.html.twig' %}

{% block page_title %}Канбан доска{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/pipeline-view.css') }}">
{% endblock %}

{% block body %}
<div class="animate-fade-in">
    <!-- Pipeline Controls -->
    <div class="pipeline-controls stagger-item">
        <div class="pipeline-filter">
            <button class="pipeline-filter-btn active" data-quick-filter="all">
                <i class="fas fa-th"></i> Все
            </button>
            <button class="pipeline-filter-btn" data-quick-filter="priority" data-filter-value="high">
                <i class="fas fa-exclamation-circle"></i> Высокий приоритет
            </button>
            <button class="pipeline-filter-btn" data-quick-filter="assignee" data-filter-value="me">
                <i class="fas fa-user"></i> Мои задачи
            </button>
        </div>
        
        <div style="display: flex; gap: 12px;">
            <button class="pipeline-filter-btn" data-filter-builder>
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="pipeline-filter-btn">
                <i class="fas fa-sort"></i> Сортировка
            </button>
            <button class="pipeline-filter-btn">
                <i class="fas fa-cog"></i> Настройки
            </button>
        </div>
    </div>

    <!-- Pipeline Stats -->
    <div class="pipeline-stats stagger-item delay-100">
        <div class="pipeline-stat-card">
            <div class="pipeline-stat-label">Всего задач</div>
            <div class="pipeline-stat-value">{{ tasks|length }}</div>
            <div class="pipeline-stat-trend up">
                <i class="fas fa-arrow-up"></i>
                +12%
            </div>
        </div>
        <div class="pipeline-stat-card">
            <div class="pipeline-stat-label">В работе</div>
            <div class="pipeline-stat-value">{{ tasks|filter(t => t.status == 'in_progress')|length }}</div>
            <div class="pipeline-stat-trend up">
                <i class="fas fa-arrow-up"></i>
                +5%
            </div>
        </div>
        <div class="pipeline-stat-card">
            <div class="pipeline-stat-label">Завершено</div>
            <div class="pipeline-stat-value">{{ tasks|filter(t => t.status == 'completed')|length }}</div>
            <div class="pipeline-stat-trend up">
                <i class="fas fa-arrow-up"></i>
                +18%
            </div>
        </div>
        <div class="pipeline-stat-card">
            <div class="pipeline-stat-label">Средний цикл</div>
            <div class="pipeline-stat-value">3.2 дня</div>
            <div class="pipeline-stat-trend down">
                <i class="fas fa-arrow-down"></i>
                -8%
            </div>
        </div>
    </div>

    <!-- Active Filters Container -->
    <div data-filters-container></div>

    <!-- Pipeline Board -->
    <div class="pipeline-container stagger-item delay-200">
        {% for status, label in {
            'pending': 'В ожидании',
            'in_progress': 'В работе',
            'completed': 'Завершено',
            'cancelled': 'Отменено'
        } %}
        <div class="pipeline-column" data-status-zone="{{ status }}">
            <div class="pipeline-column-header">
                <div>
                    <div class="pipeline-column-title">
                        <i class="fas fa-{{ status == 'pending' ? 'clock' : (status == 'in_progress' ? 'spinner' : (status == 'completed' ? 'check-circle' : 'times-circle')) }}"></i>
                        {{ label }}
                        <span class="pipeline-column-count">{{ tasks_by_status[status]|default([])|length }}</span>
                    </div>
                </div>
                <div class="pipeline-column-value">
                    ₽ {{ (tasks_by_status[status]|default([])|reduce((carry, task) => carry + (task.estimatedValue|default(0)), 0))|number_format(0, '.', ' ') }}
                </div>
            </div>
            
            <div class="pipeline-cards">
                {% for task in tasks_by_status[status]|default([]) %}
                <div class="pipeline-card" 
                     data-task-draggable
                     data-task-id="{{ task.id }}"
                     data-filterable-item
                     data-status="{{ task.status }}"
                     data-priority="{{ task.priority }}"
                     data-assignee="{{ task.assignedTo ? task.assignedTo.id : '' }}"
                     draggable="true">
                    
                    <div class="pipeline-card-priority {{ task.priority }}"></div>
                    
                    <div class="pipeline-card-header">
                        <div class="pipeline-card-title">{{ task.title }}</div>
                        <div class="pipeline-card-menu">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                    </div>
                    
                    <div class="pipeline-card-meta">
                        {% if task.estimatedValue %}
                        <div class="pipeline-card-value">
                            ₽ {{ task.estimatedValue|number_format(0, '.', ' ') }}
                        </div>
                        {% endif %}
                        
                        {% if task.dueDate %}
                        <div class="pipeline-card-date">
                            <i class="fas fa-calendar"></i>
                            {{ task.dueDate|date('d.m.Y') }}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if task.description %}
                    <div style="font-size: 13px; color: var(--text-muted); margin: 8px 0; line-height: 1.4;">
                        {{ task.description|length > 80 ? task.description|slice(0, 80) ~ '...' : task.description }}
                    </div>
                    {% endif %}
                    
                    <div class="pipeline-card-footer">
                        <div class="pipeline-card-assignee">
                            {% if task.assignedTo %}
                            <div class="pipeline-card-avatar" data-user-presence>
                                {{ task.assignedTo.firstName|slice(0, 1) }}{{ task.assignedTo.lastName|slice(0, 1) }}
                            </div>
                            <span style="font-size: 13px; color: var(--text-secondary);">
                                {{ task.assignedTo.firstName }}
                            </span>
                            {% else %}
                            <span style="font-size: 13px; color: var(--text-muted);">
                                <i class="fas fa-user-slash"></i> Не назначено
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="pipeline-card-tags">
                            {% if task.project %}
                            <span class="pipeline-card-tag">
                                {{ task.project.name }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                    <div>Нет задач</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="pipeline-add-card">
                <i class="fas fa-plus"></i> Добавить задачу
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Activity Stream -->
<div style="position: fixed; bottom: 20px; right: 20px; width: 350px; max-height: 400px; overflow-y: auto; background: var(--card-bg); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 16px; z-index: 999;">
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">
            <i class="fas fa-stream"></i> Активность
        </h4>
        <button onclick="this.closest('div').style.display='none'" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div data-activity-stream></div>
</div>

<script>
// Drag & Drop для канбан-доски
let draggedCard = null;

document.addEventListener('dragstart', (e) => {
    if (e.target.matches('[data-task-draggable]')) {
        draggedCard = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
});

document.addEventListener('dragend', (e) => {
    if (e.target.matches('[data-task-draggable]')) {
        e.target.classList.remove('dragging');
        draggedCard = null;
    }
});

document.addEventListener('dragover', (e) => {
    e.preventDefault();
    const column = e.target.closest('[data-status-zone]');
    if (column) {
        column.classList.add('drag-over');
    }
});

document.addEventListener('dragleave', (e) => {
    const column = e.target.closest('[data-status-zone]');
    if (column && !column.contains(e.relatedTarget)) {
        column.classList.remove('drag-over');
    }
});

document.addEventListener('drop', (e) => {
    e.preventDefault();
    const column = e.target.closest('[data-status-zone]');
    
    if (column && draggedCard) {
        column.classList.remove('drag-over');
        
        const newStatus = column.getAttribute('data-status-zone');
        const taskId = draggedCard.getAttribute('data-task-id');
        
        // Перемещаем карточку
        const cardsContainer = column.querySelector('.pipeline-cards');
        cardsContainer.appendChild(draggedCard);
        
        // Обновляем статус на сервере
        fetch(`/task/${taskId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем счётчики
                updateColumnCounters();
                
                // Показываем уведомление
                if (window.showSmartNotification) {
                    window.showSmartNotification('Статус задачи обновлён', 'success');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (window.showSmartNotification) {
                window.showSmartNotification('Ошибка при обновлении статуса', 'error');
            }
        });
    }
});

function updateColumnCounters() {
    document.querySelectorAll('[data-status-zone]').forEach(column => {
        const count = column.querySelectorAll('[data-task-draggable]').length;
        const counter = column.querySelector('.pipeline-column-count');
        if (counter) {
            counter.textContent = count;
        }
    });
}

// Клик по карточке для быстрого просмотра
document.addEventListener('click', (e) => {
    const card = e.target.closest('.pipeline-card');
    if (card && !e.target.closest('.pipeline-card-menu')) {
        const taskId = card.getAttribute('data-task-id');
        window.location.href = `/task/${taskId}`;
    }
});

// Добавление новой задачи
document.querySelectorAll('.pipeline-add-card').forEach(btn => {
    btn.addEventListener('click', () => {
        const column = btn.closest('[data-status-zone]');
        const status = column.getAttribute('data-status-zone');
        window.location.href = `/task/new?status=${status}`;
    });
});
</script>
{% endblock %}
