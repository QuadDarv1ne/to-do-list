<!DOCTYPE html>
<html lang="{% block lang %}ru{% endblock %}" data-theme="light" data-mode="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    {# ~ SEO & Social ~ #}
    <title>{% block title %}CRM система{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}CRM система для анализа продаж{% endblock %}">
    <meta name="robots"      content="{% block meta_robots %}noindex, nofollow{% endblock %}">

    {# ~ Favicon ~ #}
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <link rel="shortcut icon" type="image/png" href="/favicon.png?v=2">

    {# ~ Mobile / PWA ~ #}
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" id="meta-theme-color" content="#ffffff">

    {# ~ Preconnect ~ #}
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    {# ~ Preload Critical Resources ~ #}
    <link rel="preload" href="{{ asset('css/vendor/bootstrap.min.css') }}" as="style">
    <link rel="preload" href="{{ asset('css/themes/sidebar-layout.css') }}" as="style">
    <link rel="preload" href="{{ asset('js/core/theme-manager-enhanced.js') }}" as="script">

    {# ~ Vendor CSS ~ #}
    <link rel="stylesheet" href="{{ asset('css/vendor/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/vendor/fontawesome.min.css') }}">

    {# ~ Sidebar Layout ~ #}
    <link rel="stylesheet" href="{{ asset('css/themes/sidebar-layout.css') }}?v=6">

    {# ~ Core CSS ~ #}
    <link rel="stylesheet" href="{{ asset('css/core/ui-improvements.css') }}">
    <link rel="stylesheet" href="{{ asset('css/core/theme-transitions.css') }}">
    <link rel="stylesheet" href="{{ asset('css/core/advanced-animations.css') }}">
    <link rel="stylesheet" href="{{ asset('css/core/responsive.css') }}">
    <link rel="stylesheet" href="{{ asset('css/core/adaptive-grid.css') }}">

    {# ~ Components CSS ~ #}
    <link rel="stylesheet" href="{{ asset('css/components/enhanced-stats.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/fab-menu.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/modern-dashboard.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/pipeline-view.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/enhanced-cards.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/notification-system.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/animations.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/skeleton-loader.css') }}">
    <link rel="stylesheet" href="{{ asset('css/components/keyboard-shortcuts.css') }}">

    {# ~ Mobile Enhanced ~ #}
    <link rel="stylesheet" href="{{ asset('css/mobile-enhanced.css') }}">

    {# ~ Тема подключается динамически через theme-manager-enhanced.js ~ #}

    {# ~ Core JS (до рендера — предотвращает мерцание темы) ~ #}
    <script src="{{ asset('js/core/theme-manager-enhanced.js') }}"></script>
    <script src="{{ asset('js/core/keyboard-shortcuts-enhanced.js') }}" defer></script>
    <script src="{{ asset('js/components/advanced-ui.js') }}"></script>
    <script src="{{ asset('js/components/modal-system.js') }}"></script>
    <script src="{{ asset('js/components/data-manager.js') }}"></script>
    <script src="{{ asset('js/components/virtual-scroll.js') }}"></script>
    <script src="{{ asset('js/components/filter-sort.js') }}"></script>

    {# ~ Стили дочерних шаблонов ~ #}
    {% block stylesheets %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

    {# ~ Мобильная кнопка меню ~ #}
    <button class="mobile-menu-btn"
            onclick="toggleMobileSidebar()"
            aria-label="Открыть меню"
            aria-expanded="false"
            aria-controls="sidebar"
            style="display: none;">
        <i class="fas fa-bars" aria-hidden="true"></i>
    </button>

    {# ~ Backdrop для мобильного sidebar ~ #}
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeMobileSidebar()"></div>

    {# ~ Sidebar ~ #}
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Основная навигация">

        {# Шапка #}
        <div class="sidebar-header">
            <div class="sidebar-logo" aria-hidden="true">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="sidebar-title">CRM</div>
        </div>

        {# Навигация #}
        {% set route = app.request.attributes.get('_route') %}
        <nav class="sidebar-nav">
            {% set nav_items = [
                { route: 'app_dashboard',          icon: 'fa-home',       label: 'Панель',       match: 'exact' },
                { route: 'app_task_index',          icon: 'fa-tasks',      label: 'Задачи',       match: 'starts' },
                { route: 'app_kanban_board',        icon: 'fa-columns',    label: 'Канбан',       match: 'exact' },
                { route: 'app_calendar',            icon: 'fa-calendar',   label: 'Календарь',    match: 'exact' },
                { route: 'app_analytics_dashboard', icon: 'fa-chart-bar',  label: 'Аналитика',    match: 'starts' },
                { route: 'app_crm_dashboard',       icon: 'fa-chart-line', label: 'CRM',          match: 'starts' },
                { route: 'app_clients_index',       icon: 'fa-building',   label: 'Клиенты',      match: 'starts' },
                { route: 'app_deals_index',         icon: 'fa-handshake',  label: 'Сделки',       match: 'starts' },
                { route: 'app_products_index',      icon: 'fa-box',        label: 'Товары',       match: 'starts' },
                { route: 'app_user_index',          icon: 'fa-users',      label: 'Пользователи', match: 'starts' },
                { route: 'app_webhook_index',       icon: 'fa-bolt',       label: 'Webhooks',     match: 'starts' },
                { route: 'app_settings',            icon: 'fa-cog',        label: 'Настройки',    match: 'exact' },
            ] %}

            {% for item in nav_items %}
                {% set is_active = item.match == 'exact'
                    ? route == item.route
                    : route starts with item.route %}
                <div class="nav-item">
                    <a href="{{ path(item.route) }}"
                       class="nav-link {{ is_active ? 'active' : '' }}"
                       {{ is_active ? 'aria-current="page"' : '' }}>
                        <i class="nav-icon fas {{ item.icon }}" aria-hidden="true"></i>
                        <span class="nav-text">{{ item.label }}</span>
                    </a>
                </div>
            {% endfor %}
        </nav>

        {# Футер sidebar #}
        <div class="sidebar-footer">

            {# ~ Переключатель темы ~ #}
            <div class="theme-selector mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted nav-text">Тема оформления</small>
                </div>
                <div class="theme-options d-flex gap-2 flex-wrap" role="group" aria-label="Выбор темы">
                    <button class="theme-option" data-theme-option="light"  title="Светлая"       aria-label="Светлая тема"><i class="fas fa-sun" aria-hidden="true"></i></button>
                    <button class="theme-option" data-theme-option="dark"   title="Тёмная"        aria-label="Тёмная тема"><i class="fas fa-moon" aria-hidden="true"></i></button>
                    <button class="theme-option" data-theme-option="orange" title="Оранжевая"     aria-label="Оранжевая тема"><i class="fas fa-fire" aria-hidden="true"></i></button>
                    <button class="theme-option" data-theme-option="purple" title="Фиолетовая"    aria-label="Фиолетовая тема"><i class="fas fa-palette" aria-hidden="true"></i></button>
                    <button class="theme-option" data-theme-option="green"  title="Зелёная"       aria-label="Зелёная тема"><i class="fas fa-leaf" aria-hidden="true"></i></button>
                    <button class="theme-option" data-theme-option="custom" title="Настраиваемая" aria-label="Настраиваемая тема"><i class="fas fa-sliders-h" aria-hidden="true"></i></button>
                </div>
            </div>

            {# ~ Профиль пользователя ~ #}
            {% if app.user %}
                <div class="user-profile">
                    <div class="user-avatar" aria-hidden="true">
                        {{ app.user.fullName|slice(0, 1)|upper }}
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ app.user.fullName }}</div>
                        <div class="user-role">
                            {{ 'ROLE_ADMIN' in app.user.roles ? 'Администратор' : 'Пользователь' }}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Свернуть меню">
            <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </button>
    </aside>

    {# ~ Основной контент ~ #}
    <main class="main-content" id="main-content">

        {# Top Bar #}
        <div class="top-bar">
            <h1 class="page-title">{% block page_title %}Панель управления{% endblock %}</h1>

            <div class="top-actions">
                <div class="search-box" role="search">
                    <i class="search-icon fas fa-search" aria-hidden="true"></i>
                    <input type="search" class="search-input" placeholder="Поиск..." aria-label="Поиск">
                </div>

                <button class="icon-btn" onclick="window.themeManager?.cycleTheme()" aria-label="Сменить тему">
                    <i class="fas fa-palette" aria-hidden="true"></i>
                </button>

                <button class="icon-btn" aria-label="Уведомления">
                    <i class="fas fa-bell" aria-hidden="true"></i>
                    <span class="badge" aria-label="3 уведомления">3</span>
                </button>

                <a href="{{ path('app_profile_show') }}" class="icon-btn" aria-label="Профиль">
                    <i class="fas fa-user" aria-hidden="true"></i>
                </a>
            </div>
        </div>

        {# ~ Flash-сообщения (через notification system) ~ #}
        {% block flash_messages %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    {% for type, messages in app.flashes %}
                        {% for message in messages %}
                            setTimeout(() => {
                                if (window.notify) {
                                    window.notify.{{ type == 'error' ? 'error' : type }}('{{ message|e('js') }}');
                                }
                            }, 100);
                        {% endfor %}
                    {% endfor %}
                });
            </script>
        {% endblock %}

        {% block body %}{% endblock %}
    </main>

    {# ~ FAB меню быстрых действий ~ #}
    {% if app.user %}
        <div class="fab-container" id="fabContainer">
            <button class="fab-main" onclick="toggleFAB()" aria-label="Быстрые действия" aria-expanded="false">
                <i class="fas fa-plus" aria-hidden="true"></i>
                <span class="fab-tooltip">Быстрые действия</span>
            </button>
            <div class="fab-menu" role="menu">
                <div class="fab-item" role="none">
                    <span class="fab-label">Сменить тему</span>
                    <button class="fab-button" onclick="window.themeManager?.cycleTheme()" aria-label="Сменить тему" role="menuitem">
                        <i class="fas fa-palette" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="fab-item" role="none">
                    <span class="fab-label">Новая задача</span>
                    <a href="{{ path('app_task_new') }}" class="fab-button" role="menuitem">
                        <i class="fas fa-tasks" aria-hidden="true"></i>
                    </a>
                </div>
                <div class="fab-item" role="none">
                    <span class="fab-label">Канбан доска</span>
                    <a href="{{ path('app_kanban_board') }}" class="fab-button success" role="menuitem">
                        <i class="fas fa-columns" aria-hidden="true"></i>
                    </a>
                </div>
                <div class="fab-item" role="none">
                    <span class="fab-label">Аналитика</span>
                    <a href="{{ path('app_analytics_dashboard') }}" class="fab-button info" role="menuitem">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                    </a>
                </div>
                <div class="fab-item" role="none">
                    <span class="fab-label">Календарь</span>
                    <a href="{{ path('app_calendar') }}" class="fab-button warning" role="menuitem">
                        <i class="fas fa-calendar" aria-hidden="true"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="fab-backdrop" onclick="toggleFAB()"></div>
    {% endif %}

    {# ~ No-Script ~ #}
    <noscript>
        <div class="alert alert-warning text-center m-0 rounded-0" role="alert">
            Для корректной работы приложения необходимо включить JavaScript.
        </div>
    </noscript>

    {# ~ Vendor JS ~ #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"
            defer></script>

    {# ~ Components JS ~ #}
    <script src="{{ asset('js/components/notification-system.js') }}"  defer></script>
    <script src="{{ asset('js/components/interactive-elements.js') }}" defer></script>
    <script src="{{ asset('js/components/form-validator.js') }}"       defer></script>
    <script src="{{ asset('js/components/global-interactions.js') }}"  defer></script>
    <script src="{{ asset('js/components/mobile-interactions.js') }}"  defer></script>
    <script src="{{ asset('js/components/advanced-widgets.js') }}"     defer></script>
    <script src="{{ asset('js/components/real-time-updates.js') }}"    defer></script>
    <script src="{{ asset('js/components/advanced-filters.js') }}"     defer></script>
    <script src="{{ asset('js/components/smooth-animations.js') }}"    defer></script>

    {# ~ Sidebar & UI логика ~ #}
    <script>
        function toggleSidebar() {
            const sidebar     = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn   = document.querySelector('.sidebar-toggle i');
            const collapsed   = sidebar.classList.toggle('collapsed');
            const btn         = document.querySelector('.mobile-menu-btn');

            localStorage.setItem('sidebarCollapsed', collapsed);
            if (btn) btn.setAttribute('aria-expanded', String(!collapsed));

            // Переключаем иконку стрелочки
            if (toggleBtn) {
                if (collapsed) {
                    toggleBtn.classList.remove('fa-chevron-left');
                    toggleBtn.classList.add('fa-chevron-right');
                } else {
                    toggleBtn.classList.remove('fa-chevron-right');
                    toggleBtn.classList.add('fa-chevron-left');
                }
            }

            // Resize для графиков после анимации
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 300);
        }

        function toggleFAB() {
            const fab      = document.getElementById('fabContainer');
            const expanded = fab.classList.toggle('open');
            fab.querySelector('.fab-main')?.setAttribute('aria-expanded', String(expanded));
        }

        function toggleMobileSidebar() {
            const sidebar  = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            const btn      = document.querySelector('.mobile-menu-btn');
            const opened   = sidebar.classList.toggle('mobile-open');

            backdrop.classList.toggle('active', opened);
            btn?.setAttribute('aria-expanded', String(opened));

            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        }

        function closeMobileSidebar() {
            const sidebar  = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            const btn      = document.querySelector('.mobile-menu-btn');

            sidebar.classList.remove('mobile-open');
            backdrop.classList.remove('active');
            btn?.setAttribute('aria-expanded', 'false');

            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        }

        // Восстанавливаем состояние sidebar
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-toggle i');
            
            sidebar.classList.add('collapsed');
            
            // Восстанавливаем иконку стрелочки
            if (toggleBtn) {
                toggleBtn.classList.remove('fa-chevron-left');
                toggleBtn.classList.add('fa-chevron-right');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Закрываем sidebar при клике на ссылку (мобилка)
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) closeMobileSidebar();
                });
            });

            // Закрываем FAB после нажатия
            document.querySelectorAll('.fab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('fabContainer').classList.remove('open');
                });
            });

            // Плавное появление контента
            const main = document.querySelector('.main-content');
            if (main) {
                main.style.opacity = '0';
                requestAnimationFrame(() => {
                    main.style.transition = 'opacity 0.3s ease';
                    main.style.opacity    = '1';
                });
            }

            // Debounced resize
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 150);
            });
        });
    </script>

    {# ~ Скрипты дочерних шаблонов ~ #}
    {% block javascripts %}{% endblock %}

</body>
</html>
