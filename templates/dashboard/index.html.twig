{% extends 'base.html.twig' %}

{% block title %}Панель управления{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-banner bg-gradient-primary text-white rounded-3 p-4 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2">
                            <i class="fas fa-hand-wave me-2"></i>
                            Добро пожаловать, {{ app.user.firstName }}!
                        </h1>
                        <p class="mb-0 lead">
                            Управляйте своими задачами эффективно и продуктивно
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                            <a href="{{ path('app_task_new') }}" class="btn btn-light btn-lg">
                                <i class="fas fa-plus me-2"></i>Создать задачу
                            </a>
                            <a href="{{ path('app_task_category_new') }}" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-folder-plus me-2"></i>Новая категория
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                <i class="fas fa-tasks fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="stat-number mb-0 text-primary">{{ task_stats.total }}</h3>
                            <p class="stat-label mb-0">Всего задач</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="stat-number mb-0 text-warning">{{ task_stats.pending }}</h3>
                            <p class="stat-label mb-0">В ожидании</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                <i class="fas fa-play-circle fa-2x text-info"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="stat-number mb-0 text-info">{{ task_stats.in_progress }}</h3>
                            <p class="stat-label mb-0">В процессе</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="stat-number mb-0 text-success">{{ task_stats.completed }}</h3>
                            <p class="stat-label mb-0">Завершено</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Task Status Distribution Chart -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                        Распределение задач по статусу
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Task Priority Distribution Chart -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2 text-warning"></i>
                        Распределение задач по приоритету
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="priorityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tag Distribution Chart -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2 text-success"></i>
                        Распределение задач по тегам
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="tagChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tag Cloud -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud me-2 text-info"></i>
                        Облако тегов
                    </h5>
                </div>
                <div class="card-body">
                    {% if tag_stats is defined and tag_stats is not empty %}
                        <div class="tag-cloud">
                            {% for tag_stat in tag_stats|slice(0, 15) %}
                                <span class="tag-item" style="font-size: {{ 14 + (tag_stat.taskCount * 2) }}px; background-color: {{ tag_stat.color }}; color: white; padding: 5px 10px; margin: 3px; border-radius: 4px; display: inline-block;">
                                    {{ tag_stat.name }} ({{ tag_stat.taskCount }})
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Нет тегов для отображения</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Tasks -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2 text-primary"></i>
                            Последние задачи
                        </h5>
                        <a href="{{ path('app_task_index') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Все задачи
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if recent_tasks is not empty %}
                        <div class="list-group list-group-flush">
                            {% for task in recent_tasks %}
                                <div class="list-group-item task-item border-0 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                <h6 class="task-title mb-0 me-2">
                                                    <a href="{{ path('app_task_show', {'id': task.id}) }}" class="text-decoration-none">
                                                        {{ task.title }}
                                                    </a>
                                                </h6>
                                                <span class="badge badge-{{ task.status|lower }} me-2">
                                                    {{ task.status|trans }}
                                                </span>
                                                {% if task.priority == 'high' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>Высокий приоритет
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="task-meta mb-2">
                                                <i class="fas fa-folder me-1"></i>
                                                {% if task.category %}
                                                    {{ task.category.name }}
                                                {% else %}
                                                    Без категории
                                                {% endif %}
                                                <span class="mx-2">•</span>
                                                <i class="fas fa-calendar me-1"></i>
                                                Создано: {{ task.createdAt|date('d.m.Y H:i') }}
                                            </div>
                                            {% if task.description %}
                                                <p class="task-description mb-0 text-muted">
                                                    {{ task.description|slice(0, 100) }}{% if task.description|length > 100 %}...{% endif %}
                                                </p>
                                            {% endif %}
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{{ path('app_task_show', {'id': task.id}) }}">
                                                    <i class="fas fa-eye me-2"></i>Просмотр
                                                </a></li>
                                                <li><a class="dropdown-item" href="{{ path('app_task_edit', {'id': task.id}) }}">
                                                    <i class="fas fa-edit me-2"></i>Редактировать
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <h5>Нет задач</h5>
                            <p class="mb-0">Создайте свою первую задачу, чтобы начать</p>
                            <a href="{{ path('app_task_new') }}" class="btn btn-primary mt-3">
                                <i class="fas fa-plus me-2"></i>Создать задачу
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Categories -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>
                        Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_task_new') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Новая задача
                        </a>
                        <a href="{{ path('app_task_category_new') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-folder-plus me-2"></i>Новая категория
                        </a>
                        <a href="{{ path('app_profile_change_password') }}" class="btn btn-outline-info">
                            <i class="fas fa-key me-2"></i>Сменить пароль
                        </a>
                    </div>
                </div>
            </div>

            <!-- Categories -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-folder me-2 text-success"></i>
                            Категории
                        </h5>
                        <span class="badge bg-secondary">{{ categories|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if categories is not empty %}
                        <div class="list-group list-group-flush">
                            {% for category in categories|slice(0, 5) %}
                                <div class="list-group-item border-0 px-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ category.name }}</h6>
                                            <small class="text-muted">
                                                {{ category.tasks|length }} задач
                                            </small>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{{ path('app_task_category_edit', {'id': category.id}) }}">
                                                    <i class="fas fa-edit me-2"></i>Редактировать
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% if categories|length > 5 %}
                            <div class="card-footer bg-white text-center">
                                <a href="{{ path('app_task_category_index') }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Все категории
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state py-4">
                            <i class="fas fa-folder"></i>
                            <p class="mb-0">Нет категорий</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tag Completion Rates -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-percentage me-2 text-info"></i>
                        Процент выполнения задач по тегам
                    </h5>
                </div>
                <div class="card-body">
                    {% if tag_completion_rates is defined and tag_completion_rates is not empty %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Тег</th>
                                        <th>Цвет</th>
                                        <th>Всего задач</th>
                                        <th>Выполнено</th>
                                        <th>Процент выполнения</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tag_rate in tag_completion_rates|slice(0, 10) %}
                                        <tr>
                                            <td>
                                                <span class="badge" style="background-color: {{ tag_rate.color }}; color: white;">{{ tag_rate.name }}</span>
                                            </td>
                                            <td>
                                                <div style="width: 20px; height: 20px; background-color: {{ tag_rate.color }}; border-radius: 50%; display: inline-block;"></div>
                                            </td>
                                            <td>{{ tag_rate.totalTasks }}</td>
                                            <td>{{ tag_rate.completedTasks }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" 
                                                         role="progressbar" 
                                                         style="width: {{ tag_rate.completionRate }}%; background-color: {{ tag_rate.color }};"
                                                         aria-valuenow="{{ tag_rate.completionRate }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{ tag_rate.completionRate }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if tag_rate.completionRate == 100 %}
                                                    <span class="badge bg-success">Отлично!</span>
                                                {% elseif tag_rate.completionRate >= 75 %}
                                                    <span class="badge bg-primary">Хорошо</span>
                                                {% elseif tag_rate.completionRate >= 50 %}
                                                    <span class="badge bg-warning text-dark">Средне</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Нуждается в улучшении</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0">Нет данных о выполнении задач по тегам</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Activity Stats (only for non-admin users) -->
    {% if app.user.hasRole('ROLE_ADMIN') is not same as(true) and user_activity_stats is defined %}
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-clock me-2 text-primary"></i>
                        Ваша активность
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-sign-in-alt fa-2x text-primary mb-2"></i>
                                <h4 class="mb-1">{{ user_activity_stats.total_logins }}</h4>
                                <p class="mb-0 text-muted">Входов в систему</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6>Последние входы:</h6>
                            {% if user_activity_stats.recent_logins is not empty %}
                                <ul class="list-unstyled">
                                    {% for login in user_activity_stats.recent_logins %}
                                        <li class="mb-1">
                                            <i class="fas fa-calendar me-2 text-success"></i>
                                            {{ login.createdAt|date('d.m.Y H:i:s') }} - 
                                            <small>{{ login.description }}</small>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0">Нет записей о последних входах</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Platform Activity Stats (only for admin users) -->
    {% if app.user.hasRole('ROLE_ADMIN') and platform_activity_stats is defined %}
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2 text-info"></i>
                        Активность платформы
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-users fa-2x text-info mb-2"></i>
                                <h4 class="mb-1">{{ platform_activity_stats.user_statistics.active_today }}</h4>
                                <p class="mb-0">Активных сегодня</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                                <h4 class="mb-1">{{ platform_activity_stats.user_statistics.total }}</h4>
                                <p class="mb-0">Всего пользователей</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-user-tag fa-2x text-warning mb-2"></i>
                                <h4 class="mb-1">{{ platform_activity_stats.user_statistics.active }}</h4>
                                <p class="mb-0">Активных</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Последние входы пользователей:</h6>
                        {% if platform_activity_stats.recent_logins is not empty %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Дата и время</th>
                                            <th>Пользователь</th>
                                            <th>Описание</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for login in platform_activity_stats.recent_logins %}
                                            <tr>
                                                <td>{{ login.createdAt|date('d.m.Y H:i:s') }}</td>
                                                <td>{{ login.user.fullName }}</td>
                                                <td>{{ login.description }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">Нет записей о последних входах</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Task Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: ['Завершено', 'В процессе', 'В ожидании'],
            datasets: [{
                data: [
                    {{ task_stats.completed }},
                    {{ task_stats.in_progress }},
                    {{ task_stats.pending }}
                ],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)', // green for completed
                    'rgba(23, 162, 184, 0.8)', // teal for in progress
                    'rgba(255, 193, 7, 0.8)'   // yellow for pending
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.chart.getDatasetMeta(0).total;
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Task Priority Distribution Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    const priorityChart = new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: ['Низкий', 'Средний', 'Высокий'],
            datasets: [{
                label: 'Количество задач',
                data: [
                    {{ task_stats.low_priority|default(0) }},
                    {{ task_stats.medium_priority|default(0) }},
                    {{ task_stats.high_priority|default(0) }}
                ],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',  // green for low
                    'rgba(255, 193, 7, 0.8)',  // yellow for medium
                    'rgba(220, 53, 69, 0.8)'   // red for high
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Task Tag Distribution Chart
    {% if tag_stats is defined and tag_stats is not empty %}
    const tagCtx = document.getElementById('tagChart').getContext('2d');
    const tagChart = new Chart(tagCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for tag_stat in tag_stats|slice(0, 10) %}
                    '{{ tag_stat.name }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for tag_stat in tag_stats|slice(0, 10) %}
                        {{ tag_stat.taskCount }},
                    {% endfor %}
                ],
                backgroundColor: [
                    {% for tag_stat in tag_stats|slice(0, 10) %}
                        '{{ tag_stat.color }}',
                    {% endfor %}
                ],
                borderColor: [
                    {% for tag_stat in tag_stats|slice(0, 10) %}
                        'rgba(255, 255, 255, 1)',
                    {% endfor %}
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.chart.getDatasetMeta(0).total;
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} задач (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
}

.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: center;
}

.tag-item {
    transition: transform 0.2s ease;
}

.tag-item:hover {
    transform: scale(1.05);
    cursor: pointer;
}
</style>
{% endblock %}