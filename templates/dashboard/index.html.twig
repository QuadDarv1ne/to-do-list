{% extends 'base_sidebar.html.twig' %}

{% block page_title %}Панель управления{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/advanced-animations.css') }}">
    <link rel="stylesheet" href="{{ asset('css/dashboard-modern-dark.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/theme-light.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/theme-orange.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/theme-purple.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/theme-custom.min.css') }}">
{% endblock %}

{% block body %}
<div class="dashboard-modern">
    <!-- Top Bar -->
    <div class="dashboard-topbar">
        <div class="dashboard-logo">
            <i class="fas fa-chart-line me-2"></i>CRM
        </div>
        
        <div class="dashboard-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Поиск...">
        </div>
        
        <div class="dashboard-actions">
            <button class="notification-btn" onclick="window.location.href='{{ path('app_notification_index') }}'">
                <i class="fas fa-bell"></i>
                {% if app.user.unreadNotifications|default(0) > 0 %}
                <span class="notification-badge">{{ app.user.unreadNotifications }}</span>
                {% endif %}
            </button>
            
            <div class="user-avatar" onclick="window.location.href='{{ path('app_profile_show') }}'">
                {{ app.user.firstName|first }}{{ app.user.lastName|first }}
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid-modern">
        <div class="stat-card-modern sales stagger-item hover-lift">
            <div class="stat-header-modern">
                <div class="stat-icon-modern">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="stat-label-modern">Продажи</span>
            </div>
            <div class="stat-value-modern">120.000</div>
            <div class="stat-change">
                <i class="fas fa-arrow-up"></i>
                <span>+12.5%</span>
            </div>
        </div>
        
        <div class="stat-card-modern orders stagger-item hover-lift delay-100">
            <div class="stat-header-modern">
                <div class="stat-icon-modern">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <span class="stat-label-modern">Заказы</span>
            </div>
            <div class="stat-value-modern">{{ task_stats.total|default(37) }}</div>
            <div class="stat-change">
                <i class="fas fa-arrow-up"></i>
                <span>+8.2%</span>
            </div>
        </div>
        
        <div class="stat-card-modern bonuses stagger-item hover-lift delay-200">
            <div class="stat-header-modern">
                <div class="stat-icon-modern">
                    <i class="fas fa-gift"></i>
                </div>
                <span class="stat-label-modern">Бонусы</span>
            </div>
            <div class="stat-value-modern">13.200</div>
            <div class="stat-change">
                <i class="fas fa-arrow-up"></i>
                <span>+5.7%</span>
            </div>
        </div>
        
        <div class="stat-card-modern clients stagger-item hover-lift delay-300">
            <div class="stat-header-modern">
                <div class="stat-icon-modern">
                    <i class="fas fa-users"></i>
                </div>
                <span class="stat-label-modern">Клиенты</span>
            </div>
            <div class="stat-value-modern">{{ task_stats.completed|default(37) }}</div>
            <div class="stat-change">
                <i class="fas fa-arrow-up"></i>
                <span>+15.3%</span>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid-modern">
        <!-- Chart Section -->
        <div class="chart-card-modern stagger-item delay-400 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">Заказы, шт.</h3>
                <div class="chart-filter">
                    <button class="filter-btn">День</button>
                    <button class="filter-btn">Неделя</button>
                    <button class="filter-btn active">Месяц</button>
                    <button class="filter-btn">Год</button>
                </div>
            </div>
            <canvas id="ordersChart" height="80"></canvas>
        </div>

        <!-- Calendar & Stats -->
        <div>
            <div class="calendar-widget">
                <div class="chart-header">
                    <h3 class="chart-title">Календарь</h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
                        <span style="color: var(--text-primary); font-weight: 600;">Январь 2026</span>
                        <button class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="calendar-grid">
                    <div class="calendar-day-header">ПН</div>
                    <div class="calendar-day-header">ВТ</div>
                    <div class="calendar-day-header">СР</div>
                    <div class="calendar-day-header">ЧТ</div>
                    <div class="calendar-day-header">ПТ</div>
                    <div class="calendar-day-header">СБ</div>
                    <div class="calendar-day-header">ВС</div>
                    
                    {% for day in 1..31 %}
                    <div class="calendar-day {% if day == 16 %}today{% endif %} {% if day in [2, 9, 16, 23] %}has-event{% endif %}">
                        {{ day }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="chart-card-modern mt-3">
                <div class="donut-chart-container">
                    <canvas id="donutChart" width="200" height="200"></canvas>
                    
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4dd4ac;"></div>
                            <span class="legend-label">Продажи</span>
                            <span class="legend-value">1.500</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b7ff4;"></div>
                            <span class="legend-label">Таргет</span>
                            <span class="legend-value">17.000</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd93d;"></div>
                            <span class="legend-label">Предзаказы</span>
                            <span class="legend-value">1.173</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6bcb;"></div>
                            <span class="legend-label">Сети</span>
                            <span class="legend-value">1.200.000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Chart -->
    <div class="chart-card-modern">
        <div class="chart-header">
            <h3 class="chart-title">Продажи</h3>
            <select class="filter-btn" style="padding: 0.5rem 1rem;">
                <option>2025</option>
                <option selected>2026</option>
            </select>
        </div>
        <canvas id="salesChart" height="60"></canvas>
    </div>

    <!-- Recent Tasks Table -->
    <div class="chart-card-modern mt-3">
        <div class="chart-header">
            <h3 class="chart-title">Последние задачи</h3>
            <a href="{{ path('app_task_index') }}" class="filter-btn">Все задачи</a>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Приоритет</th>
                        <th>Статус</th>
                        <th>Срок</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in recent_tasks|default([]) %}
                    <tr onclick="window.location.href='{{ path('app_task_show', {id: task.id}) }}'" style="cursor: pointer;">
                        <td>{{ task.id }}</td>
                        <td>{{ task.title }}</td>
                        <td>
                            <span class="badge bg-{{ task.priority == 'high' ? 'danger' : (task.priority == 'medium' ? 'warning' : 'info') }}">
                                {{ task.priority|upper }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ task.status == 'completed' ? 'success' : (task.status == 'in_progress' ? 'primary' : 'secondary') }}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td>{{ task.dueDate ? task.dueDate|date('d.m.Y') : '-' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">Нет задач</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Theme Switcher -->
<div class="theme-switcher-modern">
    <button class="theme-toggle-btn">
        <i class="fas fa-palette"></i>
    </button>
    <div class="theme-options" id="themeOptions">
        <div class="theme-option light" data-theme="light" title="Светлая"></div>
        <div class="theme-option dark" data-theme="dark" title="Темная"></div>
        <div class="theme-option orange" data-theme="orange" title="Оранжевая"></div>
        <div class="theme-option purple" data-theme="purple" title="Фиолетовая"></div>
        <div class="theme-option custom" data-theme="custom" title="Кастомная"></div>
    </div>
</div>

<script>
// Theme switcher для dashboard
document.addEventListener('DOMContentLoaded', function() {
    const themeToggleBtn = document.querySelector('.theme-toggle-btn');
    const themeOptions = document.getElementById('themeOptions');
    const themeOptionElements = document.querySelectorAll('.theme-option');
    
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            themeOptions.classList.toggle('active');
        });
    }
    
    themeOptionElements.forEach(option => {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            const theme = this.getAttribute('data-theme');
            if (window.unifiedThemeSystem) {
                window.unifiedThemeSystem.setTheme(theme);
            }
            themeOptions.classList.remove('active');
        });
    });
    
    // Закрытие при клике вне
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.theme-switcher-modern')) {
            themeOptions.classList.remove('active');
        }
    });
    
    // Обновление активной темы
    if (window.unifiedThemeSystem) {
        const currentTheme = window.unifiedThemeSystem.getCurrentTheme();
        themeOptionElements.forEach(option => {
            if (option.getAttribute('data-theme') === currentTheme) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    }
});
</script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Orders Chart
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        new Chart(ordersCtx, {
            type: 'bar',
            data: {
                labels: ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'],
                datasets: [{
                    label: 'Заказы',
                    data: [20, 30, 50, 28, 35, 45, 38],
                    backgroundColor: [
                        '#ffd93d',
                        '#4dd4ac',
                        '#8b7ff4',
                        '#ffd93d',
                        '#4dd4ac',
                        '#8b7ff4',
                        '#4dd4ac'
                    ],
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#3a3a3a' },
                        ticks: { color: '#a0a0a0' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#a0a0a0' }
                    }
                }
            }
        });

        // Donut Chart
        const donutCtx = document.getElementById('donutChart').getContext('2d');
        new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [1500, 17000, 1173, 1200],
                    backgroundColor: ['#4dd4ac', '#8b7ff4', '#ffd93d', '#ff6bcb'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });

        // Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'],
                datasets: [
                    {
                        label: 'Текущий год',
                        data: [15000, 22000, 28000, 35000, 32000, 38000, 45000, 42000, 48000, 52000, 58000, 65000],
                        borderColor: '#8b7ff4',
                        backgroundColor: 'rgba(139, 127, 244, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Прошлый год',
                        data: [12000, 18000, 24000, 28000, 26000, 30000, 35000, 32000, 38000, 42000, 45000, 50000],
                        borderColor: '#4dd4ac',
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: { color: '#a0a0a0', padding: 20 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#3a3a3a' },
                        ticks: { color: '#a0a0a0' }
                    },
                    x: {
                        grid: { color: '#3a3a3a' },
                        ticks: { color: '#a0a0a0' }
                    }
                }
            }
        });
    </script>
{% endblock %}
