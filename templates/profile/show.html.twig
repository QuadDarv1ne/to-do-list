{% extends 'base.html.twig' %}

{% block title %}Мой профиль{% endblock %}

{% block stylesheets %}
{{ parent() }}
{% endblock %}

{% block body %}
{{ include('components/breadcrumbs.html.twig', {
    items: [
        {label: 'Главная', url: path('app_dashboard')},
        {label: 'Профиль', active: true}
    ]
}) }}

<div class="container mt-4 profile-container">
    <!-- Profile Header -->
    <div class="profile-header-card">
        <div class="profile-cover">
            <div class="profile-cover-pattern"></div>
        </div>
        <div class="profile-avatar-section">
            <div class="profile-avatar-wrapper">
                <div class="profile-avatar-container">
                    <div class="profile-avatar">
                        {% if user.avatar %}
                            <img src="{{ asset('uploads/avatars/' ~ user.avatar) }}" alt="{{ user.fullName }}">
                        {% else %}
                            {{ user.firstName|first }}{{ user.lastName|first }}
                        {% endif %}
                    </div>
                    <div class="profile-avatar-badge"></div>
                </div>
                <div class="profile-info">
                    <h1 class="profile-name">
                        {{ user.fullName }}
                        {% if user.isActive %}
                            <span class="profile-verified-badge">
                                <i class="fas fa-check"></i>
                            </span>
                        {% endif %}
                    </h1>
                    <div class="profile-role">
                        {% if user.hasRole('ROLE_ADMIN') %}
                            <i class="fas fa-crown"></i>Администратор
                        {% elseif user.hasRole('ROLE_MANAGER') %}
                            <i class="fas fa-user-tie"></i>Менеджер
                        {% else %}
                            <i class="fas fa-user"></i>Пользователь
                        {% endif %}
                    </div>
                    <div class="profile-meta">
                        <div class="profile-meta-item">
                            <i class="fas fa-at"></i>
                            {{ user.username }}
                        </div>
                        <div class="profile-meta-item">
                            <i class="fas fa-envelope"></i>
                            {{ user.email }}
                        </div>
                        {% if user.isTotpEnabled %}
                            <div class="profile-meta-item">
                                <i class="fas fa-shield-alt"></i>
                                2FA включена
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="{{ path('app_profile_edit') }}" class="profile-action-btn profile-action-btn-primary">
                        <i class="fas fa-edit"></i>Редактировать
                    </a>
                    <a href="{{ path('app_settings') }}" class="profile-action-btn profile-action-btn-secondary">
                        <i class="fas fa-cog"></i>Настройки
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="profile-stats">
        <div class="profile-stat-card">
            <div class="profile-stat-header">
                <div class="profile-stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="profile-stat-trend up">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
            <div class="profile-stat-value">{{ user.tasks|length }}</div>
            <div class="profile-stat-label">Всего задач</div>
        </div>
        
        <div class="profile-stat-card">
            <div class="profile-stat-header">
                <div class="profile-stat-icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="profile-stat-trend up">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
            <div class="profile-stat-value">{{ user.tasks|filter(t => t.isCompleted)|length }}</div>
            <div class="profile-stat-label">Завершено</div>
        </div>
        
        <div class="profile-stat-card">
            <div class="profile-stat-header">
                <div class="profile-stat-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <i class="fas fa-play-circle"></i>
                </div>
            </div>
            <div class="profile-stat-value">{{ user.tasks|filter(t => t.status == 'in_progress')|length }}</div>
            <div class="profile-stat-label">В работе</div>
        </div>
        
        <div class="profile-stat-card">
            <div class="profile-stat-header">
                <div class="profile-stat-icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div class="profile-stat-value">{{ user.tasks|filter(t => t.status == 'pending')|length }}</div>
            <div class="profile-stat-label">В ожидании</div>
        </div>
    </div>

    <!-- Contact Information -->
    <div class="profile-section">
        <div class="profile-section-header">
            <h3 class="profile-section-title">
                <i class="fas fa-address-card"></i>
                Контактная информация
            </h3>
        </div>
        <div class="profile-info-grid">
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-envelope"></i>Email
                </div>
                <div class="profile-info-value">
                    <a href="mailto:{{ user.email }}" class="text-decoration-none">{{ user.email }}</a>
                </div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-phone"></i>Телефон
                </div>
                <div class="profile-info-value">
                    {% if user.phone %}
                        <a href="tel:{{ user.phone }}" class="text-decoration-none">{{ user.phone }}</a>
                    {% else %}
                        <span class="text-muted">Не указан</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-calendar-plus"></i>Дата регистрации
                </div>
                <div class="profile-info-value">
                    {{ user.createdAt ? user.createdAt|date('d.m.Y H:i') : 'N/A' }}
                </div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-sign-in-alt"></i>Последний вход
                </div>
                <div class="profile-info-value">
                    {% if user.lastLoginAt %}
                        {{ user.lastLoginAt|date('d.m.Y H:i') }}
                    {% else %}
                        <span class="text-muted">Еще не входил</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="profile-section">
        <div class="profile-section-header">
            <h3 class="profile-section-title">
                <i class="fas fa-shield-alt"></i>
                Безопасность
            </h3>
            <a href="{{ path('app_2fa_setup') }}" class="profile-section-action">
                Настроить <i class="fas fa-arrow-right ms-1"></i>
            </a>
        </div>
        <div class="profile-info-grid">
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-lock"></i>Двухфакторная аутентификация
                </div>
                <div class="profile-info-value">
                    {% if user.isTotpEnabled %}
                        <span class="badge bg-success">Включена</span>
                    {% else %}
                        <span class="badge bg-secondary">Выключена</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">
                    <i class="fas fa-percentage"></i>Процент завершения задач
                </div>
                <div class="profile-info-value">
                    {% set total = user.tasks|length %}
                    {% set completed = user.tasks|filter(t => t.isCompleted)|length %}
                    {% set percentage = total > 0 ? (completed / total * 100)|round(1) : 0 %}
                    <div class="d-flex align-items-center gap-2">
                        <div class="progress flex-grow-1" style="height: 8px;">
                            <div class="progress-bar bg-success progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: {{ percentage }}%">
                            </div>
                        </div>
                        <strong>{{ percentage }}%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}