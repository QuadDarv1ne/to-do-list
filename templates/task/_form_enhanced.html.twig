{# templates/task/_form_enhanced.html.twig #}

{# Улучшенная форма задачи с real-time валидацией и авто-сохранением #}

<div class="task-form-enhanced" data-controller="task-form">
    {{ form_start(form, {
        attr: {
            'class': 'needs-validation',
            'data-validate-form': '',
            'data-auto-save': 'true',
            'novalidate': 'novalidate'
        }
    }) }}
    
    <div class="row">
        {# Основная информация #}
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Основная информация
                    </h5>
                </div>
                <div class="card-body">
                    {# Название задачи #}
                    <div class="mb-4">
                        {{ form_label(form.title, null, {
                            label_attr: {class: 'form-label fw-bold'}
                        }) }}
                        {{ form_widget(form.title, {
                            attr: {
                                class: 'form-control form-control-lg',
                                placeholder: 'Введите название задачи',
                                required: true,
                                minlength: 3,
                                maxlength: 200
                            }
                        }) }}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Краткое описание задачи (3-200 символов)
                        </div>
                    </div>

                    {# Описание #}
                    <div class="mb-4">
                        {{ form_label(form.description, null, {
                            label_attr: {class: 'form-label fw-bold'}
                        }) }}
                        {{ form_widget(form.description, {
                            attr: {
                                class: 'form-control',
                                rows: 5,
                                placeholder: 'Подробное описание задачи...',
                                'data-auto-resize': 'true'
                            }
                        }) }}
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">
                                <i class="fas fa-keyboard me-1"></i>
                                Поддерживается Markdown
                            </small>
                            <small class="text-muted" id="description-counter">0 символов</small>
                        </div>
                    </div>

                    {# Теги #}
                    <div class="mb-4">
                        {{ form_label(form.tags, null, {
                            label_attr: {class: 'form-label fw-bold'}
                        }) }}
                        {{ form_widget(form.tags, {
                            attr: {
                                class: 'form-control',
                                'data-placeholder': 'Выберите или введите теги'
                            }
                        }) }}
                        <div class="form-text">
                            <i class="fas fa-tag me-1"></i>
                            Выберите из списка или создайте новые (макс. 10)
                        </div>
                    </div>
                </div>
            </div>

            {# Дополнительные настройки #}
            <div class="card shadow-sm">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Настройки
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {# Приоритет #}
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.priority, null, {
                                label_attr: {class: 'form-label fw-bold'}
                            }) }}
                            {{ form_widget(form.priority, {
                                attr: {
                                    class: 'form-select'
                                }
                            }) }}
                        </div>

                        {# Статус #}
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.status, null, {
                                label_attr: {class: 'form-label fw-bold'}
                            }) }}
                            {{ form_widget(form.status, {
                                attr: {
                                    class: 'form-select'
                                }
                            }) }}
                        </div>
                    </div>

                    {# Даты #}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.dueDate, null, {
                                label_attr: {class: 'form-label fw-bold'}
                            }) }}
                            {{ form_widget(form.dueDate, {
                                attr: {
                                    class: 'form-control',
                                    'data-datepicker': 'true',
                                    'data-min-date': 'today'
                                }
                            }) }}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form_label(form.estimatedHours, null, {
                                label_attr: {class: 'form-label fw-bold'}
                            }) }}
                            {{ form_widget(form.estimatedHours, {
                                attr: {
                                    class: 'form-control',
                                    placeholder: '0',
                                    min: 0,
                                    max: 1000
                                }
                            }) }}
                            <div class="form-text">
                                <i class="fas fa-clock me-1"></i>
                                Часов
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Боковая панель #}
        <div class="col-lg-4">
            {# Исполнитель #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Исполнитель
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_row(form.assignee, {
                        attr: {
                            class: 'form-select'
                        }
                    }) }}
                </div>
            </div>

            {# Категория #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-folder me-2"></i>Категория
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_row(form.category, {
                        attr: {
                            class: 'form-select'
                        }
                    }) }}
                </div>
            </div>

            {# Зависимости #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>Зависимости
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_row(form.dependencies, {
                        attr: {
                            class: 'form-control',
                            'data-placeholder': 'Выберите зависимые задачи'
                        }
                    }) }}
                </div>
            </div>

            {# Вложения #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-paperclip me-2"></i>Вложения
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_row(form.attachments, {
                        attr: {
                            class: 'form-control',
                            'data-accept': '.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif',
                            'data-max-size': '10485760'
                        }
                    }) }}
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Макс. размер 10MB
                    </div>
                </div>
            </div>

            {# Кнопки действий #}
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>
                            {{ button_text|default('Сохранить задачу') }}
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Отмена
                        </button>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-save me-1"></i>
                            Автосохранение включено
                        </small>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearDraftBtn">
                            <i class="fas fa-trash me-1"></i>
                            Удалить черновик
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ form_end(form) }}
</div>

<style>
    .task-form-enhanced .card-header.bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .task-form-enhanced .form-control:focus,
    .task-form-enhanced .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .task-form-enhanced .is-valid {
        border-color: #10b981;
    }

    .task-form-enhanced .is-valid:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
    }

    .task-form-enhanced .is-invalid {
        border-color: #ef4444;
    }

    .task-form-enhanced .is-invalid:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25);
    }

    .task-form-enhanced .invalid-feedback {
        font-size: 0.875em;
        color: #ef4444;
        margin-top: 0.25rem;
    }

    .task-form-enhanced .form-text {
        font-size: 0.875em;
        color: #718096;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Авто-увеличение textarea
    const textareas = document.querySelectorAll('[data-auto-resize]');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            // Счётчик символов
            const counter = document.getElementById('description-counter');
            if (counter) {
                counter.textContent = this.value.length + ' символов';
            }
        });
    });

    // Очистка черновика
    const clearDraftBtn = document.getElementById('clearDraftBtn');
    if (clearDraftBtn) {
        clearDraftBtn.addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите удалить черновик?')) {
                const form = this.closest('form');
                const draftKey = 'form_draft_' + (form.id || form.action);
                localStorage.removeItem(draftKey);
                
                if (window.showToast) {
                    window.showToast('Черновик удалён', 'warning');
                }
            }
        });
    }

    // Datepicker с минимальной датой сегодня
    const dateInputs = document.querySelectorAll('[data-min-date="today"]');
    dateInputs.forEach(input => {
        const today = new Date().toISOString().split('T')[0];
        input.setAttribute('min', today);
    });
});
</script>
