{% extends 'base_sidebar.html.twig' %}

{% block page_title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É{% endblock %}

{% block body %}
<!-- Breadcrumb -->
<nav style="margin-bottom: 20px;">
    <ol style="list-style: none; padding: 0; display: flex; gap: 10px; color: var(--text-secondary); font-size: 14px;">
        <li><a href="{{ path('app_dashboard') }}" style="color: var(--text-secondary); text-decoration: none;">–ü–∞–Ω–µ–ª—å</a></li>
        <li>/</li>
        <li><a href="{{ path('app_task_index') }}" style="color: var(--text-secondary); text-decoration: none;">–ó–∞–¥–∞—á–∏</a></li>
        {% if parentTask %}
        <li>/</li>
        <li><a href="{{ path('app_task_show', {'id': parentTask.id}) }}" style="color: var(--text-secondary); text-decoration: none;">{{ parentTask.title }}</a></li>
        {% endif %}
        <li>/</li>
        <li style="color: var(--text-primary);">{% if parentTask %}–ü–æ–¥–∑–∞–¥–∞—á–∞{% else %}–°–æ–∑–¥–∞—Ç—å{% endif %}</li>
    </ol>
</nav>

<!-- Header -->
<div style="margin-bottom: 30px;">
    {% if parentTask %}
        <h2 style="margin: 0 0 10px 0; font-size: 32px; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É</h2>
        <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary);">
            <i class="fas fa-sitemap"></i>
            <span>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞:</span>
            <a href="{{ path('app_task_show', {'id': parentTask.id}) }}" style="color: var(--color-sales); text-decoration: none; font-weight: 600;">
                {{ parentTask.title }}
            </a>
        </div>
    {% else %}
        <h2 style="margin: 0 0 10px 0; font-size: 32px; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
        <p style="color: var(--text-secondary); margin: 0;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</p>
    {% endif %}
</div>

<!-- Form -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
    <!-- Main Form -->
    <div class="card">
        <div class="card-body">
            {{ form_start(form) }}
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                    –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                </label>
                {{ form_widget(form.title, {
                    'attr': {
                        'class': 'form-control',
                        'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; font-size: 16px; width: 100%;',
                        'placeholder': '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...'
                    }
                }) }}
                {{ form_errors(form.title) }}
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                    –û–ø–∏—Å–∞–Ω–∏–µ
                </label>
                {{ form_widget(form.description, {
                    'attr': {
                        'class': 'form-control',
                        'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; font-size: 14px; width: 100%; min-height: 150px;',
                        'placeholder': '–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ...',
                        'rows': 6
                    }
                }) }}
                {{ form_errors(form.description) }}
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div>
                    <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                        –°—Ç–∞—Ç—É—Å
                    </label>
                    {{ form_widget(form.status, {
                        'attr': {
                            'class': 'form-select',
                            'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;'
                        }
                    }) }}
                    {{ form_errors(form.status) }}
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                    </label>
                    {{ form_widget(form.priority, {
                        'attr': {
                            'class': 'form-select',
                            'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;'
                        }
                    }) }}
                    {{ form_errors(form.priority) }}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div>
                    <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                    </label>
                    {{ form_widget(form.category, {
                        'attr': {
                            'class': 'form-select',
                            'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;'
                        }
                    }) }}
                    {{ form_errors(form.category) }}
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                        –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    </label>
                    {{ form_widget(form.dueDate, {
                        'attr': {
                            'class': 'form-control',
                            'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;'
                        }
                    }) }}
                    {{ form_errors(form.dueDate) }}
                </div>
            </div>
            
            {% if form.assignedUser is defined %}
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                    –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                </label>
                {{ form_widget(form.assignedUser, {
                    'attr': {
                        'class': 'form-select',
                        'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;'
                    }
                }) }}
                {{ form_errors(form.assignedUser) }}
            </div>
            {% endif %}
            
            {% if form.tags is defined %}
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                    –¢–µ–≥–∏
                </label>
                {{ form_widget(form.tags, {
                    'attr': {
                        'class': 'form-select',
                        'style': 'background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 16px; border-radius: 10px; width: 100%;',
                        'multiple': 'multiple',
                        'size': '5'
                    }
                }) }}
                <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                    –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ–≥–æ–≤
                </small>
                {{ form_errors(form.tags) }}
            </div>
            {% endif %}

            {% if form.progress is defined %}
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase;">
                        –ü—Ä–æ–≥—Ä–µ—Å—Å
                    </label>
                    <span id="progress-value" style="font-size: 18px; font-weight: 700; color: var(--text-primary);">0%</span>
                </div>
                {{ form_widget(form.progress, {
                    'attr': {
                        'style': 'width: 100%; accent-color: var(--color-sales);',
                        'id': 'task_progress'
                    }
                }) }}
                <div style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; margin-top: 8px;">
                    <div id="progress-bar" style="height: 100%; width: 0%; background: var(--color-sales); border-radius: 3px; transition: width 0.2s;"></div>
                </div>
            </div>
            {% endif %}

            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button type="submit" class="btn" style="background: var(--color-sales); border: none; color: #000; padding: 14px 32px; border-radius: 10px; font-weight: 600; font-size: 16px;">
                    <i class="fas fa-check me-2"></i>{% if parentTask %}–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É{% else %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É{% endif %}
                </button>
                <a href="{{ parentTask ? path('app_task_show', {'id': parentTask.id}) : path('app_task_index') }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 14px 32px; border-radius: 10px; font-weight: 600; font-size: 16px; text-decoration: none; display: inline-flex; align-items: center;">
                    <i class="fas fa-times me-2"></i>–û—Ç–º–µ–Ω–∞
                </a>
            </div>
            
            {{ form_end(form) }}
        </div>
    </div>
    
    <!-- Sidebar Tips -->
    <div>
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">üí° –°–æ–≤–µ—Ç—ã</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <div style="color: var(--color-sales); font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-lightbulb me-2"></i>–ù–∞–∑–≤–∞–Ω–∏–µ
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        </p>
                    </div>
                    
                    <div>
                        <div style="color: var(--color-orders); font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-flag me-2"></i>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                            –í—ã—Å–æ–∫–∏–π - —Å—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è
                        </p>
                    </div>
                    
                    <div>
                        <div style="color: var(--color-bonuses); font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-calendar me-2"></i>–°—Ä–æ–∫
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                        </p>
                    </div>
                    
                    <div>
                        <div style="color: var(--color-clients); font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-tags me-2"></i>–¢–µ–≥–∏
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 12px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                        <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">Ctrl + S</kbd>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">–û—Ç–º–µ–Ω–∞</span>
                        <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color);">Esc</kbd>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', (e) => {
    // Ctrl + S –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.querySelector('form').submit();
    }
    
    // Esc –¥–ª—è –æ—Ç–º–µ–Ω—ã
    if (e.key === 'Escape') {
        window.location.href = '{{ path('app_task_index') }}';
    }
});

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
const form = document.querySelector('form');
const inputs = form.querySelectorAll('input, textarea, select');

inputs.forEach(input => {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const savedValue = localStorage.getItem('task_form_' + input.name);
    if (savedValue && !input.value) {
        input.value = savedValue;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    input.addEventListener('change', () => {
        localStorage.setItem('task_form_' + input.name, input.value);
    });
});

// –û—á–∏—Å—Ç–∏—Ç—å localStorage –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
form.addEventListener('submit', () => {
    inputs.forEach(input => {
        localStorage.removeItem('task_form_' + input.name);
    });
});

// –°–ª–∞–π–¥–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
const progressSlider = document.getElementById('task_progress');
if (progressSlider) {
    const progressValue = document.getElementById('progress-value');
    const progressBar = document.getElementById('progress-bar');

    function updateProgress(val) {
        progressValue.textContent = val + '%';
        progressBar.style.width = val + '%';
        const color = val == 100 ? 'var(--color-sales)' : val >= 50 ? 'var(--color-orders)' : 'var(--color-bonuses)';
        progressBar.style.background = color;
    }

    progressSlider.addEventListener('input', () => updateProgress(progressSlider.value));
    updateProgress(progressSlider.value);
}
</script>
{% endblock %}
