{% extends 'base.html.twig' %}

{% block title %}Мои задачи{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="mb-0">
                        <i class="fas fa-tasks me-3 text-primary"></i>
                        Мои задачи
                    </h1>
                    <p class="text-muted mb-0">Управляйте своими задачами и отслеживайте прогресс</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#quickTaskModal">
                        <i class="fas fa-bolt me-2"></i>
                        Быстрое создание
                    </button>
                    <a href="{{ path('app_task_new') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>
                        Создать задачу
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2 text-primary"></i>
                    Фильтры и поиск
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="toggleFilters">
                        <i class="fas fa-sliders-h me-1"></i>Фильтры
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                        <i class="fas fa-times me-1"></i>Очистить
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body" id="filtersBody">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="search" class="form-label">Поиск</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ app.request.query.get('search') ?: searchQuery }}" 
                               placeholder="Поиск по названию или описанию">
                    </div>
                </div>
                
                <div class="col-md-2">
                    <label for="status" class="form-label">Статус</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Все статусы</option>
                        <option value="pending" {{ app.request.query.get('status') == 'pending' ? 'selected' : '' }}>
                            В ожидании
                        </option>
                        <option value="in_progress" {{ app.request.query.get('status') == 'in_progress' ? 'selected' : '' }}>
                            В процессе
                        </option>
                        <option value="completed" {{ app.request.query.get('status') == 'completed' ? 'selected' : '' }}>
                            Завершено
                        </option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="priority" class="form-label">Приоритет</label>
                    <select class="form-select" id="priority" name="priority">
                        <option value="">Все приоритеты</option>
                        <option value="low" {{ app.request.query.get('priority') == 'low' ? 'selected' : '' }}>
                            Низкий
                        </option>
                        <option value="medium" {{ app.request.query.get('priority') == 'medium' ? 'selected' : '' }}>
                            Средний
                        </option>
                        <option value="high" {{ app.request.query.get('priority') == 'high' ? 'selected' : '' }}>
                            Высокий
                        </option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="category" class="form-label">Категория</label>
                    <select class="form-select" id="category" name="category">
                        <option value="">Все категории</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {{ app.request.query.get('category') == category.id ? 'selected' : '' }}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="tag" class="form-label">Тег</label>
                    <select class="form-select" id="tag" name="tag">
                        <option value="">Все теги</option>
                        {% for tag in tags %}
                            <option value="{{ tag.id }}" {{ app.request.query.get('tag') == tag.id ? 'selected' : '' }}>
                                {{ tag.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-1 d-flex align-items-end">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="hide-completed" name="hide_completed" value="1" {{ app.request.query.get('hide_completed') == '1' ? 'checked' : '' }}>
                        <label class="form-check-label" for="hide-completed">
                            Скрыть выполненные
                        </label>
                    </div>
                </div>
                
                <div class="col-md-2 d-flex align-items-end">
                    <div class="btn-group w-100" role="group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-1"></i>
                            Фильтровать
                        </button>
                        <a href="{{ path('app_task_index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                        <a href="{{ path('app_task_export', app.request.query.all) }}" class="btn btn-success">
                            <i class="fas fa-download me-1"></i>
                            Экспорт
                        </a>
                        <a href="{{ path('app_task_export_with_tags', app.request.query.all) }}" class="btn btn-info">
                            <i class="fas fa-tags me-1"></i>
                            Экспорт с тегами
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Advanced Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-sliders-h me-2 text-secondary"></i>
                Расширенные фильтры
                <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="advancedFilters">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <!-- Preserve existing filters -->
                    <input type="hidden" name="search" value="{{ app.request.query.get('search') ?: searchQuery }}">
                    <input type="hidden" name="status" value="{{ app.request.query.get('status') }}">
                    <input type="hidden" name="priority" value="{{ app.request.query.get('priority') }}">
                    <input type="hidden" name="category" value="{{ app.request.query.get('category') }}">
                    <input type="hidden" name="tag" value="{{ app.request.query.get('tag') }}">
                    <input type="hidden" name="hide_completed" value="{{ app.request.query.get('hide_completed') }}">
                    <input type="hidden" name="start_date" value="{{ app.request.query.get('start_date') }}">
                    <input type="hidden" name="end_date" value="{{ app.request.query.get('end_date') }}">
                    
                    <div class="col-md-3">
                        <label for="created_after" class="form-label">Создано после</label>
                        <input type="date" class="form-control" id="created_after" name="created_after" 
                               value="{{ app.request.query.get('created_after') }}">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="created_before" class="form-label">Создано до</label>
                        <input type="date" class="form-control" id="created_before" name="created_before" 
                               value="{{ app.request.query.get('created_before') }}">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="sort_by" class="form-label">Сортировать по</label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="" {{ app.request.query.get('sort_by') == '' ? 'selected' : '' }}>По умолчанию</option>
                            <option value="title" {{ app.request.query.get('sort_by') == 'title' ? 'selected' : '' }}>Название</option>
                            <option value="createdAt" {{ app.request.query.get('sort_by') == 'createdAt' ? 'selected' : '' }}>Дата создания</option>
                            <option value="dueDate" {{ app.request.query.get('sort_by') == 'dueDate' ? 'selected' : '' }}>Срок выполнения</option>
                            <option value="priority" {{ app.request.query.get('sort_by') == 'priority' ? 'selected' : '' }}>Приоритет</option>
                            <option value="status" {{ app.request.query.get('sort_by') == 'status' ? 'selected' : '' }}>Статус</option>
                            <option value="tag_count" {{ app.request.query.get('sort_by') == 'tag_count' ? 'selected' : '' }}>Количество тегов</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="sort_direction" class="form-label">Направление</label>
                        <select class="form-select" id="sort_direction" name="sort_direction">
                            <option value="DESC" {{ app.request.query.get('sort_direction') == 'DESC' ? 'selected' : '' }}>По убыванию</option>
                            <option value="ASC" {{ app.request.query.get('sort_direction') == 'ASC' ? 'selected' : '' }}>По возрастанию</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="assigned_to_me" name="assigned_to_me" 
                                   value="1" {{ app.request.query.get('assigned_to_me') == '1' ? 'checked' : '' }}>
                            <label class="form-check-label" for="assigned_to_me">
                                Назначено мне
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="created_by_me" name="created_by_me" 
                                   value="1" {{ app.request.query.get('created_by_me') == '1' ? 'checked' : '' }}>
                            <label class="form-check-label" for="created_by_me">
                                Создано мной
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="overdue" name="overdue" 
                                   value="1" {{ app.request.query.get('overdue') == '1' ? 'checked' : '' }}>
                            <label class="form-check-label" for="overdue">
                                Просрочено
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-1"></i>
                                Применить фильтры
                            </button>
                            <a href="{{ path('app_task_index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>
                                Сбросить все фильтры
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card dashboard-card-enhanced border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-3 d-inline-block mb-3">
                        <i class="fas fa-tasks fa-2x text-primary"></i>
                    </div>
                    <h3 class="stat-number mb-0 text-primary">{{ tasks|length }}</h3>
                    <p class="stat-label mb-0">Всего задач</p>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card dashboard-card-enhanced border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-warning bg-opacity-10 p-3 d-inline-block mb-3">
                        <i class="fas fa-clock fa-2x text-warning"></i>
                    </div>
                    <h3 class="stat-number mb-0 text-warning">
                        {{ tasks|filter(t => t.status == 'pending')|length }}
                    </h3>
                    <p class="stat-label mb-0">В ожидании</p>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (tasks|filter(t => t.status == 'pending')|length / tasks|length * 100)|round(0) }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card dashboard-card-enhanced border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-info bg-opacity-10 p-3 d-inline-block mb-3">
                        <i class="fas fa-play-circle fa-2x text-info"></i>
                    </div>
                    <h3 class="stat-number mb-0 text-info">
                        {{ tasks|filter(t => t.status == 'in_progress')|length }}
                    </h3>
                    <p class="stat-label mb-0">В процессе</p>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ (tasks|filter(t => t.status == 'in_progress')|length / tasks|length * 100)|round(0) }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card dashboard-card-enhanced border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-success bg-opacity-10 p-3 d-inline-block mb-3">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                    <h3 class="stat-number mb-0 text-success">
                        {{ tasks|filter(t => t.status == 'completed')|length }}
                    </h3>
                    <p class="stat-label mb-0">Завершено</p>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ (tasks|filter(t => t.status == 'completed')|length / tasks|length * 100)|round(0) }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks List -->
    <form method="post" action="{{ path('app_task_bulk_action') }}" id="bulk-actions-form">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center">
                    <div class="form-check me-3">
                        <input type="checkbox" class="form-check-input" id="select-all-tasks">
                        <label class="form-check-label" for="select-all-tasks"></label>
                    </div>
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2 text-secondary"></i>
                        Список задач
                    </h5>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="dragModeToggle" title="Режим перетаскивания">
                        <i class="fas fa-arrows-alt me-1"></i>Перетаскивание
                    </button>
                <div class="btn-group" role="group">
                    <a href="{{ path('app_task_index', app.request.query.all|merge({'sort': 'createdAt', 'direction': app.request.query.get('direction') == 'ASC' ? 'DESC' : 'ASC'})) }}" 
                       class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Сортировать по дате создания">
                        <i class="fas fa-sort-amount-{{ app.request.query.get('direction') == 'ASC' ? 'up' : 'down' }} me-1"></i>
                        По дате
                    </a>
                    <a href="{{ path('app_task_index', app.request.query.all|merge({'sort': 'priority', 'direction': app.request.query.get('direction') == 'ASC' ? 'DESC' : 'ASC'})) }}" 
                       class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Сортировать по приоритету">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Приоритет
                    </a>
                    <a href="{{ path('app_task_index', app.request.query.all|merge({'sort': 'tag_count', 'direction': app.request.query.get('direction') == 'ASC' ? 'DESC' : 'ASC'})) }}" 
                       class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Сортировать по количеству тегов">
                        <i class="fas fa-tags me-1"></i>
                        Теги
                    </a>
                </div>
                </div>
            </div>
        </div>
        
        <!-- Bulk Action Controls -->
        <div id="bulk-actions-container" class="card-header bg-light d-none">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selected-count">Выбрано: 0</span>
                </div>
                <div class="btn-group" role="group">
                    <select name="action" class="form-select me-2" style="width: auto;" id="bulk-action-select">
                        <option value="">Действие с выбранными</option>
                        <option value="mark_completed">Отметить как выполненные</option>
                        <option value="mark_in_progress">Отметить как в процессе</option>
                        <option value="mark_pending">Отметить как ожидаемые</option>
                        <option value="set_priority_high">Установить высокий приоритет</option>
                        <option value="set_priority_medium">Установить средний приоритет</option>
                        <option value="set_priority_low">Установить низкий приоритет</option>
                        <option value="assign_tag">Назначить теги</option>
                        <option value="delete">Удалить</option>
                    </select>
                    <div id="tag-selection-container" class="me-2" style="display: none;">
                        <select name="tag_ids[]" multiple class="form-select" size="3">
                            {% for tag in tags %}
                                <option value="{{ tag.id }}">{{ tag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm" id="execute-bulk-action">
                        <i class="fas fa-play me-1"></i>
                        Выполнить
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-bulk-selection">
                        <i class="fas fa-times me-1"></i>
                        Отмена
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if tasks is not empty %}
                <div class="list-group list-group-flush">
                    {% for task in tasks %}
                        <div class="list-group-item task-item task-item-enhanced border-0 px-4 py-3 priority-{{ task.priority }} {% if task.priority == 'high' %}priority-high-glow{% elseif task.priority == 'medium' %}priority-medium-glow{% else %}priority-low-glow{% endif %}" data-task-id="{{ task.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="form-check me-3">
                                    <input type="checkbox" class="form-check-input task-checkbox" name="task_ids[]" value="{{ task.id }}" id="task-{{ task.id }}">
                                    <label class="form-check-label" for="task-{{ task.id }}"></label>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h5 class="task-title mb-0 me-3">
                                            <a href="{{ path('app_task_show', {'id': task.id}) }}" class="text-decoration-none">
                                                {{ task.title }}
                                            </a>
                                        </h5>
                                        
                                        <div class="d-flex gap-2">
                                            <span class="badge badge-{{ task.status|lower }} badge-animated" data-bs-toggle="tooltip" title="Статус задачи">
                                                {{ task.status|trans }}
                                            </span>
                                            
                                            {% if task.priority == 'high' %}
                                                <span class="badge bg-danger badge-animated" data-bs-toggle="tooltip" title="Высокий приоритет">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Высокий
                                                </span>
                                            {% elseif task.priority == 'medium' %}
                                                <span class="badge bg-warning text-dark badge-animated" data-bs-toggle="tooltip" title="Средний приоритет">
                                                    <i class="fas fa-exclamation me-1"></i>
                                                    Средний
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success badge-animated" data-bs-toggle="tooltip" title="Низкий приоритет">
                                                    <i class="fas fa-arrow-down me-1"></i>
                                                    Низкий
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="task-meta mb-2">
                                        <i class="fas fa-folder me-1"></i>
                                        {% if task.category %}
                                            <span class="badge bg-light text-dark me-2">{{ task.category.name }}</span>
                                        {% else %}
                                            <span class="text-muted me-2">Без категории</span>
                                        {% endif %}
                                        
                                        <i class="fas fa-calendar me-1"></i>
                                        Создано: {{ task.createdAt|date('d.m.Y H:i') }}
                                        
                                        {% if task.dueDate %}
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock me-1"></i>
                                            Срок: {{ task.dueDate|date('d.m.Y') }}
                                            {% if task.isOverdue %}
                                                <span class="badge bg-danger ms-1">
                                                    <i class="fas fa-exclamation-circle me-1"></i>
                                                    Просрочено
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    
                                    {% if task.description %}
                                        <p class="task-description mb-0">
                                            {{ task.description|slice(0, 150) }}{% if task.description|length > 150 %}...{% endif %}
                                        </p>
                                    {% endif %}
                                    
                                    {% if task.tags is not empty %}
                                    <div class="mt-2">
                                        {% for tag in task.tags %}
                                            <span class="badge me-1" style="background-color: {{ tag.color }}; color: white; font-size: 0.75em;">{{ tag.name }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="dropdown">
                                    <button class="btn btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{{ path('app_task_show', {'id': task.id}) }}">
                                                <i class="fas fa-eye me-2"></i>Просмотр
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{{ path('app_task_edit', {'id': task.id}) }}">
                                                <i class="fas fa-edit me-2"></i>Редактировать
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" 
                                               onclick="if(confirm('Удалить задачу?')) { window.location='{{ path('app_task_delete', {'id': task.id}) }}'; }">
                                                <i class="fas fa-trash me-2"></i>Удалить
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if totalPages > 1 %}
                    <div class="card-footer bg-white">
                        <nav>
                            <ul class="pagination justify-content-center mb-0">
                                {% if currentPage > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('app_task_index', app.request.query.all|merge({'page': currentPage - 1})) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for i in 1..totalPages %}
                                    <li class="page-item {{ i == currentPage ? 'active' : '' }}">
                                        <a class="page-link" href="{{ path('app_task_index', app.request.query.all|merge({'page': i})) }}">{{ i }}</a>
                                    </li>
                                {% endfor %}
                                
                                {% if currentPage < totalPages %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('app_task_index', app.request.query.all|merge({'page': currentPage + 1})) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state py-5" id="tasks-empty-state">
                    <div class="mb-4">
                        <div class="skeleton skeleton-avatar mx-auto mb-3"></div>
                        <div class="skeleton skeleton-text mx-auto" style="width: 60%;"></div>
                    </div>
                    <i class="fas fa-tasks mb-3"></i>
                    <h4 class="mb-3">Задачи не найдены</h4>
                    <p class="mb-4">Попробуйте изменить параметры поиска или фильтрации</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-center mb-4">
                        <a href="{{ path('app_task_new') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Создать задачу
                        </a>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#quickTaskModal">
                            <i class="fas fa-bolt me-2"></i>Быстрое создание
                        </button>
                        <a href="{{ path('app_task_index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Сбросить фильтры
                        </a>
                    </div>
                    <div class="card border-0 bg-light">
                        <div class="card-body text-center">
                            <h6 class="mb-3">Советы по поиску:</h6>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-search me-1"></i>
                                        Используйте поиск по названию или описанию
                                    </small>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-filter me-1"></i>
                                        Примените фильтры по статусу и приоритету
                                    </small>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-keyboard me-1"></i>
                                        Горячая клавиша <kbd class="kbd-shortcut">F</kbd> для поиска
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</form>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter toggle functionality
    const toggleFiltersBtn = document.getElementById('toggleFilters');
    const filtersBody = document.getElementById('filtersBody');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    if (toggleFiltersBtn && filtersBody) {
        toggleFiltersBtn.addEventListener('click', function() {
            const isHidden = filtersBody.style.display === 'none';
            filtersBody.style.display = isHidden ? 'block' : 'none';
            this.innerHTML = isHidden ? 
                '<i class="fas fa-sliders-h me-1"></i>Скрыть фильтры' : 
                '<i class="fas fa-sliders-h me-1"></i>Фильтры';
        });
    }
    
    // Clear filters functionality
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            const form = filtersBody.querySelector('form');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Reset to default page
            window.location.href = '{{ path('app_task_index') }}';
        });
    }
    
    // Auto-submit on filter change (optional)
    const filterInputs = document.querySelectorAll('#filtersBody input, #filtersBody select');
    filterInputs.forEach(input => {
        if (input.type !== 'submit' && input.type !== 'button') {
            input.addEventListener('change', function() {
                // Uncomment the next line to auto-submit on filter change
                // this.form.submit();
            });
        }
    });
    
    // Enhanced task item interactions
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        // Add hover effect
        item.addEventListener('mouseenter', function() {
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.boxShadow = '';
        });
        
        // Add click effect
        const taskLink = item.querySelector('.task-title a');
        if (taskLink) {
            taskLink.addEventListener('click', function(e) {
                item.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    item.style.transform = '';
                }, 150);
            });
        }
    });
    
    // Keyboard shortcuts for task list
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key.toLowerCase()) {
            case 'r':
                e.preventDefault();
                window.location.reload();
                break;
            case 'f':
                e.preventDefault();
                document.getElementById('search')?.focus();
                break;
        }
    });
    
    // Add tooltips to action buttons
    const actionButtons = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    actionButtons.forEach(button => {
        new bootstrap.Tooltip(button);
    });
    
    // Drag and drop functionality
    let dragModeEnabled = false;
    const dragModeToggle = document.getElementById('dragModeToggle');
    
    if (dragModeToggle) {
        dragModeToggle.addEventListener('click', function() {
            dragModeEnabled = !dragModeEnabled;
            
            if (dragModeEnabled) {
                this.classList.add('btn-primary');
                this.classList.remove('btn-outline-primary');
                this.innerHTML = '<i class="fas fa-lock me-1"></i>Перетаскивание вкл';
                enableDragMode();
            } else {
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
                this.innerHTML = '<i class="fas fa-arrows-alt me-1"></i>Перетаскивание';
                disableDragMode();
            }
        });
    }
    
    function enableDragMode() {
        const taskItems = document.querySelectorAll('.task-item');
        taskItems.forEach(item => {
            item.setAttribute('draggable', 'true');
            item.classList.add('draggable');
            
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragenter', handleDragEnter);
            item.addEventListener('dragleave', handleDragLeave);
        });
        
        showToast('Режим перетаскивания включен. Перетаскивайте задачи для изменения порядка.', 'info');
    }
    
    function disableDragMode() {
        const taskItems = document.querySelectorAll('.task-item');
        taskItems.forEach(item => {
            item.setAttribute('draggable', 'false');
            item.classList.remove('draggable', 'drop-zone', 'drag-over');
            
            item.removeEventListener('dragstart', handleDragStart);
            item.removeEventListener('dragover', handleDragOver);
            item.removeEventListener('drop', handleDrop);
            item.removeEventListener('dragenter', handleDragEnter);
            item.removeEventListener('dragleave', handleDragLeave);
        });
        
        showToast('Режим перетаскивания выключен', 'info');
    }
    
    let draggedItem = null;
    
    function handleDragStart(e) {
        draggedItem = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('opacity-50');
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragEnter(e) {
        this.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        if (draggedItem !== this) {
            // Swap the elements
            const temp = this.innerHTML;
            this.innerHTML = draggedItem.innerHTML;
            draggedItem.innerHTML = temp;
            
            // Show success feedback
            this.classList.add('bg-success', 'bg-opacity-10');
            draggedItem.classList.add('bg-success', 'bg-opacity-10');
            
            setTimeout(() => {
                this.classList.remove('bg-success', 'bg-opacity-10');
                draggedItem.classList.remove('bg-success', 'bg-opacity-10');
            }, 1000);
            
            showToast('Порядок задач изменен', 'success');
        }
        
        return false;
    }
    
    // Enhanced bulk actions with confirmation
    const bulkActionForm = document.getElementById('bulk-actions-form');
    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            const action = bulkActionForm.querySelector('select[name="action"]').value;
            const checkedCount = document.querySelectorAll('.task-checkbox:checked').length;
            
            if (checkedCount === 0) {
                e.preventDefault();
                showToast('Пожалуйста, выберите хотя бы одну задачу', 'warning');
                return;
            }
            
            if (action === 'delete') {
                if (!confirm(`Вы уверены, что хотите удалить ${checkedCount} задач(и)? Это действие нельзя отменить.`)) {
                    e.preventDefault();
                }
            } else if (action) {
                showToast(`Выполняется действие: ${getActionName(action)} для ${checkedCount} задач(и)...`, 'info');
            }
        });
    }
    
    function getActionName(action) {
        const actions = {
            'mark_completed': 'Отметить как выполненные',
            'mark_in_progress': 'Отметить как в процессе',
            'mark_pending': 'Отметить как ожидаемые',
            'set_priority_high': 'Установить высокий приоритет',
            'set_priority_medium': 'Установить средний приоритет',
            'set_priority_low': 'Установить низкий приоритет',
            'assign_tag': 'Назначить теги',
            'delete': 'Удалить'
        };
        return actions[action] || action;
    }
    const selectAllCheckbox = document.getElementById('select-all-tasks');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
    const bulkActionsContainer = document.getElementById('bulk-actions-container');
    const selectedCountSpan = document.getElementById('selected-count');
    const cancelBulkSelectionBtn = document.getElementById('cancel-bulk-selection');
    
    // Select/deselect all tasks
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionsVisibility();
        });
    }
    
    // Handle individual task checkbox changes
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActionsVisibility();
        });
    });
    
    // Show/hide bulk actions container and update count
    function updateBulkActionsVisibility() {
        const checkedCount = document.querySelectorAll('.task-checkbox:checked').length;
        
        if (checkedCount > 0) {
            bulkActionsContainer.classList.remove('d-none');
            selectedCountSpan.textContent = `Выбрано: ${checkedCount}`;
        } else {
            bulkActionsContainer.classList.add('d-none');
        }
        
        // Update select all checkbox state
        if (selectAllCheckbox) {
            const allChecked = taskCheckboxes.length > 0 && 
                              [...taskCheckboxes].every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }
    }
    
    // Cancel bulk selection
    if (cancelBulkSelectionBtn) {
        cancelBulkSelectionBtn.addEventListener('click', function() {
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            bulkActionsContainer.classList.add('d-none');
        });
    }
    
    // Confirmation for delete action
    const bulkActionForm = document.getElementById('bulk-actions-form');
    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            const action = bulkActionForm.querySelector('select[name="action"]').value;
            if (action === 'delete') {
                const checkedCount = document.querySelectorAll('.task-checkbox:checked').length;
                if (!confirm(`Вы уверены, что хотите удалить ${checkedCount} задач(и)?`)) {
                    e.preventDefault();
                }
            }
        });
    }
    
    // Handle tag selection visibility based on selected action
    const bulkActionSelect = document.getElementById('bulk-action-select');
    const tagSelectionContainer = document.getElementById('tag-selection-container');
    
    if (bulkActionSelect && tagSelectionContainer) {
        bulkActionSelect.addEventListener('change', function() {
            if (this.value === 'assign_tag') {
                tagSelectionContainer.style.display = 'block';
            } else {
                tagSelectionContainer.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}