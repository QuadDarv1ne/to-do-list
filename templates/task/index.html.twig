{% extends 'base.html.twig' %}

{% block title %}Задачи{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h3">Список задач</h2>
                <div class="d-flex gap-2">
                    <a href="{{ path('app_task_export', app.request.query.all) }}" class="btn btn-success">
                        <i class="fas fa-file-export me-2"></i>Экспорт CSV
                    </a>
                    <a href="{{ path('app_task_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Создать задачу
                    </a>
                </div>
            </div>
            
            <!-- Filter Form -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Фильтры</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="status" class="form-label">Статус</label>
                            <select name="status" id="status" class="form-select">
                                <option value="all" {% if statusFilter == 'all' or statusFilter is null %}selected{% endif %}>Все статусы</option>
                                <option value="not_done" {% if statusFilter == 'not_done' %}selected{% endif %}>В работе</option>
                                <option value="done" {% if statusFilter == 'done' %}selected{% endif %}>Выполнено</option>
                            </select>
                        </div>
                        {% if usersList %}
                        <div class="col-md-3">
                            <label for="assignedUser" class="form-label">Назначена пользователю</label>
                            <select name="assignedUser" id="assignedUser" class="form-select">
                                <option value="all" {% if assignedUserFilter == 'all' or assignedUserFilter is null %}selected{% endif %}>Все пользователи</option>
                                {% for user in usersList %}
                                <option value="{{ user.id }}" {% if assignedUserFilter == user.id %}selected{% endif %}>
                                    {{ user.fullName }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">Дата от</label>
                            <input type="date" name="dateFrom" id="dateFrom" class="form-control" value="{{ dateFromFilter }}">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">Дата до</label>
                            <input type="date" name="dateTo" id="dateTo" class="form-control" value="{{ dateToFilter }}">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Применить фильтры
                            </button>
                            <a href="{{ path('app_task_index') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Сбросить
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if tasks %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Описание</th>
                            <th>Статус</th>
                            <th>Приоритет</th>
                            <th>Срок</th>
                            <th>Назначена</th>
                            <th>Дата создания</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td>{{ task.name }}</td>
                            <td>{{ task.description|truncate(50) }}</td>
                            <td>
                                {% if task.isDone %}
                                    <span class="badge bg-success">Выполнена</span>
                                {% else %}
                                    {% if task.isOverdue %}
                                        <span class="badge bg-danger">Просрочена</span>
                                    {% else %}
                                        <span class="badge bg-warning">В работе</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <span class="{{ task.priorityClass }}">{{ task.priorityLabel }}</span>
                            </td>
                            <td>
                                {% if task.deadline %}
                                    <span {% if task.isOverdue %}class="text-danger fw-bold"{% endif %}>{{ task.deadline|date('d.m.Y') }}</span>
                                {% else %}
                                    <span class="text-muted">Не указан</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.assignedUser %}
                                    {{ task.assignedUser.fullName }}
                                {% else %}
                                    Не назначена
                                {% endif %}
                            </td>
                            <td>{{ task.createdAt|date('d.m.Y H:i') }}</td>
                            <td>
                                <a href="{{ path('app_task_show', {'id': task.id}) }}" class="btn btn-sm btn-outline-primary me-1">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ path('app_task_edit', {'id': task.id}) }}" class="btn btn-sm btn-outline-secondary me-1">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if task.assignedUser == app.user or app.user.hasRole('ROLE_ADMIN') %}
                                <form method="post" action="{{ path('app_task_toggle', {'id': task.id}) }}" style="display: inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('toggle' ~ task.id) }}">
                                    <button class="btn btn-sm btn-outline-{% if task.isDone %}warning{% else %}success{% endif %}" type="submit">
                                        <i class="fas fa-{% if task.isDone %}undo{% else %}check{% endif %}"></i>
                                    </button>
                                </form>
                                <form method="post" action="{{ path('app_task_delete', {'id': task.id}) }}" style="display: inline-block;" onsubmit="return confirm('Вы уверены, что хотите удалить эту задачу?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ task.id) }}">
                                    <button class="btn btn-sm btn-outline-danger" type="submit">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                Задачи не найдены.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}