{% extends 'base_sidebar.html.twig' %}

{% block page_title %}Задачи{% endblock %}

{% block body %}
<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
        <h2 style="margin: 0; font-size: 28px; font-weight: 600;">Задачи</h2>
        <p style="color: var(--text-secondary); margin: 5px 0 0 0;">Управление заказами и сделками</p>
    </div>
    <a href="{{ path('app_task_new') }}" class="btn btn-primary" style="background: var(--color-sales); border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600;">
        <i class="fas fa-plus me-2"></i>Создать задачу
    </a>
</div>

<!-- Stats Overview -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border-color);">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--color-sales); color: #000;">
                <i class="fas fa-tasks"></i>
            </div>
            <span>Всего</span>
        </div>
        <div class="stat-value">{{ tasks|length }}</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border-color);">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--color-orders); color: #000;">
                <i class="fas fa-clock"></i>
            </div>
            <span>В ожидании</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'pending')|length }}</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border-color);">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--color-bonuses); color: #fff;">
                <i class="fas fa-spinner"></i>
            </div>
            <span>В процессе</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'in_progress')|length }}</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border-color);">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--color-clients); color: #fff;">
                <i class="fas fa-check"></i>
            </div>
            <span>Завершено</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'completed')|length }}</div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" 
                       class="form-control" 
                       name="search" 
                       value="{{ app.request.query.get('search') }}" 
                       placeholder="Поиск по названию..."
                       style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 16px; border-radius: 10px;">
            </div>
            
            <div class="col-md-2">
                <select class="form-select" name="status" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 16px; border-radius: 10px;">
                    <option value="">Все статусы</option>
                    <option value="pending" {{ app.request.query.get('status') == 'pending' ? 'selected' : '' }}>В ожидании</option>
                    <option value="in_progress" {{ app.request.query.get('status') == 'in_progress' ? 'selected' : '' }}>В процессе</option>
                    <option value="completed" {{ app.request.query.get('status') == 'completed' ? 'selected' : '' }}>Завершено</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <select class="form-select" name="priority" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 16px; border-radius: 10px;">
                    <option value="">Все приоритеты</option>
                    <option value="low" {{ app.request.query.get('priority') == 'low' ? 'selected' : '' }}>Низкий</option>
                    <option value="medium" {{ app.request.query.get('priority') == 'medium' ? 'selected' : '' }}>Средний</option>
                    <option value="high" {{ app.request.query.get('priority') == 'high' ? 'selected' : '' }}>Высокий</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <button type="submit" class="btn w-100" style="background: var(--color-sales); border: none; color: #000; padding: 12px; border-radius: 10px; font-weight: 600;">
                    <i class="fas fa-filter me-1"></i>Применить
                </button>
            </div>
            
            <div class="col-md-2">
                <a href="{{ path('app_task_index') }}" class="btn w-100" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px; border-radius: 10px; font-weight: 600;">
                    <i class="fas fa-times me-1"></i>Сбросить
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tasks List -->
<div class="card">
    <div class="card-header" style="border-bottom: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Список задач</h3>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-sm" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 8px;">
                    <i class="fas fa-th-large me-1"></i>Сетка
                </button>
                <button class="btn btn-sm" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 8px;">
                    <i class="fas fa-list me-1"></i>Список
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        {% if tasks is not empty %}
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                        </th>
                        <th>Название</th>
                        <th>Категория</th>
                        <th>Приоритет</th>
                        <th>Статус</th>
                        <th>Дата создания</th>
                        <th style="width: 100px;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr style="cursor: pointer;" onclick="window.location='{{ path('app_task_show', {'id': task.id}) }}'">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background: {{ task.priority == 'high' ? 'var(--color-bonuses)' : (task.priority == 'medium' ? 'var(--color-orders)' : 'var(--color-sales)') }};"></div>
                                <div>
                                    <div style="font-weight: 500;">{{ task.title }}</div>
                                    {% if task.description %}
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                            {{ task.description|slice(0, 60) }}{% if task.description|length > 60 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if task.category %}
                                <span style="padding: 6px 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;">
                                    {{ task.category.name }}
                                </span>
                            {% else %}
                                <span style="color: var(--text-secondary);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.priority == 'high' %}
                                <span class="status-badge" style="background: rgba(255, 107, 203, 0.2); color: var(--color-bonuses);">
                                    <i class="fas fa-arrow-up me-1"></i>Высокий
                                </span>
                            {% elseif task.priority == 'medium' %}
                                <span class="status-badge" style="background: rgba(255, 217, 61, 0.2); color: var(--color-orders);">
                                    <i class="fas fa-minus me-1"></i>Средний
                                </span>
                            {% else %}
                                <span class="status-badge" style="background: rgba(77, 212, 172, 0.2); color: var(--color-sales);">
                                    <i class="fas fa-arrow-down me-1"></i>Низкий
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.status == 'completed' %}
                                <span class="status-badge success">
                                    <i class="fas fa-check me-1"></i>Завершено
                                </span>
                            {% elseif task.status == 'in_progress' %}
                                <span class="status-badge warning">
                                    <i class="fas fa-spinner me-1"></i>В процессе
                                </span>
                            {% else %}
                                <span class="status-badge danger">
                                    <i class="fas fa-clock me-1"></i>В ожидании
                                </span>
                            {% endif %}
                        </td>
                        <td style="color: var(--text-secondary);">
                            {{ task.createdAt|date('d.m.Y') }}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div style="display: flex; gap: 8px;">
                                <a href="{{ path('app_task_edit', {'id': task.id}) }}" 
                                   class="btn btn-sm" 
                                   style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 6px 12px; border-radius: 6px;"
                                   title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="post" action="{{ path('app_task_delete', {'id': task.id}) }}" style="display: inline;" onsubmit="return confirm('Удалить задачу?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ task.id) }}">
                                    <button type="submit" 
                                            class="btn btn-sm" 
                                            style="background: rgba(255, 107, 203, 0.1); border: 1px solid var(--color-bonuses); color: var(--color-bonuses); padding: 6px 12px; border-radius: 6px;"
                                            title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <i class="fas fa-tasks" style="font-size: 64px; color: var(--text-secondary); opacity: 0.3; margin-bottom: 20px;"></i>
                <h5 style="color: var(--text-secondary); margin-bottom: 10px;">Нет задач</h5>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Создайте свою первую задачу</p>
                <a href="{{ path('app_task_new') }}" class="btn" style="background: var(--color-sales); border: none; color: #000; padding: 12px 24px; border-radius: 10px; font-weight: 600;">
                    <i class="fas fa-plus me-2"></i>Создать задачу
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
