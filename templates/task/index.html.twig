{% extends 'base_sidebar.html.twig' %}

{% block page_title %}Задачи{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/pages/tasks-enhanced.css') }}">
{% endblock %}

{% block body %}
<div class="animate-fade-in">
<!-- Page Header -->
<div class="stagger-item page-header-section">
    <div>
        <h2 class="page-header-title">Задачи</h2>
        <p class="page-header-subtitle">Управление заказами и сделками</p>
    </div>
    <a href="{{ path('app_task_new') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Создать задачу
    </a>
</div>

<!-- Stats Overview -->
<div class="stats-grid stagger-item delay-100">
    <div class="stat-card hover-lift">
        <div class="stat-header">
            <div class="stat-icon stat-icon-primary">
                <i class="fas fa-tasks"></i>
            </div>
            <span>Всего</span>
        </div>
        <div class="stat-value">{{ tasks|length }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-icon-warning">
                <i class="fas fa-clock"></i>
            </div>
            <span>В ожидании</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'pending')|length }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-icon-info">
                <i class="fas fa-spinner"></i>
            </div>
            <span>В процессе</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'in_progress')|length }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon stat-icon-success">
                <i class="fas fa-check"></i>
            </div>
            <span>Завершено</span>
        </div>
        <div class="stat-value">{{ tasks|filter(t => t.status == 'completed')|length }}</div>
    </div>
</div>

<!-- Filters -->
<div class="card filter-card stagger-item delay-200">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" 
                       class="form-control form-control-enhanced" 
                       name="search" 
                       value="{{ app.request.query.get('search') }}" 
                       placeholder="Поиск по названию...">
            </div>
            
            <div class="col-md-2">
                <select class="form-select form-select-enhanced" name="status">
                    <option value="">Все статусы</option>
                    <option value="pending" {{ app.request.query.get('status') == 'pending' ? 'selected' : '' }}>В ожидании</option>
                    <option value="in_progress" {{ app.request.query.get('status') == 'in_progress' ? 'selected' : '' }}>В процессе</option>
                    <option value="completed" {{ app.request.query.get('status') == 'completed' ? 'selected' : '' }}>Завершено</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <select class="form-select form-select-enhanced" name="priority">
                    <option value="">Все приоритеты</option>
                    <option value="low" {{ app.request.query.get('priority') == 'low' ? 'selected' : '' }}>Низкий</option>
                    <option value="medium" {{ app.request.query.get('priority') == 'medium' ? 'selected' : '' }}>Средний</option>
                    <option value="high" {{ app.request.query.get('priority') == 'high' ? 'selected' : '' }}>Высокий</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i>Применить
                </button>
            </div>
            
            <div class="col-md-2">
                <a href="{{ path('app_task_index') }}" class="btn btn-secondary w-100">
                    <i class="fas fa-times me-1"></i>Сбросить
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tasks List -->
<div class="card stagger-item delay-300 card-animated">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title">Список задач</h3>
            <div class="view-toggle">
                <button class="btn-view active">
                    <i class="fas fa-th-large me-1"></i>Сетка
                </button>
                <button class="btn-view">
                    <i class="fas fa-list me-1"></i>Список
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-container" id="tasksContainer">
        {# Skeleton loader (показывается при загрузке) #}
        <div id="tasksLoader" class="skeleton-task-list" style="display: none;">
            {% for i in 1..5 %}
            <div class="skeleton-task-item">
                <div class="skeleton skeleton-task-checkbox"></div>
                <div class="skeleton-task-content">
                    <div class="skeleton skeleton-text long"></div>
                    <div class="skeleton skeleton-text medium"></div>
                    <div class="skeleton-task-meta">
                        <div class="skeleton skeleton-text short" style="width: 80px;"></div>
                        <div class="skeleton skeleton-text short" style="width: 100px;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {# Actual content #}
        <div id="tasksContent">
        {% if tasks is not empty %}
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" class="form-check-input">
                        </th>
                        <th>Название</th>
                        <th>Категория</th>
                        <th>Приоритет</th>
                        <th>Статус</th>
                        <th style="width: 110px;">Прогресс</th>
                        <th>Дата создания</th>
                        <th style="width: 100px;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="hover-lift transition-fast" style="cursor: pointer;" onclick="window.location='{{ path('app_task_show', {'id': task.id}) }}'">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" class="form-check-input">
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="priority-indicator priority-{{ task.priority }}"></div>
                                <div>
                                    <div class="fw-medium">{{ task.title }}</div>
                                    {% if task.description %}
                                        <div class="text-secondary small mt-1">
                                            {{ task.description|slice(0, 60) }}{% if task.description|length > 60 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if task.category %}
                                <span class="category-badge">{{ task.category.name }}</span>
                            {% else %}
                                <span class="text-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.priority == 'high' %}
                                <span class="status-badge danger">
                                    <i class="fas fa-arrow-up"></i>Высокий
                                </span>
                            {% elseif task.priority == 'medium' %}
                                <span class="status-badge warning">
                                    <i class="fas fa-minus"></i>Средний
                                </span>
                            {% else %}
                                <span class="status-badge success">
                                    <i class="fas fa-arrow-down"></i>Низкий
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.status == 'completed' %}
                                <span class="status-badge success">
                                    <i class="fas fa-check"></i>Завершено
                                </span>
                            {% elseif task.status == 'in_progress' %}
                                <span class="status-badge warning">
                                    <i class="fas fa-spinner"></i>В процессе
                                </span>
                            {% else %}
                                <span class="status-badge danger">
                                    <i class="fas fa-clock"></i>В ожидании
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar-track">
                                    <div class="progress-bar-fill {% if task.progress == 100 %}high{% elseif task.progress >= 50 %}medium{% else %}low{% endif %}" 
                                         style="width: {{ task.progress }}%;"></div>
                                </div>
                                <span class="progress-bar-text">{{ task.progress }}%</span>
                            </div>
                        </td>
                        <td class="text-secondary">
                            {{ task.createdAt|date('d.m.Y') }}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="action-buttons">
                                <a href="{{ path('app_task_edit', {'id': task.id}) }}" 
                                   class="btn-action" 
                                   title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="post" action="{{ path('app_task_delete', {'id': task.id}) }}" style="display: inline;" onsubmit="return confirm('Удалить задачу?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ task.id) }}">
                                    <button type="submit" 
                                            class="btn-action btn-action-danger" 
                                            title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <h5>Нет задач</h5>
                <p>Создайте свою первую задачу</p>
                <a href="{{ path('app_task_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Создать задачу
                </a>
            </div>
        {% endif %}
        </div>
    </div>
</div>
</div>

{# JavaScript для демонстрации skeleton loader #}
<script>
// Пример использования skeleton loader при AJAX загрузке
function loadTasksWithSkeleton() {
    const loader = document.getElementById('tasksLoader');
    const content = document.getElementById('tasksContent');
    
    // Показываем skeleton
    loader.style.display = 'flex';
    content.style.display = 'none';
    
    // Имитация загрузки (в реальном приложении здесь будет fetch)
    setTimeout(() => {
        loader.style.display = 'none';
        content.style.display = 'block';
        content.classList.add('skeleton-loaded');
    }, 1000);
}

// Можно вызвать при фильтрации или обновлении списка
// loadTasksWithSkeleton();
</script>
{% endblock %}
