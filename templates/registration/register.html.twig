{% extends 'auth_base.html.twig' %}

{# ~ Заголовок страницы ~ #}
{% block title %}Регистрация{% endblock %}

{# ~ Page-specific CSS ~ #}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/pages/auth-enhanced.css') }}">
{% endblock %}

{# ~ Контент ~ #}
{% block body %}
<div class="register-container">

    {# ~ Шапка формы ~ #}
    <div class="register-header">
        <div class="register-icon" aria-hidden="true">
            <i class="fas fa-user-plus"></i>
        </div>
        <h2>Создать аккаунт</h2>
        <p>CRM система: Анализ продаж</p>
    </div>

    <div class="register-body">

        {# ~ Ошибки формы ~ #}
        {% if registration_form.vars.errors|length > 0 %}
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>
                {{ form_errors(registration_form) }}
            </div>
        {% endif %}

        {% for flash_error in app.flashes('verify_email_error') %}
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>
                {{ flash_error }}
            </div>
        {% endfor %}

        {# ~ Форма ~ #}
        {{ form_start(registration_form, { attr: { novalidate: 'novalidate', id: 'registration-form' } }) }}

            {# Имя + Фамилия #}
            <div class="row">
                <div class="col-half">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user" aria-hidden="true"></i> Имя
                        </label>
                        {{ form_widget(registration_form.firstName, { attr: { class: 'form-control', placeholder: 'Иван' } }) }}
                        {{ form_errors(registration_form.firstName) }}
                    </div>
                </div>
                <div class="col-half">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user" aria-hidden="true"></i> Фамилия
                        </label>
                        {{ form_widget(registration_form.lastName, { attr: { class: 'form-control', placeholder: 'Иванов' } }) }}
                        {{ form_errors(registration_form.lastName) }}
                    </div>
                </div>
            </div>

            {# Логин #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-id-badge" aria-hidden="true"></i> Логин
                </label>
                {{ form_widget(registration_form.username, { attr: { class: 'form-control', placeholder: 'ivanov', autocomplete: 'username' } }) }}
                {{ form_errors(registration_form.username) }}
            </div>

            {# Email #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-envelope" aria-hidden="true"></i> Email
                </label>
                {{ form_widget(registration_form.email, { attr: { class: 'form-control', placeholder: 'ivanov@company.ru', type: 'email', autocomplete: 'email' } }) }}
                {{ form_errors(registration_form.email) }}
            </div>

            {# Пароль #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-lock" aria-hidden="true"></i> Пароль
                </label>
                <div class="password-wrapper">
                    {{ form_widget(registration_form.plainPassword.first, { attr: { class: 'form-control', placeholder: 'Минимум 8 символов', id: 'password-first', autocomplete: 'new-password' } }) }}
                    <button type="button" class="password-toggle" data-target="password-first" aria-label="Показать пароль">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="password-strength-container">
                    <div class="password-strength-bar" id="password-strength-bar"></div>
                </div>
                <small class="password-strength-text" id="password-strength-text"></small>
                {{ form_errors(registration_form.plainPassword.first) }}
            </div>

            {# Подтверждение пароля #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-lock" aria-hidden="true"></i> Подтверждение пароля
                </label>
                <div class="password-wrapper">
                    {{ form_widget(registration_form.plainPassword.second, { attr: { class: 'form-control', placeholder: 'Повторите пароль', id: 'password-second', autocomplete: 'new-password' } }) }}
                    <button type="button" class="password-toggle" data-target="password-second" aria-label="Показать пароль">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
                {{ form_errors(registration_form.plainPassword.second) }}
            </div>

            {# Телефон #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-phone" aria-hidden="true"></i> Телефон
                </label>
                {{ form_widget(registration_form.phone, { attr: { class: 'form-control', placeholder: '+7 (999) 123-45-67', type: 'tel', autocomplete: 'tel' } }) }}
                {{ form_errors(registration_form.phone) }}
            </div>

            {# Должность + Отдел #}
            <div class="row">
                <div class="col-half">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-briefcase" aria-hidden="true"></i> Должность
                        </label>
                        {{ form_widget(registration_form.position, { attr: { class: 'form-control', placeholder: 'Менеджер' } }) }}
                        {{ form_errors(registration_form.position) }}
                    </div>
                </div>
                <div class="col-half">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-building" aria-hidden="true"></i> Отдел
                        </label>
                        {{ form_widget(registration_form.department, { attr: { class: 'form-control', placeholder: 'Продажи' } }) }}
                        {{ form_errors(registration_form.department) }}
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-register">
                <i class="fas fa-user-plus me-2" aria-hidden="true"></i>
                <span>Зарегистрироваться</span>
            </button>

        {{ form_end(registration_form) }}

        {# ~ Ссылка на логин ~ #}
        <div class="register-footer">
            <p>Уже есть аккаунт?</p>
            <a href="{{ path('app_login') }}">
                <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                Войти в систему
            </a>
        </div>

    </div>
</div>
{% endblock %}

{# ~ JS ~ #}
{% block javascripts %}
    {{ parent() }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ~ Переключатель видимости пароля ~
        document.querySelectorAll('.password-toggle').forEach(btn => {
            btn.addEventListener('click', function () {
                const input = document.getElementById(this.dataset.target);
                if (!input) return;

                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';

                const icon = this.querySelector('i');
                icon?.classList.toggle('fa-eye',       !isPassword);
                icon?.classList.toggle('fa-eye-slash',  isPassword);
                this.setAttribute('aria-label', isPassword ? 'Скрыть пароль' : 'Показать пароль');
            });
            
            // Keyboard support
            btn.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

        // ~ Индикатор силы пароля ~
        const passwordInput = document.getElementById('password-first');
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        if (passwordInput && strengthBar && strengthText) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let strengthLabel = '';
                
                if (password.length === 0) {
                    strengthBar.style.width = '0%';
                    strengthText.textContent = '';
                    return;
                }
                
                // Критерии силы пароля
                if (password.length >= 8) strength += 25;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 25;
                if (password.match(/[0-9]/)) strength += 25;
                if (password.match(/[^a-zA-Z0-9]/)) strength += 25;
                
                strengthBar.style.width = strength + '%';
                
                // Цвет и текст в зависимости от силы
                if (strength <= 25) {
                    strengthBar.style.backgroundColor = '#dc3545';
                    strengthLabel = 'Слабый пароль';
                    strengthText.style.color = '#dc3545';
                } else if (strength <= 50) {
                    strengthBar.style.backgroundColor = '#ffc107';
                    strengthLabel = 'Средний пароль';
                    strengthText.style.color = '#ffc107';
                } else if (strength <= 75) {
                    strengthBar.style.backgroundColor = '#17a2b8';
                    strengthLabel = 'Хороший пароль';
                    strengthText.style.color = '#17a2b8';
                } else {
                    strengthBar.style.backgroundColor = '#28a745';
                    strengthLabel = 'Отличный пароль';
                    strengthText.style.color = '#28a745';
                }
                
                strengthText.textContent = strengthLabel;
            });
        }

        // ~ Валидация email в реальном времени ~
        const emailInput = document.querySelector('input[type="email"]');
        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (this.value && !emailRegex.test(this.value)) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (this.value) {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                }
            });
            
            emailInput.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (emailRegex.test(this.value)) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                }
            });
        }

        // ~ Валидация совпадения паролей ~
        const p1 = document.getElementById('password-first');
        const p2 = document.getElementById('password-second');
        if (p1 && p2) {
            const validate = () => {
                if (p2.value) {
                    if (p1.value !== p2.value) {
                        p2.classList.add('is-invalid');
                        p2.classList.remove('is-valid');
                    } else {
                        p2.classList.add('is-valid');
                        p2.classList.remove('is-invalid');
                    }
                }
            };
            p1.addEventListener('input', validate);
            p2.addEventListener('input', validate);
        }

        // ~ Валидация обязательных полей ~
        document.querySelectorAll('.form-control[required]').forEach(input => {
            input.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (this.checkValidity()) {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                }
            });
            
            input.addEventListener('input', function() {
                if (this.classList.contains('is-invalid') && this.value.trim()) {
                    this.classList.remove('is-invalid');
                    if (this.checkValidity()) {
                        this.classList.add('is-valid');
                    }
                }
            });
        });

        // ~ Лоадер на отправку формы ~
        document.getElementById('registration-form')?.addEventListener('submit', function (e) {
            const btn  = this.querySelector('button[type="submit"]');
            const icon = btn?.querySelector('i');
            if (!btn) return;

            // Проверяем валидность формы
            const invalidInputs = this.querySelectorAll('.form-control.is-invalid');
            if (invalidInputs.length > 0) {
                e.preventDefault();
                invalidInputs[0].focus();
                return;
            }

            btn.disabled     = true;
            btn.style.opacity = '0.7';
            if (icon) icon.className = 'fas fa-spinner fa-spin me-2';
        });

        // ~ Автофокус на первое поле ~
        const firstInput = document.querySelector('.form-control');
        if (firstInput && !firstInput.value) {
            setTimeout(() => firstInput.focus(), 100);
        }

    });
    </script>
{% endblock %}
