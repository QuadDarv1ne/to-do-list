<!DOCTYPE html>
<html lang="{% block lang %}ru{% endblock %}" data-theme="light" data-mode="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    {# ~ SEO & Social ~ #}
    <title>{% block title %}CRM система: Анализ продаж{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}CRM система для анализа продаж{% endblock %}">
    <meta name="robots"      content="{% block meta_robots %}noindex, nofollow{% endblock %}">

    {# Open Graph #}
    <meta property="og:title"       content="{% block og_title %}CRM: Анализ продаж{% endblock %}">
    <meta property="og:description" content="{% block og_description %}CRM система для анализа продаж{% endblock %}">
    <meta property="og:type"        content="website">
    <meta property="og:locale"      content="ru_RU">

    {# ~ Favicon ~ #}
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
    <link rel="alternate icon" type="image/png" href="/favicon.png">

    {# ~ Mobile / PWA ~ #}
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" id="meta-theme-color" content="#ffffff">

    {# ~ Security ~ #}
    {#
        Рекомендуется выносить CSP в HTTP-заголовок (nginx/apache).
        Настройте значения под ваш проект.
    #}
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src  'self' https://cdn.jsdelivr.net 'nonce-{{ csp_nonce('script') }}';
                   style-src   'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'unsafe-inline';
                   font-src    'self' https://cdnjs.cloudflare.com;
                   img-src     'self' data:;
                   connect-src 'self';">

    {# ~ Preconnect ~ #}
    <link rel="preconnect" href="https://cdn.jsdelivr.net"     crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

    {# ~ Bootstrap 5.3 ~ #}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
          crossorigin="anonymous">

    {# ~ Font Awesome 6 ~ #}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qp+7/sKg=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer">

    {# ~ Topbar Layout ~ #}
    <link rel="stylesheet" href="{{ asset('css/themes/topbar-layout.css') }}">

    {# ~ Cursor Effect ~ #}
    <link rel="stylesheet" href="{{ asset('css/components/cursor-effect.css') }}">

    {# ~ Тема подключается динамически через theme-manager-enhanced.js ~ #}

    {# ~ Стили дочерних шаблонов ~ #}
    {% block stylesheets %}{% endblock %}

    {# ~ Дополнительный контент в <head> ~ #}
    {% block head_extra %}{% endblock %}

    {# ~ Inline script для загрузки темы ~ #}
    <script nonce="{{ csp_nonce('script') }}">
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            const mode = localStorage.getItem('mode') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-mode', mode);
            
            // Загружаем CSS темы
            const themeLink = document.createElement('link');
            themeLink.rel = 'stylesheet';
            themeLink.href = '/css/themes/topbar-theme-' + theme + '.css';
            themeLink.setAttribute('data-theme-css', 'true');
            document.head.appendChild(themeLink);
        })();
    </script>
</head>

<body class="{% block body_class %}{% endblock %}">

    {# ~ Навигация ~ #}
    {% block navbar %}
        {% include 'partials/_navbar.html.twig' ignore missing %}
    {% endblock %}

    {# ~ Основной контент ~ #}
    <main id="main-content" role="main" tabindex="-1">

        {# ~ Flash-сообщения ~ #}
        {% block flash_messages %}
            {% for type, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show m-2" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                    </div>
                {% endfor %}
            {% endfor %}
        {% endblock %}

        {% block body %}{% endblock %}
    </main>

    {# ~ Футер ~ #}
    {% block footer %}
        {% include 'partials/_footer.html.twig' ignore missing %}
    {% endblock %}

    {# ~ FAB кнопка смены темы ~ #}
    <div class="theme-fab" data-theme-toggle title="Сменить тему">
        <i class="fas fa-palette"></i>
    </div>

    {# ~ No-Script ~ #}
    <noscript>
        <div class="alert alert-warning text-center m-0 rounded-0" role="alert">
            Для корректной работы приложения необходимо включить JavaScript.
        </div>
    </noscript>

    {# ~ Bootstrap JS ~ #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"
            defer></script>

    {# ~ Theme Manager (light / dark / orange / purple / custom) ~ #}
    <script src="{{ asset('js/core/theme-manager-enhanced.js') }}" defer></script>

    {# ~ Cursor Effect ~ #}
    <script src="{{ asset('js/components/cursor-effect.js') }}" defer></script>

    {# ~ Скрипты дочерних шаблонов ~ #}
    {% block javascripts %}{% endblock %}

    {# ~ Inline styles для FAB кнопки ~ #}
    <style nonce="{{ csp_nonce('script') }}">
        .theme-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--color-primary, #667eea) 0%, var(--color-secondary, #764ba2) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            color: white;
            font-size: 1.5rem;
        }

        .theme-fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        }

        .theme-fab:active {
            transform: translateY(-2px) scale(0.98);
        }

        .theme-fab i {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            .theme-fab {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
                font-size: 1.25rem;
            }
        }

        /* Анимация появления */
        @keyframes fabSlideIn {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .theme-fab {
            animation: fabSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s backwards;
        }
    </style>

</body>
</html>