{% extends 'base_sidebar.html.twig' %}

{% block page_title %}Аналитика продаж{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/advanced-animations.css') }}">
    <style>
        .analytics-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .analytics-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .analytics-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .analytics-subtitle {
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }
        
        .period-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .period-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .period-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-light);
        }
        
        .period-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--metric-color, var(--primary-color));
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover::before {
            transform: scaleY(1);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--metric-bg, rgba(99, 102, 241, 0.1));
            color: var(--metric-color, var(--primary-color));
        }
        
        .metric-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }
        
        .metric-trend.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .metric-trend.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .metric-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .metric-progress {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .metric-progress-bar {
            height: 100%;
            background: var(--metric-color, var(--primary-color));
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .chart-card.col-8 {
            grid-column: span 8;
        }
        
        .chart-card.col-4 {
            grid-column: span 4;
        }
        
        .chart-card.col-12 {
            grid-column: span 12;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .chart-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chart-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .insight-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .insight-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(4px);
        }
        
        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .insight-content {
            flex: 1;
        }
        
        .insight-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .insight-description {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        
        .comparison-table td {
            color: var(--text-light);
        }
        
        .comparison-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .comparison-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .comparison-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .comparison-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        @media (max-width: 1024px) {
            .chart-card.col-8,
            .chart-card.col-4 {
                grid-column: span 12;
            }
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .period-selector {
                flex-wrap: wrap;
            }
            
            .analytics-title {
                font-size: 1.5rem;
            }
        }
    </style>
{% endblock %}

{% block body %}
<div class="animate-fade-in">
    <!-- Analytics Header -->
    <div class="analytics-header stagger-item">
        <div class="analytics-title">
            <i class="fas fa-chart-line me-2"></i>
            Аналитика продаж
        </div>
        <div class="analytics-subtitle">
            Комплексный анализ эффективности и производительности
        </div>
    </div>

    <!-- Period Selector -->
    <div class="period-selector stagger-item delay-100">
        <button class="period-btn" data-period="today">Сегодня</button>
        <button class="period-btn" data-period="week">Неделя</button>
        <button class="period-btn active" data-period="month">Месяц</button>
        <button class="period-btn" data-period="quarter">Квартал</button>
        <button class="period-btn" data-period="year">Год</button>
        <button class="period-btn" data-period="custom">
            <i class="fas fa-calendar-alt me-1"></i>
            Период
        </button>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card stagger-item delay-200 hover-lift" style="--metric-color: #10b981; --metric-bg: rgba(16, 185, 129, 0.1);">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+15.3%</span>
                </div>
            </div>
            <div class="metric-value">₽ 2,450,000</div>
            <div class="metric-label">Общая выручка</div>
            <div class="metric-progress">
                <div class="metric-progress-bar progress-animated" style="width: 85%; background: #10b981;"></div>
            </div>
        </div>

        <div class="metric-card stagger-item delay-250 hover-lift" style="--metric-color: #6366f1; --metric-bg: rgba(99, 102, 241, 0.1);">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8.7%</span>
                </div>
            </div>
            <div class="metric-value">{{ analytics.total_tasks|default(342) }}</div>
            <div class="metric-label">Всего заказов</div>
            <div class="metric-progress">
                <div class="metric-progress-bar progress-animated" style="width: 72%; background: #6366f1;"></div>
            </div>
        </div>

        <div class="metric-card stagger-item delay-300 hover-lift" style="--metric-color: #f59e0b; --metric-bg: rgba(245, 158, 11, 0.1);">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12.1%</span>
                </div>
            </div>
            <div class="metric-value">₽ 7,164</div>
            <div class="metric-label">Средний чек</div>
            <div class="metric-progress">
                <div class="metric-progress-bar progress-animated" style="width: 68%; background: #f59e0b;"></div>
            </div>
        </div>

        <div class="metric-card stagger-item delay-350 hover-lift" style="--metric-color: #8b5cf6; --metric-bg: rgba(139, 92, 246, 0.1);">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+23.5%</span>
                </div>
            </div>
            <div class="metric-value">1,248</div>
            <div class="metric-label">Новых клиентов</div>
            <div class="metric-progress">
                <div class="metric-progress-bar progress-animated" style="width: 92%; background: #8b5cf6;"></div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Sales Trend Chart -->
        <div class="chart-card col-8 stagger-item delay-400 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-area"></i>
                    Динамика продаж
                </h3>
                <div class="chart-actions">
                    <button class="chart-btn" title="Обновить">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="chart-btn" title="Экспорт">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="chart-btn" title="Настройки">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <canvas id="salesTrendChart" height="80"></canvas>
        </div>

        <!-- Top Products -->
        <div class="chart-card col-4 stagger-item delay-450 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-star"></i>
                    Топ продукты
                </h3>
            </div>
            <canvas id="topProductsChart" height="200"></canvas>
        </div>

        <!-- Sales by Category -->
        <div class="chart-card col-6 stagger-item delay-500 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-layer-group"></i>
                    Продажи по категориям
                </h3>
            </div>
            <canvas id="categoryChart" height="100"></canvas>
        </div>

        <!-- Key Insights -->
        <div class="chart-card col-6 stagger-item delay-550 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-lightbulb"></i>
                    Ключевые инсайты
                </h3>
            </div>
            <div class="insights-list">
                <div class="insight-item animate-fade-in-left">
                    <div class="insight-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Рост продаж</div>
                        <div class="insight-description">Продажи выросли на 15.3% по сравнению с прошлым месяцем</div>
                    </div>
                </div>
                <div class="insight-item animate-fade-in-left delay-100">
                    <div class="insight-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Лучший день</div>
                        <div class="insight-description">Максимальная выручка 15 февраля - ₽ 125,000</div>
                    </div>
                </div>
                <div class="insight-item animate-fade-in-left delay-200">
                    <div class="insight-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Популярная категория</div>
                        <div class="insight-description">Молочная продукция - 42% от общих продаж</div>
                    </div>
                </div>
                <div class="insight-item animate-fade-in-left delay-300">
                    <div class="insight-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Пиковое время</div>
                        <div class="insight-description">Больше всего заказов с 10:00 до 14:00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Period Comparison -->
        <div class="chart-card col-12 stagger-item delay-600 card-animated">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-balance-scale"></i>
                    Сравнение периодов
                </h3>
                <div class="chart-actions">
                    <button class="chart-btn" title="Экспорт">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </div>
            </div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Показатель</th>
                        <th>Текущий период</th>
                        <th>Предыдущий период</th>
                        <th>Изменение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Выручка</td>
                        <td><span class="comparison-value">₽ 2,450,000</span></td>
                        <td><span class="comparison-value">₽ 2,125,000</span></td>
                        <td>
                            <span class="comparison-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +15.3%
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>Количество заказов</td>
                        <td><span class="comparison-value">342</span></td>
                        <td><span class="comparison-value">315</span></td>
                        <td>
                            <span class="comparison-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +8.6%
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>Средний чек</td>
                        <td><span class="comparison-value">₽ 7,164</span></td>
                        <td><span class="comparison-value">₽ 6,746</span></td>
                        <td>
                            <span class="comparison-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +6.2%
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>Новые клиенты</td>
                        <td><span class="comparison-value">1,248</span></td>
                        <td><span class="comparison-value">1,011</span></td>
                        <td>
                            <span class="comparison-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +23.4%
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>Конверсия</td>
                        <td><span class="comparison-value">3.8%</span></td>
                        <td><span class="comparison-value">3.2%</span></td>
                        <td>
                            <span class="comparison-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +18.8%
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Period selector
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // Здесь можно добавить загрузку данных для выбранного периода
    });
});

// Sales Trend Chart
const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
new Chart(salesTrendCtx, {
    type: 'line',
    data: {
        labels: ['1 фев', '5 фев', '10 фев', '15 фев', '20 фев', '25 фев', '28 фев'],
        datasets: [{
            label: 'Выручка (₽)',
            data: [85000, 92000, 88000, 125000, 110000, 115000, 120000],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: 'var(--text-muted)' }
            },
            x: {
                grid: { display: false },
                ticks: { color: 'var(--text-muted)' }
            }
        }
    }
});

// Top Products Chart
const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
new Chart(topProductsCtx, {
    type: 'doughnut',
    data: {
        labels: ['Молоко', 'Сыр', 'Масло', 'Творог', 'Сметана'],
        datasets: [{
            data: [42, 28, 15, 10, 5],
            backgroundColor: ['#10b981', '#6366f1', '#f59e0b', '#8b5cf6', '#ef4444'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { color: 'var(--text-muted)', padding: 15 }
            }
        }
    }
});

// Category Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: ['Молочные', 'Мясные', 'Овощи', 'Фрукты', 'Зерновые'],
        datasets: [{
            label: 'Продажи (₽)',
            data: [1050000, 680000, 420000, 180000, 120000],
            backgroundColor: ['#10b981', '#6366f1', '#f59e0b', '#8b5cf6', '#ef4444'],
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: 'var(--text-muted)' }
            },
            x: {
                grid: { display: false },
                ticks: { color: 'var(--text-muted)' }
            }
        }
    }
});
</script>
{% endblock %}
