{% extends 'base.html.twig' %}

{% block title %}Аналитика{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/pages/analytics-dashboard.css') }}">
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="analytics-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-chart-line me-2"></i>
                    Аналитика и статистика
                </h1>
                <p class="mb-0 opacity-75">Детальный анализ вашей продуктивности</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ path('app_analytics_export_csv') }}" class="btn btn-light">
                    <i class="fas fa-download me-2"></i>Экспорт CSV
                </a>
                <button class="btn btn-light" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-2"></i>Обновить
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon bg-primary bg-opacity-10">
                    <i class="fas fa-tasks text-primary"></i>
                </div>
                <div class="metric-value text-primary">{{ analytics.overview.total_tasks ?? 0 }}</div>
                <div class="metric-label">Всего задач</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up me-1"></i>
                    +{{ analytics.overview.new_this_week ?? 0 }} за неделю
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon bg-success bg-opacity-10">
                    <i class="fas fa-check-circle text-success"></i>
                </div>
                <div class="metric-value text-success">{{ analytics.overview.completed_tasks ?? 0 }}</div>
                <div class="metric-label">Завершено</div>
                <div class="metric-trend">
                    <i class="fas fa-percentage me-1"></i>
                    {{ analytics.overview.completion_rate ?? 0 }}% выполнено
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon bg-info bg-opacity-10">
                    <i class="fas fa-clock text-info"></i>
                </div>
                <div class="metric-value text-info">{{ analytics.overview.avg_completion_time ?? 0 }}</div>
                <div class="metric-label">Среднее время (дни)</div>
                <div class="metric-trend">
                    <i class="fas fa-calendar me-1"></i>
                    До завершения задачи
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon bg-warning bg-opacity-10">
                    <i class="fas fa-fire text-warning"></i>
                </div>
                <div class="metric-value text-warning">{{ analytics.productivity_trends.current_streak ?? 0 }}</div>
                <div class="metric-label">Текущая серия</div>
                <div class="metric-trend">
                    <i class="fas fa-trophy me-1"></i>
                    Дней подряд
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-area me-2 text-primary"></i>
                        Динамика выполнения задач
                    </h5>
                    <div class="period-selector">
                        <button class="period-btn active" data-period="week">Неделя</button>
                        <button class="period-btn" data-period="month">Месяц</button>
                        <button class="period-btn" data-period="year">Год</button>
                    </div>
                </div>
                <canvas id="completionTrendChart" height="80"></canvas>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie me-2 text-success"></i>
                        По статусам
                    </h5>
                </div>
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Category & Priority Analysis -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-folder me-2 text-info"></i>
                        Анализ по категориям
                    </h5>
                </div>
                <canvas id="categoryChart" height="120"></canvas>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Анализ по приоритетам
                    </h5>
                </div>
                <canvas id="priorityChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analytics = {{ analytics|json_encode|raw }};
    
    // Completion Trend Chart
    const completionCtx = document.getElementById('completionTrendChart');
    if (completionCtx) {
        new Chart(completionCtx, {
            type: 'line',
            data: {
                labels: analytics.productivity_trends?.labels || [],
                datasets: [{
                    label: 'Завершено задач',
                    data: analytics.productivity_trends?.completed || [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Status Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['В ожидании', 'В процессе', 'Завершено'],
                datasets: [{
                    data: [
                        analytics.overview?.pending_tasks || 0,
                        analytics.overview?.in_progress_tasks || 0,
                        analytics.overview?.completed_tasks || 0
                    ],
                    backgroundColor: ['#ffc107', '#0dcaf0', '#198754'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx && analytics.category_analysis) {
        const categories = Object.keys(analytics.category_analysis);
        const values = Object.values(analytics.category_analysis);
        
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Задач',
                    data: values,
                    backgroundColor: '#667eea',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Priority Chart
    const priorityCtx = document.getElementById('priorityChart');
    if (priorityCtx && analytics.priority_analysis) {
        new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['Низкий', 'Средний', 'Высокий'],
                datasets: [{
                    label: 'Задач',
                    data: [
                        analytics.priority_analysis.low || 0,
                        analytics.priority_analysis.medium || 0,
                        analytics.priority_analysis.high || 0
                    ],
                    backgroundColor: ['#38ef7d', '#fdcb6e', '#f5576c'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Period selector
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // Here you would reload data for the selected period
        });
    });
});
</script>
{% endblock %}
