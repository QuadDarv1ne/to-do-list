{# templates/components/theme_switcher.html.twig #}

<div class="theme-switcher-wrapper" data-controller="theme-switcher">
    <button 
        class="theme-toggle-btn" 
        type="button"
        data-action="click->theme-switcher#toggle"
        aria-label="Переключить тему"
        title="Переключить тему (T)"
    >
        <i class="fas fa-moon theme-icon-light"></i>
        <i class="fas fa-sun theme-icon-dark"></i>
        <span class="theme-label d-none d-md-inline">Тема</span>
    </button>

    <div class="theme-dropdown">
        <div class="theme-option" data-theme-value="light" data-action="click->theme-switcher#setLight">
            <i class="fas fa-sun"></i>
            <span>Светлая</span>
            <i class="fas fa-check theme-check"></i>
        </div>
        <div class="theme-option" data-theme-value="dark" data-action="click->theme-switcher#setDark">
            <i class="fas fa-moon"></i>
            <span>Тёмная</span>
            <i class="fas fa-check theme-check"></i>
        </div>
        <div class="theme-option" data-theme-value="system" data-action="click->theme-switcher#setSystem">
            <i class="fas fa-desktop"></i>
            <span>Системная</span>
            <i class="fas fa-check theme-check"></i>
        </div>
    </div>
</div>

<style>
    .theme-switcher-wrapper {
        position: relative;
        display: inline-block;
    }

    .theme-toggle-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(102, 126, 234, 0.1);
        border: none;
        border-radius: 10px;
        color: #667eea;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .theme-toggle-btn:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
    }

    .theme-icon-dark {
        display: none;
    }

    [data-theme="dark"] .theme-icon-light {
        display: none;
    }

    [data-theme="dark"] .theme-icon-dark {
        display: inline;
    }

    .theme-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 8px;
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
    }

    [data-theme="dark"] .theme-dropdown {
        background: #1e293b;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }

    .theme-switcher-wrapper.show-dropdown .theme-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .theme-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #4a5568;
    }

    [data-theme="dark"] .theme-option {
        color: #e2e8f0;
    }

    .theme-option:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }

    .theme-option.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .theme-option i {
        font-size: 16px;
        width: 20px;
        text-align: center;
    }

    .theme-option .theme-check {
        margin-left: auto;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.2s ease;
    }

    .theme-option.active .theme-check {
        opacity: 1;
        transform: scale(1);
    }

    .theme-label {
        font-weight: 500;
        font-size: 13px;
    }
</style>

<script>
(function() {
    class ThemeSwitcher {
        constructor() {
            this.currentTheme = this.getSavedTheme();
            this.applyTheme(this.currentTheme);
            this.init();
        }

        init() {
            // Обработка кликов вне компонента
            document.addEventListener('click', (e) => {
                const wrapper = e.target.closest('.theme-switcher-wrapper');
                if (!wrapper) {
                    this.hideDropdown();
                }
            });

            // Горячая клавиша
            document.addEventListener('keydown', (e) => {
                if (e.key === 't' && !e.ctrlKey && !e.metaKey && !e.target.closest('input, textarea')) {
                    e.preventDefault();
                    this.toggle();
                }
            });

            // Отслеживание системной темы
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (this.currentTheme === 'system') {
                    this.applyTheme('system');
                }
            });
        }

        toggle() {
            const wrapper = document.querySelector('.theme-switcher-wrapper');
            wrapper.classList.toggle('show-dropdown');
        }

        hideDropdown() {
            const wrapper = document.querySelector('.theme-switcher-wrapper');
            wrapper.classList.remove('show-dropdown');
        }

        setLight(e) {
            e.stopPropagation();
            this.setTheme('light');
        }

        setDark(e) {
            e.stopPropagation();
            this.setTheme('dark');
        }

        setSystem(e) {
            e.stopPropagation();
            this.setTheme('system');
        }

        setTheme(theme) {
            this.currentTheme = theme;
            localStorage.setItem('theme', theme);
            this.applyTheme(theme);
            this.updateActiveOption();
            this.hideDropdown();

            // Анимация перехода
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
        }

        applyTheme(theme) {
            let effectiveTheme = theme;
            
            if (theme === 'system') {
                effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            document.documentElement.setAttribute('data-theme', effectiveTheme);
            
            if (effectiveTheme === 'dark') {
                document.body.style.backgroundColor = '#0f172a';
                document.body.style.color = '#e2e8f0';
            } else {
                document.body.style.backgroundColor = '#f5f6fa';
                document.body.style.color = '#333';
            }

            this.updateActiveOption();
        }

        getSavedTheme() {
            return localStorage.getItem('theme') || 'system';
        }

        updateActiveOption() {
            document.querySelectorAll('.theme-option').forEach(option => {
                const optionTheme = option.getAttribute('data-theme-value');
                const isActive = optionTheme === this.currentTheme;
                
                option.classList.toggle('active', isActive);
            });
        }
    }

    // Инициализация после загрузки DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new ThemeSwitcher());
    } else {
        new ThemeSwitcher();
    }
})();
</script>
